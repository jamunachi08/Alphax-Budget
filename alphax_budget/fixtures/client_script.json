[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Control",
  "enabled": 0,
  "modified": "2025-07-27 00:15:29.402529",
  "module": "AlphaX Budget",
  "name": "Budget Control",
  "script": "frappe.ui.form.on('Budget Control', {\n    on_submit: function(frm) {\n        let year = frm.doc.fiscal_year;\n        let dep = frm.doc.departments_list;\n        \n        if (frm.doc.budget_controller === 'Financial') {\n            dep.forEach(function(row) {\n                let budget = frappe.model.get_new_doc(\"Budget Request\");\n                budget.department = row.departments; // Assuming 'department' is the field name in the child table\n                budget.fiscal_year = year;\n                budget.custom_budget_controller = frm.doc.budget_controller;\n                frappe.db.insert(budget)\n                    .then(function() {\n                        frappe.msgprint(\"Budget Requests Have Been Created For Each Department\");\n                        frappe.model.set_value(\"Budget Request\", budget.name, \"workflow_state\", \"تحت مراجعة قسم المالية\"); // Set the workflow state here\n\n                    })\n                    .catch(function(err) {\n                        console.log(\"Error creating budget request: \", err);\n                    });\n            });\n        } else {\n            console.log(\"Done\");\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Control",
  "enabled": 0,
  "modified": "2025-07-27 00:15:17.886875",
  "module": "AlphaX Budget",
  "name": "Budget control 23-02",
  "script": "frappe.ui.form.on('Budget Control', {\n    on_submit: function(frm) {\n        let year = frm.doc.fiscal_year;\n        let dep = frm.doc.departments_list;\n        \n        if (frm.doc.budget_controller === 'Financial') {\n            dep.forEach(function(row) {\n                let budget = frappe.model.get_new_doc(\"Budget Request\");\n                budget.department = row.departments; // Assuming 'department' is the field name in the child table\n                budget.fiscal_year = year;\n                budget.custom_budget_controller = frm.doc.budget_controller;\n                frappe.db.insert(budget)\n                    .then(function() {\n                        frappe.msgprint(\"Budget Requests Have Been Created For Each Department\");\n                        frappe.model.set_value(\"Budget Request\", budget.name, \"workflow_state\", \"تحت مراجعة قسم المالية\"); // Set the workflow state here\n\n                    })\n                    .catch(function(err) {\n                        console.log(\"Error creating budget request: \", err);\n                    });\n            });\n        } else {\n            console.log(\"Done\");\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 0,
  "modified": "2025-08-25 18:53:02.615538",
  "module": "AlphaX Budget",
  "name": "fetch department",
  "script": "frappe.ui.form.on('Budget Request', {\r\n    onload: function (frm) {\r\n        // Check if the document is new\r\n        if (frm.is_new()) {\r\n            // Get the current user's employee record\r\n            frappe.call({\r\n                method: 'frappe.client.get_list',\r\n                args: {\r\n                    doctype: 'Employee',\r\n                    filters: { user_id: frappe.session.user },\r\n                    fields: ['department']\r\n                },\r\n                callback: function (response) {\r\n                    if (response.message && response.message.length > 0) {\r\n                        let department = response.message[0].department;\r\n                        // Set the department field in the Budget Request form\r\n                        frm.set_value('department', department);\r\n                    } else {\r\n                        frappe.msgprint(__('You are not an employee or no department found.'));\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 0,
  "modified": "2025-08-13 19:49:13.168564",
  "module": "AlphaX Budget",
  "name": "dialog  popup insert in child table",
  "script": "frappe.ui.form.on('Budget Items Details', {\n//     insert_item_quantity: function(frm, cdt, cdn) {\n//         var d = locals[cdt][cdn];\n\n//         // Initialize dialog instance\n//         var dialog = new frappe.ui.Dialog({\n//             title: __('Enter Monthly Budget Quantities'),\n//             fields: [\n//                 {\n//                     \"fieldname\": \"january\",\n//                     \"fieldtype\": 'Float',\n//                     \"label\": __(\"January\"),\n//                 },\n//                     {\n//                     fieldname: \"july\",\n//                     fieldtype: \"Float\",\n//                     label: __(\"July\"),\n//                 },\n             \n                            \n//                 {\n//                     \"fieldname\": \"column_break\",\n//                     \"fieldtype\": 'Column Break',\n//                     \"label\": __(\"\"),\n//                 },\n             \n//                 {\n//                     fieldname: \"february\",\n//                     fieldtype: \"Float\",\n//                     label: __(\"February\"),\n//                 },\n//                   {\n//                     fieldname: \"august\",\n//                     fieldtype: \"Float\",\n//                     label: __(\"August\"),\n//                 },\n             \n//                 {\n//                     \"fieldname\": \"column_break\",\n//                     \"fieldtype\": 'Column Break',\n//                     \"label\": __(\"\"),\n//                 },\n//                 {\n//                     fieldname: \"march\",\n//                     fieldtype: \"Float\",\n//                     label: __(\"March\"),\n//                 },\n                \n//                 {\n//                     fieldname: \"september\",\n//                     fieldtype: \"Float\",\n//                     label: __(\"September\"),\n//                 },\n               \n//                 {\n//                     \"fieldname\": \"column_break\",\n//                     \"fieldtype\": 'Column Break',\n//                     \"label\": __(\"\"),\n//                 },\n//               {\n//                     fieldname: \"april\",\n//                     fieldtype: \"Float\",\n//                     label: __(\"April\"),\n//                 },\n//                 {\n//                     fieldname: \"october\",\n//                     fieldtype: \"Float\",\n//                     label: __(\"October\"),\n//                 },\n//                  {\n//                     \"fieldname\": \"column_break\",\n//                     \"fieldtype\": 'Column Break',\n//                     \"label\": __(\"\"),\n//                 },\n//                 {\n//                     fieldname: \"may\",\n//                     fieldtype: \"Float\",\n//                     label: __(\"May\"),\n//                 },\n                \n//                 {\n//                     fieldname: \"november\",\n//                     fieldtype: 'Float',\n//                     label: __(\"November\"),\n//                 },\n//                 {\n//                     \"fieldname\": \"column_break\",\n//                     \"fieldtype\": 'Column Break',\n//                     \"label\": __(\"\"),\n//                 },\n//                  {\n//                     fieldname: \"june\",\n//                     fieldtype: \"Float\",\n//                     label: __(\"June\"),\n//                 },\n//                 {\n//                     fieldname: \"december\",\n//                     fieldtype: \"Float\",\n//                     label: __(\"December\"),\n//                 }, \n              \n//             ],\n//              size: 'large', // small, large, extra-large\n//         });\n\n\n// dialog.set_values({\n//     'january': d.january || 0.00,\n//     'february': d.february || 0.00, \n//     'march': d.march || 0.00,\n//     'april': d.april || 0.00,\n//     'may': d.may || 0.00,\n//     'june': d.june ||0.00,\n//     'july': d.july || 0.00,\n//     'august': d.august ||0.00,\n//     'september': d.september ||0.00,\n//     'october': d.october || 0.00,\n//     'november': d.november || 0.00,\n//     'december': d.december || 0.00,\n// });\n\n//         // Set primary action button\n//         dialog.set_primary_action(__('Update'), function() {\n//             var fields = ['january', 'february', 'march', 'april', 'may', 'june',\n//                           'july', 'august', 'september', 'october', 'november', 'december'];\n\n//             var total_quantity = 0;\n\n//             fields.forEach(function(fieldname) {\n//                 var value = parseFloat(dialog.get_value(fieldname)) || 0;\n//                 frappe.model.set_value(cdt, cdn, fieldname, value);\n//                 total_quantity += value;\n//                 console.log('total qty',total_quantity);\n//             });            // Set the value back to the form\n//              frappe.model.set_value(cdt, cdn, 'total_quantity', total_quantity);\n//             // frappe.model.set_value(cdt, cdn, 'january', january);\n//             // frappe.model.set_value(cdt, cdn, 'february', february);\n//             // frappe.model.set_value(cdt, cdn, 'march', march);\n//             // frappe.model.set_value(cdt, cdn, 'april', april);\n//             // frappe.model.set_value(cdt, cdn, 'may', may);\n//             // frappe.model.set_value(cdt, cdn, 'june', june);\n//             // frappe.model.set_value(cdt, cdn, 'july', july);\n//             // frappe.model.set_value(cdt, cdn, 'august', august);\n//             // frappe.model.set_value(cdt, cdn, 'september', september);\n//             // frappe.model.set_value(cdt, cdn, 'october', october);\n//             // frappe.model.set_value(cdt, cdn, 'november', november);\n//             // frappe.model.set_value(cdt, cdn, 'december', december);\n//             frappe.show_alert({\n//                 message:__('Month value Have been Changed'),\n//                 indicator:'green'\n//             }, 5);\n           \n//             // Optionally, you may want to refresh the form or perform other actions here\n\n//             // Hide the dialog after processing\n//             dialog.hide();\n//         });\n\n     \n//         // Show the dialog\n//         dialog.show();\n//         //console.log('total qty',total_quantity);\n//     },\n\n    expected_price: function(frm, cdt, cdn) {\n            var d = locals[cdt][cdn];\n            var total_quantity = d.total_quantity || 0;\n            var expected_price = d.expected_price;\n    \n            if (!isNaN(expected_price) && !isNaN(total_quantity)) {\n                var total = total_quantity * expected_price;\n                frappe.model.set_value(cdt, cdn, 'total', total);\n            } else {\n                frappe.msgprint(__('Error: Expected Price or Total Quantity is not a number.'));\n            }\n        },\n        \n       total_quantity: function(frm, cdt, cdn) {\n            var d = locals[cdt][cdn];\n            var total_quantity = d.total_quantity || 0;\n            var expected_price = d.expected_price;\n    \n            if (!isNaN(expected_price) && !isNaN(total_quantity)) {\n                var total = total_quantity * expected_price;\n                frappe.model.set_value(cdt, cdn, 'total', total);\n            } else {\n                frappe.msgprint(__('Error: Expected Price or Total Quantity is not a number.'));\n            }\n        }    \n});\nfrappe.ui.form.on('Budget Request', {\n    insert_item_quantity: function(frm) {\n        // Loop through child table rows\n    \n        frm.doc.budget_items_details.forEach(function(d) {\n\n            var dialog = new frappe.ui.Dialog({\n                title: __('Enter Monthly Budget Quantities for ' + (d.item_name || d.item_code)),\n                fields: [\n                    { fieldname: \"january\", fieldtype: 'Float', label: __(\"January\") },\n                    { fieldname: \"july\", fieldtype: \"Float\", label: __(\"July\") },\n                    { fieldname: \"column_break\", fieldtype: 'Column Break' },\n                    { fieldname: \"february\", fieldtype: \"Float\", label: __(\"February\") },\n                    { fieldname: \"august\", fieldtype: \"Float\", label: __(\"August\") },\n                    { fieldname: \"column_break\", fieldtype: 'Column Break' },\n                    { fieldname: \"march\", fieldtype: \"Float\", label: __(\"March\") },\n                    { fieldname: \"september\", fieldtype: \"Float\", label: __(\"September\") },\n                    { fieldname: \"column_break\", fieldtype: 'Column Break' },\n                    { fieldname: \"april\", fieldtype: \"Float\", label: __(\"April\") },\n                    { fieldname: \"october\", fieldtype: \"Float\", label: __(\"October\") },\n                    { fieldname: \"column_break\", fieldtype: 'Column Break' },\n                    { fieldname: \"may\", fieldtype: \"Float\", label: __(\"May\") },\n                    { fieldname: \"november\", fieldtype: 'Float', label: __(\"November\") },\n                    { fieldname: \"column_break\", fieldtype: 'Column Break' },\n                    { fieldname: \"june\", fieldtype: \"Float\", label: __(\"June\") },\n                    { fieldname: \"december\", fieldtype: \"Float\", label: __(\"December\") }\n                ],\n                size: 'large',\n            });\n\n            // Pre-fill values\n            dialog.set_values({\n                'january': d.january || 0.00,\n                'february': d.february || 0.00, \n                'march': d.march || 0.00,\n                'april': d.april || 0.00,\n                'may': d.may || 0.00,\n                'june': d.june || 0.00,\n                'july': d.july || 0.00,\n                'august': d.august || 0.00,\n                'september': d.september || 0.00,\n                'october': d.october || 0.00,\n                'november': d.november || 0.00,\n                'december': d.december || 0.00,\n            });\n\n            // Update action\n            dialog.set_primary_action(__('Update'), function() {\n                var fields = [\n                    'january','february','march','april','may','june',\n                    'july','august','september','october','november','december'\n                ];\n                var total_quantity = 0;\n                fields.forEach(function(fieldname) {\n                    var value = parseFloat(dialog.get_value(fieldname)) || 0;\n                    frappe.model.set_value(d.doctype, d.name, fieldname, value);\n                    total_quantity += value;\n                });\n                frappe.model.set_value(d.doctype, d.name, 'total_quantity', total_quantity);\n\n                frappe.show_alert({\n                    message: __('Month values updated for ' + (d.item_name || d.item_code)),\n                    indicator: 'green'\n                }, 5);\n\n                dialog.hide();\n            });\n\n            dialog.show();\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 1,
  "modified": "2025-08-21 02:23:45.086867",
  "module": "AlphaX Budget",
  "name": "View Plan Report",
  "script": "// frappe.ui.form.on('Budget Request', {\r\n//     refresh: function(frm) {\r\n//         frm.add_custom_button(__('View Plan Report'), function() {\r\n//             var filters = {\r\n//                 \"budget_control\": frm.doc.budget_control,\r\n//                 \"department\": frm.doc.department,\r\n//                 \"cost_center\": frm.doc.cost_center,\r\n//                 \"fiscal_year\": frm.doc.fiscal_year,\r\n//                 \"name\" : frm.doc.name,\r\n//             };\r\n//             frappe.set_route('query-report', 'Budget Planning Report', filters);\r\n//         });\r\n//     }\r\n// });\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 0,
  "modified": "2025-07-27 02:26:28.967525",
  "module": "AlphaX Budget",
  "name": "creat  monthly destribution",
  "script": "frappe.ui.form.on(\"Budget Request\", {\n    refresh: (frm) => {\n        console.log(frm.doc.workflow_state);\n        console.log(frm.selected_workflow_action);\n\n        // if (frm.doc.workflow_state === \"مراجعة المدير التنفيذي\" && frm.selected_workflow_action === \"Approve\") {\n            console.log(\"Validating Budget Request form on submit.\");\n\n            // Ensure Cost Center is not empty\n            if (!frm.doc.cost_center) {\n                frappe.throw(\"Please select a Cost Center before submitting the form.\");\n                frappe.validated = false;\n                return false; // Prevent form submission\n            }\n\n            // Ensure there are <<accepted items>>\n            var acceptedItemsExist = frm.doc.budget_items_details.some(function(item) {\n                return item.status === \"Accepted\";\n            });\n\n            if (!acceptedItemsExist) {\n                frappe.throw(\"Please accept at least one item before submitting the form.\");\n                frappe.validated = false;\n                return false; // Prevent form submission\n            }\n\n            // Ensure each row has an account of type expenses and expected price\n            var invalidRows = frm.doc.budget_items_details.filter(function(item) {\n                return !item.expense_account || !item.expected_price;\n            });\n\n            if (invalidRows.length > 0) {\n                frappe.throw(\"Please ensure each row has an expense account and expected price before submitting the form.\");\n                frappe.validated = false;\n                frm.refresh_fields();\n                return false; // Prevent form submission\n            }\n\n            // Initialize variables\n            var month_list = [\n                \"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \"July\",\n                \"August\", \"September\", \"October\", \"November\", \"December\"\n            ];\n            var total_per_account = {};\n            var account_budget = [];\nconsole.log(\"iam here>>>\")\n            function getMonths(total, item_summary) {\n                var total_custom_ratio = item_summary.reduce(function(acc, item) {\n                    return acc + (item.total / total) * 100;\n                }, 0);\n\n                var months = month_list.map(function(month, index) {\n                    var percentage_allocation = 0;\n                    if (total_custom_ratio !== 0) {\n                        percentage_allocation = (item_summary[index].total / total) * 100;\n                    }\n                    return {\n                        \"percentage_allocation\": percentage_allocation.toFixed(4), // Round to 2 decimal places\n                        \"month\": month\n                    };\n                });\n\n                if (total_custom_ratio < 100) {\n                    var remaining_percentage = 100 - total_custom_ratio;\n                    months[months.length - 1].percentage_allocation = (parseFloat(months[months.length - 1].percentage_allocation) + remaining_percentage).toFixed(2);\n                }\n\n                return months;\n            }\n\n            var monthly_distributions = [];\n\n            // Create Monthly Distribution records for each row\n            let promises = frm.doc.budget_items_details.map(row => {\n                var monthlyDistribution = frappe.model.get_new_doc(\"Monthly Distribution\");\n                frappe.msgprint(`monthly distribution created`)\n                monthlyDistribution.distribution_id = frm.doc.name;\n                monthlyDistribution.fiscal_year = frm.doc.fiscal_year;\n\n                let percentages = month_list.map(month => {\n                    let monthKey = month.toLowerCase();\n                    return {\n                        \"month\": month,\n                        \"percentage_allocation\": row[monthKey] / row.total_quantity * 100 || 0\n                    };\n                });\n\n                monthlyDistribution.percentages = percentages;\n\n                return frappe.db.insert(monthlyDistribution)\n                    .then(doc => {\n                        console.log(\"Monthly Distribution created:\", doc.name);\n                        monthly_distributions.push({ account: row.expense_account, name: doc.name });\n                    });\n            });\n                    // var monthly_distribution = frappe.model.get_new_doc(\"Monthly Distribution\");\n                    // monthly_distribution.distribution_id = frm.doc.name;\n                    // monthly_distribution.fiscal_year = frm.doc.fiscal_year;\n                    // monthly_distribution.percentages = getMonths(frm.doc.total, frm.doc.item_summary);\n                    // console.log(\"Monthly Distribution document(1):\", monthly_distribution);\n            \n                    // Insert Monthly Distribution document\n                    // frappe.db.insert(monthly_distribution).then(function(response) {\n                        \n            ////////////////////////////\n            ///////////AHMED///////////\n            Promise.all(promises).then(() => {\n                // Loop through budget items\n                frm.doc.budget_items_details.forEach(function(item) {\n                    console.log(\"Expense Account:\", item.expense_account, \"Total:\", item.total);\n                    if (item.status === \"Accepted\") {\n                        total_per_account[item.expense_account] = (total_per_account[item.expense_account] || 0) + item.total;\n                    }\n                });\n\n                // Assign monthly distributions to accounts\n                for (var account in total_per_account) {\n                    if (total_per_account.hasOwnProperty(account)) {\n                        let distribution = monthly_distributions.find(dist => dist.account === account);\n                        if (distribution) {\n                            account_budget.push({\n                                \"account\": account,\n                                \"monthly_distribution\": distribution.name,\n                                \"budget_amount\": total_per_account[account]\n                            });\n                        }\n                    }\n                }\n\n                console.log(\"account_budget\", account_budget);\n\n                // Create Budget document\n                var budget = frappe.model.get_new_doc(\"Budget\");\n                alphax_budget.alphax_budgett_against = \"Cost Center\";\n                // budget.monthly_distribution = monthly_distribution_name; // Use the generated name\n                budget.cost_center = frm.doc.cost_center;\n                budget.fiscal_year = frm.doc.fiscal_year;\n                budget.applicable_on_material_request = 1;\n                budget.applicable_on_purchase_order = 1;\n                budget.applicable_on_booking_actual_expenses = 1;\n                budget.action_if_annual_budget_exceeded_on_mr = \"Stop\";\n                budget.action_if_annual_budget_exceeded_on_po = \"Stop\";\n                budget.action_if_accumulated_monthly_budget_exceeded_on_mr = \"Warn\";\n                budget.action_if_accumulated_monthly_budget_exceeded_on_po = \"Warn\";\n                budget.custom_budget_request_reference = frm.doc.name;\n                budget.accounts = account_budget;\n\n                console.log(\"Budget document:\", budget);\n\n                return frappe.db.insert(budget);\n            }).then((budget) => {\n                frappe.msgprint(\"Budget created successfully.\");\n                let monthly_distribution = frappe.model.get_new_doc(\"Monthly Distribution\");\n                 monthly_distribution.distribution_id = frm.doc.name;\n                 monthly_distribution.fiscal_year = frm.doc.fiscal_year;\n                 monthly_distribution.percentages = getMonths(frm.doc.total, frm.doc.item_summary);\n                 console.log(\"Monthly Distribution document:\", monthly_distribution);\n                frappe.db.insert(monthly_distribution).then(function(r) {\n                   console.log(\"finnaly\",budget); \n                   frappe.db.set_value('Budget',budget.name, 'monthly_distribution', r.name);\n                      console.log(\"finnalylast_budget\",budget.name); \n\n                });\n\n                \n            }).catch(err => {\n                console.error(\"Error inserting budget:\", err);\n                frappe.msgprint(\"Error creating budget.\");\n            });\n            ////////////////////////////\n            ///////////AHMED///////////\n                        \n                        \n                        \n                        \n                        \n                    //  }).then(function() {\n                    //     console.log(\"Budget document inserted successfully.\");\n                    //     frappe.msgprint(\"Budget created successfully.\");\n                    // }).catch(function(err) {\n                    //     // console.error(\"Error inserting budget:\" + err);\n                    //     frappe.msgprint(\"Error creating budget.\");\n                    // });\n\n\n        // }\n    },\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 0,
  "modified": "2025-08-25 18:51:54.491680",
  "module": "AlphaX Budget",
  "name": "filter Budget Request after press field Budget Source",
  "script": "frappe.ui.form.on('Budget Request', {\n    refresh: function (frm) {\n        if (frm.doc.__islocal && frm.doc.__unsaved) {\n            // Fetch the latest Budget Control document\n            frappe.db.get_list('Budget Control', {\n                fields: ['name'],\n                filters: {'status': 'In Progress'},\n                order_by: 'creation desc',\n                limit: 1\n            }).then(docs => {\n                if (docs.length > 0) {\n                    let latest_doc = docs[0];\n                    \n                    // Set the query to filter the 'custom_budget_source' field\n                    frm.set_query('custom_budget_source', function() {\n                        return {\n                            filters: [\n                                ['name', '=', latest_doc.name]\n                            ]\n                        };\n                    });\n                    \n                    // Optionally set the field value directly if needed\n                    frm.set_value('custom_budget_source', latest_doc.name);\n                }\n            }).catch(err => {\n                console.error('Error fetching Budget Control:', err);\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 1,
  "modified": "2025-08-13 21:14:57.036478",
  "module": "AlphaX Budget",
  "name": "calc",
  "script": "frappe.ui.form.on('Budget Request',  {\r\n    refresh: function(frm) {\r\n        // use the __islocal value of doc,  to check if the doc is saved or not\r\n        // if(frm.doc.__unsaved && !frm.doc.department) frappe.msgprint(\"Set Department First and Save The Doc \");\r\n        if(frm.doc.department && !frm.doc.budget_items_details.length){\r\n            frappe.call({\r\n                method: \"alphax_budget.alphax_budget.api.api.get_items_per_department\",\r\n                args: {\r\n                    department: frm.doc.department,\r\n                    // order_by: custom_item_category,\r\n                },\r\n                callback(r) {\r\n                    frm.doc.budget_items_details = [];\r\n                    let items = r.message;\r\n                    // items.sort();\r\n                    // items.sort((a, b) => a.custom_item_category - b.custom_item_category);\r\n\r\n                    items.forEach((item) => {\r\n                        frm.add_child(\"budget_items_details\", {\r\n                            item_name: item.name,\r\n                            expense_account: item.expense_account,\r\n                            custom_item_category:item.custom_item_category,\r\n                        });\r\n                    });\r\n                    frm.refresh_fields();\r\n                },\r\n            });\r\n        }\r\n    }\r\n});\r\n\r\n// frm.doc.__unsaved\r\n\r\nfrappe.ui.form.on(\"Budget Request\", {\r\n  department(frm) {\r\n    //   if( frm.doc.__unsaved && !frm.doc.department){\r\n    //       msgprint(\"Set Department First and Save the Doc \");\r\n    //   }\r\n      if(frm.doc.department){\r\n    frappe.call({\r\n      method: \"alphax_budget.alphax_budget.api.api.get_items_per_department\",\r\n      args: {\r\n        department: frm.doc.department,\r\n      },\r\n      callback(r) {\r\n        frm.doc.budget_items_details = [];\r\n        let items = r.message;\r\n        console.log(r.message);\r\n        items.forEach((item) => {\r\n          frm.add_child(\"budget_items_details\", {\r\n            item_name: item.name,\r\n            expense_account: item.expense_account,\r\n            custom_item_category: item.custom_item_category,\r\n          });\r\n        });\r\n        frm.refresh_fields();\r\n      },\r\n    });\r\n      }\r\n  },\r\n\r\n\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Budget Items Details', {\r\n//     custom_show: function(frm, cdt, cdn) {\r\n//         var child = locals[cdt][cdn];\r\n//         var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];\r\n\r\n//         // Check if form is unsaved\r\n//         if (frm.doc.__unsaved) {\r\n//             frappe.msgprint(__('Please save the form before using this feature.'));\r\n//             return;\r\n//         }\r\n\r\n//         var dialog = new frappe.ui.Dialog({\r\n//             title: __('Enter Monthly Budget Quantities'),\r\n//             fields: [\r\n//                 {\r\n//                     fieldname: 'budget_table',\r\n//                     fieldtype: 'HTML',\r\n//                     label: __('Budget Table')\r\n//                 }\r\n//             ]\r\n//         });\r\n\r\n//         // Add primary action button\r\n//         dialog.set_primary_action(__('Update'), function() {\r\n//             var dialog_values = {};\r\n//             var total_quantity = 0;\r\n//             for (var i = 0; i < months.length; i++) {\r\n//                 var month_fieldname = months[i].toLowerCase();\r\n//                 dialog_values[month_fieldname] = $('#' + month_fieldname + '_' + child.idx).val();\r\n//                 total_quantity += parseFloat(dialog_values[month_fieldname]) || 0;\r\n//             }\r\n//             console.log('Dialog Values:', dialog_values);\r\n\r\n//             frappe.model.set_value(cdt, cdn, 'total_quantity', total_quantity);\r\n\r\n//             var expected_price = child.expected_price;\r\n//             if (!isNaN(expected_price) && !isNaN(total_quantity)) {\r\n//                 var total = total_quantity * expected_price;\r\n//                 console.log('Total Quantity:', total_quantity);\r\n//                 console.log('Expected Price:', expected_price);\r\n//                 console.log('Total:', total);\r\n//                 frappe.model.set_value(cdt, cdn, 'total', total);\r\n//             } else {\r\n//                 frappe.msgprint(__('Error: Expected Price or Total Quantity is not a number.'));\r\n//             }\r\n\r\n//             frappe.model.set_value(cdt, cdn, dialog_values);\r\n\r\n//             frm.save();\r\n//             dialog.hide();\r\n//             //location.reload()\r\n//         });\r\n\r\n//         var table_html = '<table class=\"table table-bordered\">';\r\n//         for (var i = 0; i < 12; i++) {\r\n//             if (i % 6 === 0) {\r\n//                 table_html += '<tr>';\r\n//             }\r\n//             var month_fieldname = months[i].toLowerCase();\r\n//             var month_value = child[month_fieldname] || '';\r\n//             // Append the row index to the ID of each input field\r\n//             table_html += '<td><label>' + months[i] + '</label><input type=\"text\" class=\"form-control float-input\" id=\"' + month_fieldname + '_' + child.idx + '\" name=\"' + month_fieldname + '\" value=\"' + month_value + '\"></td>';\r\n//             if ((i + 1) % 6 === 0) {\r\n//                 table_html += '</tr>';\r\n//             }\r\n//         }\r\n//         table_html += '</table>';\r\n//         dialog.fields_dict['budget_table'].$wrapper.html(table_html);\r\n\r\n//         dialog.show();\r\n//     },\r\n//     expected_price: function(frm, cdt, cdn) {\r\n//         var child = locals[cdt][cdn];\r\n//         var total_quantity = child.total_quantity || 0;\r\n//         var expected_price = child.expected_price;\r\n\r\n//         if (!isNaN(expected_price) && !isNaN(total_quantity)) {\r\n//             var total = total_quantity * expected_price;\r\n//             console.log('Total Quantity:', total_quantity);\r\n//             console.log('Expected Price:', expected_price);\r\n//             console.log('Total:', total);\r\n//             frappe.model.set_value(cdt, cdn, 'total', total);\r\n//         } else {\r\n//             frappe.msgprint(__('Error: Expected Price or Total Quantity is not a number.'));\r\n//         }\r\n//     }\r\n//});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nfrappe.ui.form.on('Budget Request', {\r\n    // Custom function to perform calculations\r\n    before_save: function(frm) {\r\n        let months = [\r\n            \"january\", \"february\", \"march\", \"april\", \"may\", \"june\", \"july\",\r\n            \"august\", \"september\", \"october\", \"november\", \"december\"\r\n        ];\r\n\r\n        let total_quantity = 0;\r\n        let total_amount = 0;\r\n\r\n        frm.doc.item_summary = [];\r\n\r\n        for (let month of months) {\r\n            let month_total_quantity = 0;\r\n            let month_total_amount = 0;\r\n\r\n            frm.doc.budget_items_details.forEach((item) => {\r\n                // Consider the value as zero if the status is not \"Accepted\"\r\n                let quantity = item.status == \"Accepted\" ? (item[month] || 0) : 0;\r\n                let amount = quantity * (item.expected_price || 0);\r\n\r\n                month_total_quantity += quantity;\r\n                month_total_amount += amount;\r\n            });\r\n\r\n            // Add summary for the month\r\n            frm.add_child(\"item_summary\", {\r\n                month: month,\r\n                total: month_total_amount,\r\n                total_quantity: month_total_quantity\r\n            });\r\n\r\n            total_amount += month_total_amount;\r\n            total_quantity += month_total_quantity;\r\n        }\r\n\r\n        frm.doc.total = total_amount;\r\n        frm.doc.total_quantity = total_quantity;\r\n\r\n        // // Explicitly show the submit button if the form is saved\r\n        // if (frm.doc.docstatus === 0 && frm.doc.__unsaved) {\r\n        //     frm.set_primary_action(__('Submit'), function() {\r\n        //         frm.save('Submit');\r\n        //     });\r\n        // }\r\n\r\n        frm.refresh_fields();\r\n    },\r\n\r\n    // Call the calculation function after the form is saved\r\n    // after_save: function(frm) {\r\n    //     frm.events.calculate_totals(frm);\r\n    // }\r\n});\r\n\r\n\r\n\r\n\r\n\r\nfrappe.ui.form.on('Budget Request', {\r\n    before_save: function(frm) {\r\n        let total_quantity = 0;\r\n\r\n        // Iterate over each row in budget_items_details\r\n        frm.doc.budget_items_details.forEach((item) => {\r\n            total_quantity += (item.total_quantity || 0); // Sum up the total_quantity of each row\r\n        });\r\n\r\n        // Update total_quantity field in the parent form\r\n        frm.doc.total_quantity = total_quantity;\r\n\r\n        frm.refresh_fields();\r\n    },\r\n});\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 0,
  "modified": "2025-07-28 18:57:10.458576",
  "module": "AlphaX Budget",
  "name": "validate budget in purchase order",
  "script": "frappe.ui.form.on(\"Purchase Order\", {\n validate(frm) {\n\n        // if (frm.doc.workflow_state === 'مراجعة المدير المالي') {\n            // if(frm.selected_workflow_action === \"Approve\"){\n            //  console.log(frm.selected_workflow_action ,frm.doc.workflow_state === \"مراجعة المدير المالي\");\n            \n        const transactionDate =cur_frm.doc.transaction_date;\n        if (!transactionDate){\n            \n            frappe.validated = false;\n            return false;\n        }\n        get_po(frm).then(poResults => {\n            console.log(\"Purchase Orders Totals:\", poResults);\n\n            get_monthly_distribution(frm, poResults).then(allocatedAmounts => {\n                // Ensure this is logged only once\n                console.log(\"Allocated Amountsggg:\", allocatedAmounts);\n                allocatedAmounts.forEach(row =>{\n                    \n                   let budget_doc = frappe.get_doc(\"Budget\",row.parent);\n                    frappe.call({\n                            method: \"frappe.client.get\",\n                            args: {\n                                doctype: \"Budget\",\n                                name: row.parent,\n                                fields: [\"*\"],\n                            },\n                            callback: function (r) {\n                                console.log(r.message);\n                            let items = frm.doc.items;  \n                            items.forEach(item=>{\n                                console.log(\"Solgan\",item.amount,item.expense_account,item.cost_center);\n                                let budget = r.message;\n                            let applicable =budget.applicable_on_purchase_order;\n                            let action = budget.custom_action_if__monthly_budget_exceeded_on_po;\n                                if(applicable === 1){\n                                    console.log(\"Action1\",action ==\"Warn\" )\n                                    console.log(\"Action2\",row,row.account == item.expense_account )\n                                    console.log(\"Action3\",row.cost_center == item.cost_center)\n                                     console.log(\"Action4\",item.amount+row.total_amount>row.budget_monthly)\n                                if(action ==\"Warn\" && row.account == item.expense_account && row.cost_center == item.cost_center&& item.amount+row.total_amount>row.budget_monthly){\n                                       frappe.msgprint(\n                                            __(` Account : ${row.account}\\n\\n\n                                            Monthly Budget :${parseInt(row.budget_monthly)}  \n                                            Total purchase order reservied Amount:${row.total_amount}    \n                                            it will exceed by ${parseInt(item.amount+row.total_amount- row.budget_monthly)} \n                                            \n                                            \n                                            `)\n                                            // () => { change_workflow_state(frm); },\n                                            // () => { frappe.msgprint(__('You pressed no and workflow state not changed'))\n                                            //         cur_frm.set_value(\"workflow_state\", \"مراجعة المدير المالي\");\n\n                                            // }\n                                        );  \n                                }else if(action ==\"Stop\" && row.total_amount > row.budget_monthly){\n                                    frappe.throw( __(` Account : ${row.account}\\n\\n\n                                            Monthly Budget :${parseInt(row.budget_monthly)}  \n                                            Total purchase order reservied Amount:${row.total_amount}    \n                                            it will exceed by ${parseInt(item.amount+row.total_amount- row.budget_monthly)} \n                                            \n                                            \n                                            `));\n                                }else if(action ==\"Ignore\"){\n                                    frappe.msgprint (__(` Account : ${row.account}\\n\\n\n                                            Monthly Budget :${parseInt(row.budget_monthly)}  \n                                            Total purchase order reservied Amount:${row.total_amount}    \n                                            it will exceed by ${parseInt(item.amount+row.total_amount- row.budget_monthly)} \n                                            \n                                            \n                                            `))\n                                }\n                                \n                            }\n                            })\n                            \n\n                            \n                            }\n                    });\n\n                });\n            }).catch(error => {\n                console.error(\"Error in get_monthly_distribution:\", error);\n            });\n            }).catch(error => {\n                console.error(\"Error in get_po:\", error);\n            });\n        }\n             \n        // }\n        // if(frm.)\n        \n    // }\n});\nasync function get_po(frm) {\n    let results = {}; // Object to store totals by expense account\n    let today = new Date(frm.doc.transaction_date);\n    let startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);\n    let endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);\n\n    try {\n        let purchaseOrders = await new Promise((resolve, reject) => {\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"Purchase Order\",\n                    limit_page_length: 1000000,\n                    fields: [\"name\"],\n                    filters: [\n                        [\"docstatus\", \"=\", 1],\n                        [\"transaction_date\", \">=\", startOfMonth],\n                        [\"transaction_date\", \"<\", endOfMonth],\n                    ],\n                },\n                callback: function (r) {\n                    r.message ? resolve(r.message) : reject(\"Failed to fetch Purchase Orders.\");\n                }\n            });\n        });\n\n        if (purchaseOrders.length > 0) {\n            let responses = await Promise.all(purchaseOrders.map(order =>\n                new Promise((resolve, reject) => {\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: {\n                            doctype: \"Purchase Order\",\n                            name: order.name,\n                            fields: [\"items\"],\n                        },\n                        callback: function (r) {\n                            r.message ? resolve(r.message) : reject(\"Failed to fetch Purchase Order details.\");\n                        }\n                    });\n                })\n            ));\n\n            responses.forEach(response => {\n                let allPurchaseOrderItems = response.items || [];\n                allPurchaseOrderItems.forEach(item => {\n                    let amount = item.amount || 0;\n                    let expense_account = item.expense_account || '';\n\n                    if (expense_account) {\n                        if (!results[expense_account]) {\n                            results[expense_account] = { total_amount: 0 };\n                        }\n                        results[expense_account].total_amount += amount;\n                    }\n                });\n            });\n        } else {\n            console.error(\"No Purchase Orders found.\");\n        }\n\n    } catch (error) {\n        console.error(\"Error in get_po function\", error);\n    }\n\n    return results;\n}\n\n// async function get_budget(frm) {\n//     let today = new Date(frm.doc.transaction_date);\n//     let PO_year = today.getFullYear();\n\n//     try {\n//         let results = await get_po(frm);\n//         // console.log(\"Results\", results);\n\n//         let budgetDetails = {}; // Initialize budgetDetails as an object\n\n//         for (let expense_account in results) {\n//             if (results.hasOwnProperty(expense_account)) {\n//                 let result = results[expense_account];\n//                 // console.log(`Expense Account: ${expense_account}`);\n//                 // console.log(`Total Amount: ${result.total_amount}`);\n//                 // console.log('---');\n\n//                 let budgetResponse = await new Promise((resolve, reject) => {\n//                     frappe.call({\n//                         method: \"frappe.client.get_list\",\n//                         args: {\n//                             doctype: \"Budget\",\n//                             limit_page_length: 5000,\n//                             fields: [\"name\", \"cost_center\"],\n//                             filters: [\n//                                 [\"docstatus\", \"=\", 1],\n//                                 [\"fiscal_year\", \"=\", PO_year],\n//                             ],\n//                             limit: 1,\n//                         },\n//                         callback: function (r) {\n                            \n//                             r.message ? resolve(r.message) : reject(\"Failed to fetch budget details.\");\n//                         }\n//                     });\n//                 });\n\n//                 if (budgetResponse.length > 0) {\n//                     let budget = budgetResponse[0];\n//                     let budgetDetails =[]\n//                     let budgetDocResponse = await new Promise((resolve, reject) => {\n//                         frappe.call({\n//                             method: \"frappe.client.get\",\n//                             args: {\n//                                 doctype: \"Budget\",\n//                                 name: budget.name,\n//                                 fields: [\"accounts\"],\n//                             },\n//                             callback: function (r) {\n//                                 console.log(\"table ACCCCCOunts in buget\",r.message.accounts)\n//                                 r.message ? resolve(r.message) : reject(\"Failed to fetch budget document details.\");\n//                                 return r.message.accounts\n//                             }\n//                         });\n//                     });\n\n//                     if (budgetDocResponse) {\n//                         let table_budget_items = budgetDocResponse.accounts;\n//                         table_budget_items.forEach(item => {\n//                             budgetDetails.push = [{\n//                                 ...item, // Merge current item into budgetDetails\n//                                 cost_center: budgetDocResponse.cost_center // Ensure cost_center is added/updated\n//                             }];\n//                         });\n//                     } else {\n//                         console.error(\"Failed to fetch budget document details.\");\n//                     }\n//                 } else {\n//                     // console.log(\"No budgets found for the current year.\");\n//                 }\n//             }\n//         }\n\n\n\n//     } catch (error) {\n//         console.error(\"Error in get_budget function\", error);\n//         throw error; // Re-throw the error to be handled by the caller\n//     }\n//     console.log(\"boxxxxxxxxxxxxxxxx\",budgetDetails)\n// }\nasync function get_budget(frm) {\n    let today = new Date(frm.doc.transaction_date);\n    let PO_year = today.getFullYear();\n    let budgetDetails = []; // Use an array to accumulate budget details\n\n    try {\n        let results = await get_po(frm);\n        // console.log(\"Results\", results);\n\n        for (let expense_account in results) {\n            if (results.hasOwnProperty(expense_account)) {\n                let result = results[expense_account];\n                // console.log(`Expense Account: ${expense_account}`);\n                // console.log(`Total Amount: ${result.total_amount}`);\n                // console.log('---');\n\n                let budgetResponse = await new Promise((resolve, reject) => {\n                    frappe.call({\n                        method: \"frappe.client.get_list\",\n                        args: {\n                            doctype: \"Budget\",\n                            limit_page_length: 5000,\n                            fields: [\"name\", \"cost_center\"],\n                            filters: [\n                                [\"docstatus\", \"=\", 1],\n                                [\"fiscal_year\", \"=\", PO_year],\n                            ],\n                            limit: 1,\n                        },\n                        callback: function (r) {\n                            r.message ? resolve(r.message) : reject(\"Failed to fetch budget details.\");\n                        }\n                    });\n                });\n\n                if (budgetResponse.length > 0) {\n                    let budget = budgetResponse[0];\n\n                    let budgetDocResponse = await new Promise((resolve, reject) => {\n                        frappe.call({\n                            method: \"frappe.client.get\",\n                            args: {\n                                doctype: \"Budget\",\n                                name: budget.name,\n                                fields: [\"accounts\"],\n                            },\n                            callback: function (r) {\n                                // console.log(\"Table Accounts in Budget\", r.message.accounts);\n                                r.message ? resolve(r.message) : reject(\"Failed to fetch budget document details.\");\n                            }\n                        });\n                    });\n\n                    if (budgetDocResponse && budgetDocResponse.accounts) {\n                        let table_budget_items = budgetDocResponse.accounts;\n                        table_budget_items.forEach(item => {\n                            budgetDetails.push({\n                                ...item,\n                                cost_center: budget.cost_center // Ensure cost_center is added/updated\n                            });\n                        });\n                    } else {\n                        console.error(\"Failed to fetch budget document details.\");\n                    }\n                } else {\n                    // console.log(\"No budgets found for the current year.\");\n                }\n            }\n        }\n\n    } catch (error) {\n        console.error(\"Error in get_budget function\", error);\n        throw error; // Re-throw the error to be handled by the caller\n    }\n\n    console.log(\"Budget Details:\", budgetDetails);\n    return budgetDetails; // Return budgetDetails properly\n}\n\nasync function get_monthly_distribution(frm, poResults) {\n    try {\n        let budgetDetails = await get_budget(frm);\n        console.log(\"Budget Detailsaaaaaaaaaaaaaaaaaaaaaaaaaaa:\", budgetDetails);\n          if (!Array.isArray(budgetDetails)) {\n            throw new Error(\"Invalid data format returned from get_budget.\");\n        }\n        let monthList = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n        let po_month = new Date(frm.doc.transaction_date);\n        let currentMonthIndex = po_month.getMonth(); // Zero-based index\n\n        let allocatedAmounts = [];\n\n        for (let budget of budgetDetails) {\n            let budget_accounts_table = budget; // Access the accounts array from the budget item\n            console.log(\"Accounts Table ACCCCCounts :\", budget);\n\n            let monthlyDistResponse = await new Promise((resolve, reject) => {\n                frappe.call({\n                    method: \"frappe.client.get\",\n                    args: {\n                        doctype: \"Monthly Distribution\",\n                        name: budget_accounts_table.monthly_distribution,\n                        fields: [\"percentages\"],\n                    },\n                    callback: function (r) {\n                        r.message ? resolve(r.message) : reject(\"Failed to fetch monthly distribution.\");\n                    }\n                });\n            });\n\n            let child = monthlyDistResponse.percentages;\n            child.forEach(row => {\n                if (row.month === monthList[currentMonthIndex]) {\n                    let allocatedAmount = (row.percentage_allocation * budget_accounts_table.budget_amount) / 100;\n                    let totalAmount = poResults[budget_accounts_table.account] ? poResults[budget_accounts_table.account].total_amount : 0;\n                    // console.log(\"totalAmount\",poResults[budget_accounts_table.account].total_amount,\"buss\",budget_accounts_table.parent);\n                    allocatedAmounts.push({\n                        \"account\": budget_accounts_table.account,\n                        \"cost_center\": budget.cost_center,\n                        \"budget_monthly\": allocatedAmount,\n                        \"total_amount\": totalAmount,// Add total amount for the account\n                        \"parent\": budget_accounts_table.parent,\n                    });\n                }\n            });\n        }\n\n        // Ensure allocatedAmounts is logged only once\n        // console.log(\"Final Allocated Amounts:\", allocatedAmounts);\n        return allocatedAmounts;\n\n    } catch (error) {\n        console.error(\"Error in get_monthly_distribution:\", error);\n        throw error; // Re-throw the error to be handled by the caller\n    }\n    //  console.log(\"Final Allocated Amount22s:\", allocatedAmounts);\n}\n\nfunction change_workflow_state(frm) {\n    // Move to the next state in the workflow\n    cur_frm.set_value(\"workflow_state\", \"مراجعة المدير المالي\");\n\n    frm.save().then(() => {\n        frappe.msgprint(__('Workflow state changed successfully.'));\n    }).catch((error) => {\n        frappe.msgprint(__('Failed to change workflow state.'));\n        console.error(error);\n    });\n}\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 0,
  "modified": "2025-07-27 02:49:23.975345",
  "module": "AlphaX Budget",
  "name": "Create  monthly destribution",
  "script": "frappe.ui.form.on(\"Budget Request\", {\n    refresh: function(frm) {\n        console.log(\"Workflow State:\", frm.doc.workflow_state);\n        console.log(\"Selected Workflow Action:\", frm.selected_workflow_action);\n    },\n\n    validate: function(frm) {\n        // Only run validation for specific workflow states if needed\n        // Uncomment and modify the condition below as per your workflow requirements\n        // if (frm.doc.workflow_state === \"مراجعة المدير التنفيذي\" && frm.selected_workflow_action === \"Approve\") {\n            return validateBudgetRequest(frm);\n        // }\n    }\n});\n\n/**\n * Validates the Budget Request form before submission\n * @param {Object} frm - The form object\n * @returns {boolean} - Returns false if validation fails\n */\nfunction validateBudgetRequest(frm) {\n    console.log(\"Validating Budget Request form on submit.\");\n\n    try {\n        // Validate Cost Center\n        if (!validateCostCenter(frm)) return false;\n        \n        // Validate Budget Items\n        if (!validateBudgetItems(frm)) return false;\n        \n        // Create budget and monthly distributions\n        createBudgetWithDistributions(frm);\n        \n        return true;\n    } catch (error) {\n        console.error(\"Validation error:\", error);\n        frappe.throw(\"An error occurred during validation. Please try again.\");\n        return false;\n    }\n}\n\n/**\n * Validates that Cost Center is selected\n * @param {Object} frm - The form object\n * @returns {boolean} - Returns true if valid\n */\nfunction validateCostCenter(frm) {\n    if (!frm.doc.cost_center) {\n        frappe.throw(__(\"Please select a Cost Center before submitting the form.\"));\n        return false;\n    }\n    return true;\n}\n\n/**\n * Validates budget items for required fields and accepted items\n * @param {Object} frm - The form object\n * @returns {boolean} - Returns true if valid\n */\nfunction validateBudgetItems(frm) {\n    if (!frm.doc.budget_items_details || frm.doc.budget_items_details.length === 0) {\n        frappe.throw(__(\"Please add at least one budget item.\"));\n        return false;\n    }\n\n    // Check for accepted items\n    const acceptedItems = frm.doc.budget_items_details.filter(item => item.status === \"Accepted\");\n    if (acceptedItems.length === 0) {\n        frappe.throw(__(\"Please accept at least one item before submitting the form.\"));\n        return false;\n    }\n\n    // Validate each row has required fields\n    const invalidRows = frm.doc.budget_items_details.filter(item => \n        !item.expense_account || !item.expected_price || item.expected_price <= 0\n    );\n\n    if (invalidRows.length > 0) {\n        frappe.throw(__(\"Please ensure each row has a valid expense account and expected price greater than 0.\"));\n        return false;\n    }\n\n    return true;\n}\n\n/**\n * Creates budget document with monthly distributions\n * @param {Object} frm - The form object\n */\nasync function createBudgetWithDistributions(frm) {\n    try {\n        frappe.show_progress(__(\"Creating Budget\"), 0, 100, __(\"Preparing data...\"));\n        \n        // Create monthly distributions for each accepted item\n        const monthlyDistributions = await createMonthlyDistributions(frm);\n        \n        frappe.show_progress(__(\"Creating Budget\"), 50, 100, __(\"Creating budget...\"));\n        \n        // Create the main budget document\n        const budget = await createBudgetDocument(frm, monthlyDistributions);\n        \n        // Create overall monthly distribution\n        const overallDistribution = await createOverallMonthlyDistribution(frm);\n        \n        // Link overall distribution to budget\n        await frappe.db.set_value('Budget', budget.name, 'monthly_distribution', overallDistribution.name);\n        \n        frappe.show_progress(__(\"Creating Budget\"), 100, 100, __(\"Completed!\"));\n        frappe.hide_progress();\n        \n        frappe.show_alert({\n            message: __(\"Budget created successfully with reference: {0}\", [budget.name]),\n            indicator: 'green'\n        });\n        \n        console.log(\"Budget creation completed:\", budget.name);\n        \n    } catch (error) {\n        frappe.hide_progress();\n        console.error(\"Error creating budget:\", error);\n        frappe.throw(__(\"Error creating budget: {0}\", [error.message || error]));\n    }\n}\n\n/**\n * Creates monthly distribution documents for each budget item\n * @param {Object} frm - The form object\n * @returns {Array} - Array of created monthly distributions\n */\nasync function createMonthlyDistributions(frm) {\n    const monthList = [\n        \"january\", \"february\", \"march\", \"april\", \"may\", \"june\",\n        \"july\", \"august\", \"september\", \"october\", \"november\", \"december\"\n    ];\n\n    const distributions = [];\n    const acceptedItems = frm.doc.budget_items_details.filter(item => item.status === \"Accepted\");\n\n    for (const item of acceptedItems) {\n        const monthlyDistribution = frappe.model.get_new_doc(\"Monthly Distribution\");\n        monthlyDistribution.distribution_id = `${frm.doc.name}-${item.idx}`;\n        monthlyDistribution.fiscal_year = frm.doc.fiscal_year;\n\n        // Calculate percentages for each month\n        const percentages = monthList.map(month => {\n            const monthValue = item[month] || 0;\n            const totalQuantity = item.total_quantity || 1;\n            return {\n                \"month\": month.charAt(0).toUpperCase() + month.slice(1),\n                \"percentage_allocation\": parseFloat(((monthValue / totalQuantity) * 100).toFixed(4))\n            };\n        });\n\n        monthlyDistribution.percentages = percentages;\n\n        try {\n            const doc = await frappe.db.insert(monthlyDistribution);\n            distributions.push({\n                account: item.expense_account,\n                name: doc.name,\n                amount: item.total || item.expected_price\n            });\n            console.log(\"Monthly Distribution created:\", doc.name);\n        } catch (error) {\n            console.error(\"Error creating monthly distribution:\", error);\n            throw new Error(`Failed to create monthly distribution for item ${item.idx}`);\n        }\n    }\n\n    return distributions;\n}\n\n/**\n * Creates the main budget document\n * @param {Object} frm - The form object\n * @param {Array} monthlyDistributions - Array of monthly distributions\n * @returns {Object} - Created budget document\n */\nasync function createBudgetDocument(frm, monthlyDistributions) {\n    // Group distributions by account and sum amounts\n    const accountBudgets = {};\n    monthlyDistributions.forEach(dist => {\n        if (accountBudgets[dist.account]) {\n            accountBudgets[dist.account].budget_amount += dist.amount;\n        } else {\n            accountBudgets[dist.account] = {\n                account: dist.account,\n                monthly_distribution: dist.name,\n                budget_amount: dist.amount\n            };\n        }\n    });\n\n    const budget = frappe.model.get_new_doc(\"Budget\");\n    alphax_budget.alphax_budgett_against = \"Cost Center\";\n    budget.cost_center = frm.doc.cost_center;\n    budget.fiscal_year = frm.doc.fiscal_year;\n    budget.applicable_on_material_request = 1;\n    budget.applicable_on_purchase_order = 1;\n    budget.applicable_on_booking_actual_expenses = 1;\n    budget.action_if_annual_budget_exceeded_on_mr = \"Stop\";\n    budget.action_if_annual_budget_exceeded_on_po = \"Stop\";\n    budget.action_if_accumulated_monthly_budget_exceeded_on_mr = \"Warn\";\n    budget.action_if_accumulated_monthly_budget_exceeded_on_po = \"Warn\";\n    budget.custom_budget_request_reference = frm.doc.name;\n    budget.accounts = Object.values(accountBudgets);\n\n    console.log(\"Budget document to be created:\", budget);\n\n    return await frappe.db.insert(budget);\n}\n\n/**\n * Creates overall monthly distribution for the budget\n * @param {Object} frm - The form object  \n * @returns {Object} - Created monthly distribution document\n */\nasync function createOverallMonthlyDistribution(frm) {\n    const monthlyDistribution = frappe.model.get_new_doc(\"Monthly Distribution\");\n    monthlyDistribution.distribution_id = frm.doc.name;\n    monthlyDistribution.fiscal_year = frm.doc.fiscal_year;\n    \n    // Use the existing getMonths function or create a simplified version\n    const total = frm.doc.total || 0;\n    const itemSummary = frm.doc.item_summary || [];\n    \n    monthlyDistribution.percentages = calculateMonthlyPercentages(total, itemSummary);\n    \n    console.log(\"Overall Monthly Distribution document:\", monthlyDistribution);\n    \n    return await frappe.db.insert(monthlyDistribution);\n}\n\n/**\n * Calculates monthly percentage allocations\n * @param {number} total - Total amount\n * @param {Array} itemSummary - Array of item summaries\n * @returns {Array} - Array of monthly percentages\n */\nfunction calculateMonthlyPercentages(total, itemSummary) {\n    const monthList = [\n        \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n    ];\n\n    if (!total || total === 0 || !itemSummary || itemSummary.length === 0) {\n        // Equal distribution if no data available\n        return monthList.map(month => ({\n            \"month\": month,\n            \"percentage_allocation\": (100 / 12).toFixed(4)\n        }));\n    }\n\n    let totalCustomRatio = 0;\n    const months = monthList.map((month, index) => {\n        const itemTotal = itemSummary[index]?.total || 0;\n        const percentage = (itemTotal / total) * 100;\n        totalCustomRatio += percentage;\n        \n        return {\n            \"month\": month,\n            \"percentage_allocation\": percentage.toFixed(4)\n        };\n    });\n\n    // Adjust for rounding errors - add remaining percentage to last month\n    if (totalCustomRatio < 100) {\n        const remainingPercentage = 100 - totalCustomRatio;\n        const lastMonthIndex = months.length - 1;\n        months[lastMonthIndex].percentage_allocation = \n            (parseFloat(months[lastMonthIndex].percentage_allocation) + remainingPercentage).toFixed(4);\n    }\n\n    return months;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 0,
  "modified": "2025-07-27 03:06:43.615681",
  "module": "AlphaX Budget",
  "name": "Create Monthly Distribution",
  "script": "frappe.ui.form.on(\"Budget Request\", {\n    refresh: function(frm) {\n        console.log(\"Workflow State:\", frm.doc.workflow_state);\n        console.log(\"Selected Workflow Action:\", frm.selected_workflow_action);\n    },\n\n    validate: function(frm) {\n        // Only run validation for specific workflow states if needed\n        // Uncomment and modify the condition below as per your workflow requirements\n        // if (frm.doc.workflow_state === \"مراجعة المدير التنفيذي\" && frm.selected_workflow_action === \"Approve\") {\n            return validateBudgetRequest(frm);\n        // }\n    }\n});\n\n/**\n * Validates the Budget Request form before submission\n * @param {Object} frm - The form object\n * @returns {boolean} - Returns false if validation fails\n */\nfunction validateBudgetRequest(frm) {\n    console.log(\"Validating Budget Request form on submit.\");\n\n    try {\n        // Validate Cost Center\n        if (!validateCostCenter(frm)) return false;\n        \n        // Validate Budget Items\n        if (!validateBudgetItems(frm)) return false;\n        \n        // Create budget and monthly distributions\n        createBudgetWithDistributions(frm);\n        \n        return true;\n    } catch (error) {\n        console.error(\"Validation error:\", error);\n        frappe.throw(\"An error occurred during validation. Please try again.\");\n        return false;\n    }\n}\n\n/**\n * Validates that Cost Center is selected\n * @param {Object} frm - The form object\n * @returns {boolean} - Returns true if valid\n */\nfunction validateCostCenter(frm) {\n    if (!frm.doc.cost_center) {\n        frappe.throw(__(\"Please select a Cost Center before submitting the form.\"));\n        return false;\n    }\n    return true;\n}\n\n/**\n * Validates budget items for required fields and accepted items\n * @param {Object} frm - The form object\n * @returns {boolean} - Returns true if valid\n */\nfunction validateBudgetItems(frm) {\n    if (!frm.doc.budget_items_details || frm.doc.budget_items_details.length === 0) {\n        frappe.throw(__(\"Please add at least one budget item.\"));\n        return false;\n    }\n\n    // Check for accepted items\n    const acceptedItems = frm.doc.budget_items_details.filter(item => item.status === \"Accepted\");\n    if (acceptedItems.length === 0) {\n        frappe.throw(__(\"Please accept at least one item before submitting the form.\"));\n        return false;\n    }\n\n    // Validate each row has required fields\n    const invalidRows = frm.doc.budget_items_details.filter(item => \n        !item.expense_account || !item.expected_price || item.expected_price <= 0\n    );\n\n    if (invalidRows.length > 0) {\n        frappe.throw(__(\"Please ensure each row has a valid expense account and expected price greater than 0.\"));\n        return false;\n    }\n\n    return true;\n}\n\n/**\n * Creates budget document with monthly distributions\n * @param {Object} frm - The form object\n */\nasync function createBudgetWithDistributions(frm) {\n    try {\n        frappe.show_progress(__(\"Creating Budget\"), 0, 100, __(\"Preparing data...\"));\n        \n        // Create monthly distributions for each accepted item\n        const monthlyDistributions = await createMonthlyDistributions(frm);\n        \n        frappe.show_progress(__(\"Creating Budget\"), 50, 100, __(\"Creating budget...\"));\n        \n        // Create the main budget document\n        const budget = await createBudgetDocument(frm, monthlyDistributions);\n        \n        // Create overall monthly distribution\n        const overallDistribution = await createOverallMonthlyDistribution(frm);\n        \n        // Link overall distribution to budget\n        await frappe.db.set_value('Budget', budget.name, 'monthly_distribution', overallDistribution.name);\n        \n        frappe.show_progress(__(\"Creating Budget\"), 100, 100, __(\"Completed!\"));\n        frappe.hide_progress();\n        \n        frappe.show_alert({\n            message: __(\"Budget created successfully with reference: {0}\", [budget.name]),\n            indicator: 'green'\n        });\n        \n        console.log(\"Budget creation completed:\", budget.name);\n        \n    } catch (error) {\n        frappe.hide_progress();\n        console.error(\"Error creating budget:\", error);\n        frappe.throw(__(\"Error creating budget: {0}\", [error.message || error]));\n    }\n}\n\n/**\n * Creates monthly distribution documents for each budget item\n * @param {Object} frm - The form object\n * @returns {Array} - Array of created monthly distributions\n */\nasync function createMonthlyDistributions(frm) {\n    const monthList = [\n        \"january\", \"february\", \"march\", \"april\", \"may\", \"june\",\n        \"july\", \"august\", \"september\", \"october\", \"november\", \"december\"\n    ];\n\n    const distributions = [];\n    const acceptedItems = frm.doc.budget_items_details.filter(item => item.status === \"Accepted\");\n\n    for (const item of acceptedItems) {\n        const monthlyDistribution = frappe.model.get_new_doc(\"Monthly Distribution\");\n        monthlyDistribution.distribution_id = `${frm.doc.name}-${item.idx}`;\n        monthlyDistribution.fiscal_year = frm.doc.fiscal_year;\n\n        // Calculate percentages for each month based on total value\n        const itemTotal = parseFloat(item.total || item.expected_price || 0);\n        const percentages = monthList.map(month => {\n            const monthQuantity = parseFloat(item[month] || 0);\n            const monthValue = monthQuantity * parseFloat(item.expected_price || 0);\n            const percentage = itemTotal > 0 ? (monthValue / itemTotal) * 100 : 0;\n            \n            return {\n                \"month\": month.charAt(0).toUpperCase() + month.slice(1),\n                \"percentage_allocation\": parseFloat(percentage.toFixed(4))\n            };\n        });\n\n        monthlyDistribution.percentages = percentages;\n\n        // Verify percentages sum to 100%\n        const totalPercentage = percentages.reduce((sum, p) => sum + p.percentage_allocation, 0);\n        console.log(`Item ${item.idx} - Total percentage: ${totalPercentage.toFixed(4)}%`);\n        \n        // Normalize if needed\n        if (Math.abs(totalPercentage - 100) > 0.01 && totalPercentage > 0) {\n            const normalizationFactor = 100 / totalPercentage;\n            percentages.forEach(p => {\n                p.percentage_allocation = parseFloat((p.percentage_allocation * normalizationFactor).toFixed(4));\n            });\n            console.log(`Item ${item.idx} - Normalized percentages`);\n        }\n\n        try {\n            const doc = await frappe.db.insert(monthlyDistribution);\n            distributions.push({\n                account: item.expense_account,\n                name: doc.name,\n                amount: item.total || item.expected_price\n            });\n            console.log(\"Monthly Distribution created:\", doc.name);\n        } catch (error) {\n            console.error(\"Error creating monthly distribution:\", error);\n            throw new Error(`Failed to create monthly distribution for item ${item.idx}`);\n        }\n    }\n\n    return distributions;\n}\n\n/**\n * Creates the main budget document\n * @param {Object} frm - The form object\n * @param {Array} monthlyDistributions - Array of monthly distributions\n * @returns {Object} - Created budget document\n */\nasync function createBudgetDocument(frm, monthlyDistributions) {\n    // Group distributions by account and sum amounts\n    const accountBudgets = {};\n    monthlyDistributions.forEach(dist => {\n        if (accountBudgets[dist.account]) {\n            accountBudgets[dist.account].budget_amount += dist.amount;\n        } else {\n            accountBudgets[dist.account] = {\n                account: dist.account,\n                monthly_distribution: dist.name,\n                budget_amount: dist.amount\n            };\n        }\n    });\n\n    const budget = frappe.model.get_new_doc(\"Budget\");\n    alphax_budget.alphax_budgett_against = \"Cost Center\";\n    budget.cost_center = frm.doc.cost_center;\n    budget.fiscal_year = frm.doc.fiscal_year;\n    budget.applicable_on_material_request = 1;\n    budget.applicable_on_purchase_order = 1;\n    budget.applicable_on_booking_actual_expenses = 1;\n    budget.action_if_annual_budget_exceeded_on_mr = \"Stop\";\n    budget.action_if_annual_budget_exceeded_on_po = \"Stop\";\n    budget.action_if_accumulated_monthly_budget_exceeded_on_mr = \"Warn\";\n    budget.action_if_accumulated_monthly_budget_exceeded_on_po = \"Warn\";\n    budget.custom_budget_request_reference = frm.doc.name;\n    budget.accounts = Object.values(accountBudgets);\n\n    console.log(\"Budget document to be created:\", budget);\n\n    return await frappe.db.insert(budget);\n}\n\n/**\n * Creates overall monthly distribution for the budget\n * @param {Object} frm - The form object  \n * @returns {Object} - Created monthly distribution document\n */\nasync function createOverallMonthlyDistribution(frm) {\n    const monthlyDistribution = frappe.model.get_new_doc(\"Monthly Distribution\");\n    monthlyDistribution.distribution_id = frm.doc.name;\n    monthlyDistribution.fiscal_year = frm.doc.fiscal_year;\n    \n    // Use the existing getMonths function or create a simplified version\n    const total = frm.doc.total || 0;\n    const itemSummary = frm.doc.item_summary || [];\n    \n    monthlyDistribution.percentages = calculateMonthlyPercentages(total, itemSummary);\n    \n    console.log(\"Overall Monthly Distribution document:\", monthlyDistribution);\n    \n    return await frappe.db.insert(monthlyDistribution);\n}\n\n/**\n * Calculates monthly percentage allocations based on actual values\n * @param {number} total - Total budget amount\n * @param {Array} itemSummary - Array of monthly summaries with totals\n * @returns {Array} - Array of monthly percentages\n */\nfunction calculateMonthlyPercentages(total, itemSummary) {\n    const monthList = [\n        \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n    ];\n\n    if (!total || total === 0) {\n        // Equal distribution if no total available\n        const equalPercentage = (100 / 12).toFixed(4);\n        return monthList.map(month => ({\n            \"month\": month,\n            \"percentage_allocation\": equalPercentage\n        }));\n    }\n\n    // If no item summary, try to get data from accepted budget items\n    if (!itemSummary || itemSummary.length === 0) {\n        const equalPercentage = (100 / 12).toFixed(4);\n        return monthList.map(month => ({\n            \"month\": month,\n            \"percentage_allocation\": equalPercentage\n        }));\n    }\n\n    let calculatedTotal = 0;\n    const months = monthList.map((month, index) => {\n        // Get the actual monetary value for this month (not just quantity)\n        const monthlyTotal = parseFloat(itemSummary[index]?.total || 0);\n        const percentage = total > 0 ? (monthlyTotal / total) * 100 : 0;\n        calculatedTotal += percentage;\n        \n        return {\n            \"month\": month,\n            \"percentage_allocation\": parseFloat(percentage.toFixed(4))\n        };\n    });\n\n    // Normalize percentages to ensure they sum to 100%\n    if (calculatedTotal > 0 && Math.abs(calculatedTotal - 100) > 0.01) {\n        const normalizationFactor = 100 / calculatedTotal;\n        months.forEach(month => {\n            month.percentage_allocation = parseFloat(\n                (month.percentage_allocation * normalizationFactor).toFixed(4)\n            );\n        });\n    } else if (calculatedTotal === 0) {\n        // If all months are zero, distribute equally\n        const equalPercentage = (100 / 12).toFixed(4);\n        months.forEach(month => {\n            month.percentage_allocation = parseFloat(equalPercentage);\n        });\n    }\n\n    return months;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 0,
  "modified": "2025-08-13 20:50:16.200961",
  "module": "AlphaX Budget",
  "name": "Build Budget and monthly distributions",
  "script": "frappe.ui.form.on(\"Budget Request\", {\n    refresh: function(frm) {\n        console.log(\"Workflow State:\", frm.doc.workflow_state);\n        console.log(\"Selected Workflow Action:\", frm.selected_workflow_action);\n        \n        // Reset the budget creation flag on refresh\n        frm._budget_creation_in_progress = false;\n    },\n\n    validate: function(frm) {\n        // Prevent multiple budget creations\n        if (frm._budget_creation_in_progress) {\n            console.log(\"Budget creation already in progress, skipping...\");\n            return true;\n        }\n\n        // Only run validation for specific workflow states if needed\n        // if (frm.doc.workflow_state === \"مراجعة المدير التنفيذي\" && frm.selected_workflow_action === \"Approve\") {\n            return validateBudgetRequest(frm);\n        // }\n    }\n});\n\n/**\n * Validates the Budget Request form before submission\n * @param {Object} frm - The form object\n * @returns {boolean} - Returns false if validation fails\n */\nasync function validateBudgetRequest(frm) {\n    console.log(\"Validating Budget Request form on submit.\");\n\n    try {\n        // Validate Cost Center\n        if (!validateCostCenter(frm)) return false;\n        \n        // Validate Budget Items\n        if (!validateBudgetItems(frm)) return false;\n        \n        // Check if budget already exists for this request\n        if (frm.doc.budget_created) {\n            console.log(\"Budget already created for this request\");\n            frappe.show_alert({\n                message: __(\"Budget already exists for this request\"),\n                indicator: 'orange'\n            });\n            return true;\n        }\n        \n        // Check for existing budgets before creating new one\n        const duplicateFound = await checkForDuplicateBudgets(frm);\n        if (duplicateFound) {\n            return false; // Stop validation if duplicate found\n        }\n        \n        // Set flag to prevent multiple creations\n        frm._budget_creation_in_progress = true;\n        \n        // Create budget and monthly distributions\n        await createBudgetWithDistributions(frm);\n        \n        return true;\n    } catch (error) {\n        console.error(\"Validation error:\", error);\n        frm._budget_creation_in_progress = false;\n        \n        // Check if it's a duplicate budget error\n        if (error.message && error.message.includes(\"already exists\")) {\n            frappe.show_alert({\n                message: error.message,\n                indicator: 'red'\n            });\n        } else {\n            frappe.throw(\"An error occurred during validation. Please try again.\");\n        }\n        return false;\n    }\n}\n\n/**\n * Checks for duplicate budgets before creating new ones\n * @param {Object} frm - The form object\n * @returns {boolean} - Returns true if duplicate found\n */\nasync function checkForDuplicateBudgets(frm) {\n    try {\n        const acceptedItems = frm.doc.budget_items_details.filter(item => item.status === \"Accepted\");\n        const fiscalYear = frm.doc.fiscal_year;\n        const costCenter = frm.doc.cost_center;\n        \n        // Check each accepted item's account for duplicate budgets\n        for (let item of acceptedItems) {\n            const existingBudget = await frappe.call({\n                method: \"alphax_budget.alphax_budget.api.budget.check_budget_account_exists\",\n                args: {\n                    cost_center: costCenter,\n                    fiscal_year: fiscalYear,\n                    account: item.expense_account\n                }\n            });\n\n            if (existingBudget && existingBudget.message) {\n                const message = __(\"Budget already exists: '{0}' for Cost Center '{1}', Account '{2}' in Fiscal Year {3}. Cannot create duplicate budget.\", \n                    [existingBudget.message, costCenter, item.expense_account, fiscalYear]);\n                \n                // إعادة تعيين حالة الـ workflow\n                frm.set_value(\"workflow_state\", \"save\");\n                \n                // عرض رسالة مفصلة\n                frappe.msgprint({\n                    title: __(\"Duplicate Budget Found\"),\n                    message: message,\n                    indicator: 'red'\n                });\n                \n                frappe.show_alert({\n                    message: __(\"Duplicate budget detected - operation cancelled\"),\n                    indicator: 'red'\n                });\n                \n                return true;\n            }\n        }\n        \n        return false; // No duplicates found\n    } catch (error) {\n        console.error(\"Error checking for duplicate budgets:\", error);\n        \n        // إعادة تعيين حالة الـ workflow عند الخطأ\n        frm.set_value(\"workflow_state\", \"save\");\n        \n        frappe.msgprint({\n            title: __(\"Error Checking Budgets\"),\n            message: __(\"An error occurred while checking for duplicate budgets: {0}\", [error.message || error]),\n            indicator: 'red'\n        });\n        \n        throw error;\n    }\n}\n\n/**\n * Validates that Cost Center is selected\n * @param {Object} frm - The form object\n * @returns {boolean} - Returns true if valid\n */\nfunction validateCostCenter(frm) {\n    if (!frm.doc.cost_center) {\n        frappe.throw(__(\"Please select a Cost Center before submitting the form.\"));\n        return false;\n    }\n    return true;\n}\n\n/**\n * Validates budget items for required fields and accepted items\n * @param {Object} frm - The form object\n * @returns {boolean} - Returns true if valid\n */\nfunction validateBudgetItems(frm) {\n    if (!frm.doc.budget_items_details || frm.doc.budget_items_details.length === 0) {\n        frappe.throw(__(\"Please add at least one budget item.\"));\n        return false;\n    }\n\n    // Check for accepted items\n    const acceptedItems = frm.doc.budget_items_details.filter(item => item.status === \"Accepted\");\n    if (acceptedItems.length === 0) {\n        frappe.throw(__(\"Please accept at least one item before submitting the form.\"));\n        return false;\n    }\n\n    // Validate each row has required fields\n    const invalidRows = frm.doc.budget_items_details.filter(item => \n        !item.expense_account || !item.expected_price || item.expected_price <= 0\n    );\n\n    if (invalidRows.length > 0) {\n        frappe.throw(__(\"Please ensure each row has a valid expense account and expected price greater than 0.\"));\n        return false;\n    }\n\n    return true;\n}\n\n/**\n * Creates budget document with monthly distributions\n * @param {Object} frm - The form object\n */\nasync function createBudgetWithDistributions(frm) {\n    try {\n        // Double check for existing distribution and budget\n        const existingDistribution = await frappe.db.get_list(\"Monthly Distribution\", {\n            filters: { distribution_id: frm.doc.name },\n            limit: 1\n        });\n        \n        if (existingDistribution && existingDistribution.length > 0) {\n            console.log(\"Monthly Distribution already exists:\", existingDistribution[0].name);\n            \n            // Check if budget already exists\n            const existingBudget = await frappe.db.get_list(\"Budget\", {\n                filters: { custom_budget_request_reference: frm.doc.name },\n                limit: 1\n            });\n            \n            if (existingBudget && existingBudget.length > 0) {\n                console.log(\"Budget already exists:\", existingBudget[0].name);\n                \n                // Reset workflow state and show message\n                frm.set_value(\"workflow_state\", \"save\");\n                frm._budget_creation_in_progress = false;\n                \n                frappe.show_alert({\n                    message: __(\"Budget already exists for this request: {0}\", [existingBudget[0].name]),\n                    indicator: 'orange'\n                });\n                \n                frappe.msgprint({\n                    title: __(\"Budget Already Exists\"),\n                    message: __(\"A budget has already been created for this request: {0}. Please check existing budgets.\", [existingBudget[0].name]),\n                    indicator: 'orange'\n                });\n                \n                return;\n            }\n        }\n        \n        frappe.show_progress(__(\"Creating Budget\"), 0, 100, __(\"Preparing data...\"));\n        \n        // Create single monthly distribution for the entire budget\n        const monthlyDistribution = await createMonthlyDistribution(frm);\n        \n        frappe.show_progress(__(\"Creating Budget\"), 50, 100, __(\"Creating budget...\"));\n        \n        // Prepare account budgets from accepted items\n        const accountBudgets = prepareAccountBudgets(frm, monthlyDistribution.name);\n        \n        // Create the main budget document (with duplicate check inside)\n        const budget = await createBudgetDocument(frm, accountBudgets, monthlyDistribution.name);\n        \n        // Mark budget as created in the request document\n        await frappe.db.set_value('Budget Request', frm.doc.name, 'budget_created', 1);\n        \n        frappe.show_progress(__(\"Creating Budget\"), 100, 100, __(\"Completed!\"));\n        frappe.hide_progress();\n        \n        // Reset the flag\n        frm._budget_creation_in_progress = false;\n        \n        frappe.show_alert({\n            message: __(\"Budget created successfully with reference: {0}\", [budget.name]),\n            indicator: 'green'\n        });\n        \n        console.log(\"Budget creation completed:\", budget.name);\n        \n    } catch (error) {\n        // إزالة شريط التقدم فوراً\n        frappe.hide_progress();\n        frm._budget_creation_in_progress = false;\n        console.error(\"Error creating budget:\", error);\n        \n        // إعادة تعيين حالة الـ workflow إلى save\n        frm.set_value(\"workflow_state\", \"save\");\n        \n        // معالجة أنواع الأخطاء المختلفة\n        if (error.message && error.message.includes(\"already exists\")) {\n            // رسالة مفصلة للتكرار\n            frappe.msgprint({\n                title: __(\"Duplicate Budget Found\"),\n                message: __(\"Cannot create budget because: {0}\", [error.message]),\n                indicator: 'red'\n            });\n            \n            frappe.show_alert({\n                message: __(\"Budget creation stopped - duplicate found\"),\n                indicator: 'red'\n            });\n            \n        } else if (error.message === \"Duplicate Budget\") {\n            // رسالة عامة للتكرار\n            frappe.msgprint({\n                title: __(\"Duplicate Budget\"),\n                message: __(\"A budget with the same configuration already exists. Please check existing budgets before creating a new one.\"),\n                indicator: 'red'\n            });\n            \n            frappe.show_alert({\n                message: __(\"Cannot create budget - duplicate exists\"),\n                indicator: 'red'\n            });\n            \n        } else {\n            // رسالة لأخطاء أخرى\n            frappe.msgprint({\n                title: __(\"Budget Creation Error\"),\n                message: __(\"An error occurred while creating the budget: {0}\", [error.message || error]),\n                indicator: 'red'\n            });\n            \n            frappe.show_alert({\n                message: __(\"Budget creation failed\"),\n                indicator: 'red'\n            });\n        }\n        \n        // منع إرسال النموذج\n        throw error;\n    }\n}\n\n/**\n * Creates a single monthly distribution document for the entire budget\n * @param {Object} frm - The form object\n * @returns {Object} - Created monthly distribution document\n */\nasync function createMonthlyDistribution(frm) {\n    // Check if already exists first\n    const existingDistribution = await frappe.db.get_list(\"Monthly Distribution\", {\n        filters: { distribution_id: frm.doc.name },\n        limit: 1\n    });\n    \n    if (existingDistribution && existingDistribution.length > 0) {\n        console.log(\"Using existing Monthly Distribution:\", existingDistribution[0].name);\n        return { name: existingDistribution[0].name };\n    }\n\n    const monthlyDistribution = frappe.model.get_new_doc(\"Monthly Distribution\");\n    monthlyDistribution.distribution_id = frm.doc.name;\n    monthlyDistribution.fiscal_year = frm.doc.fiscal_year;\n    \n    // Calculate monthly percentages based on all accepted items\n    const monthlyPercentages = calculateMonthlyPercentagesFromItems(frm);\n    monthlyDistribution.percentages = monthlyPercentages;\n    \n    console.log(\"Monthly Distribution document:\", monthlyDistribution);\n    \n    try {\n        const doc = await frappe.db.insert(monthlyDistribution);\n        console.log(\"Monthly Distribution created:\", doc.name);\n        return doc;\n    } catch (error) {\n        console.error(\"Error creating monthly distribution:\", error);\n        throw new Error(\"Failed to create monthly distribution\");\n    }\n}\n\n/**\n * Prepares account budgets from accepted budget items\n * @param {Object} frm - The form object\n * @param {string} monthlyDistributionName - Name of the monthly distribution\n * @returns {Array} - Array of account budget objects\n */\nfunction prepareAccountBudgets(frm, monthlyDistributionName) {\n    const accountTotals = {};\n    \n    // Sum up amounts by expense account for accepted items only\n    frm.doc.budget_items_details.forEach(item => {\n        if (item.status === \"Accepted\") {\n            const itemTotal = parseFloat(item.total || item.expected_price || 0);\n            if (accountTotals[item.expense_account]) {\n                accountTotals[item.expense_account] += itemTotal;\n            } else {\n                accountTotals[item.expense_account] = itemTotal;\n            }\n        }\n    });\n    \n    // Convert to array format expected by Budget doctype\n    return Object.entries(accountTotals).map(([account, amount]) => ({\n        \"account\": account,\n        \"budget_amount\": amount,\n        \"custom_monthly_distribution\": monthlyDistributionName\n    }));\n}\n\n/**\n * Calculates monthly percentage allocations from budget items\n * @param {Object} frm - The form object\n * @returns {Array} - Array of monthly percentages\n */\nfunction calculateMonthlyPercentagesFromItems(frm) {\n    const monthList = [\n        \"january\", \"february\", \"march\", \"april\", \"may\", \"june\",\n        \"july\", \"august\", \"september\", \"october\", \"november\", \"december\"\n    ];\n    \n    const monthNames = [\n        \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n    ];\n\n    // Calculate total monthly amounts from all accepted items\n    const monthlyTotals = {};\n    let grandTotal = 0;\n    \n    monthList.forEach(month => {\n        monthlyTotals[month] = 0;\n    });\n    \n    // Sum up monthly amounts from accepted items\n    frm.doc.budget_items_details.forEach(item => {\n        if (item.status === \"Accepted\") {\n            const itemPrice = parseFloat(item.expected_price || 0);\n            monthList.forEach(month => {\n                const monthQuantity = parseFloat(item[month] || 0);\n                const monthValue = monthQuantity * itemPrice;\n                monthlyTotals[month] += monthValue;\n                grandTotal += monthValue;\n            });\n        }\n    });\n    \n    console.log(\"Monthly totals:\", monthlyTotals);\n    console.log(\"Grand total:\", grandTotal);\n    \n    // Calculate percentages\n    let calculatedTotal = 0;\n    const percentages = monthNames.map((monthName, index) => {\n        const monthKey = monthList[index];\n        const monthTotal = monthlyTotals[monthKey];\n        const percentage = grandTotal > 0 ? (monthTotal / grandTotal) * 100 : (100 / 12);\n        calculatedTotal += percentage;\n        \n        return {\n            \"month\": monthName,\n            \"percentage_allocation\": parseFloat(percentage.toFixed(4))\n        };\n    });\n    \n    // Normalize to ensure total is exactly 100%\n    if (Math.abs(calculatedTotal - 100) > 0.01 && calculatedTotal > 0) {\n        const normalizationFactor = 100 / calculatedTotal;\n        percentages.forEach(p => {\n            p.percentage_allocation = parseFloat((p.percentage_allocation * normalizationFactor).toFixed(4));\n        });\n        console.log(\"Percentages normalized\");\n    }\n    \n    console.log(\"Final percentages:\", percentages);\n    return percentages;\n}\n\n/**\n * Creates the main budget document with enhanced duplicate checking\n * @param {Object} frm - The form object\n * @param {Array} accountBudgets - Array of account budget objects\n * @param {string} monthlyDistributionName - Name of the monthly distribution document\n * @returns {Object} - Created budget document\n */\nasync function createBudgetDocument(frm, accountBudgets, monthlyDistributionName) {\n    const fiscalYear = frm.doc.fiscal_year;\n    const costCenter = frm.doc.cost_center;\n    \n    // Final check for duplicate budgets before creating\n    for (let accountObj of accountBudgets) {\n        try {\n            const existingBudgetResponse = await frappe.call({\n                method: \"alphax_budget.alphax_budget.api.budget.check_budget_account_exists\",\n                args: {\n                    cost_center: costCenter,\n                    fiscal_year: fiscalYear,\n                    account: accountObj.account\n                }\n            });\n\n            const existingBudgetName = existingBudgetResponse.message;\n            \n            if (existingBudgetName) {\n                const errorMessage = __(\"Budget '{0}' already exists for Cost Center '{1}', Account '{2}' in Fiscal Year {3}. Cannot create duplicate budget.\", \n                    [existingBudgetName, costCenter, accountObj.account, fiscalYear]);\n                \n                console.error(\"Duplicate budget found:\", errorMessage);\n                \n                // إزالة شريط التقدم وإعادة تعيين الحالة\n                frappe.hide_progress();\n                frm.set_value(\"workflow_state\", \"save\");\n                \n                // عرض رسالة مفصلة\n                frappe.msgprint({\n                    title: __(\"Duplicate Budget Found\"),\n                    message: errorMessage,\n                    indicator: 'red'\n                });\n                \n                frappe.show_alert({\n                    message: __(\"Budget creation cancelled - duplicate found\"),\n                    indicator: 'red'\n                });\n                \n                throw new Error(errorMessage);\n            }\n        } catch (error) {\n            console.error(\"Error checking budget existence:\", error);\n            \n            // إزالة شريط التقدم وإعادة تعيين الحالة عند الخطأ\n            frappe.hide_progress();\n            frm.set_value(\"workflow_state\", \"save\");\n            \n            throw error;\n        }\n    }\n    \n    // Create Budget if no duplicates found\n    const budget = frappe.model.get_new_doc(\"Budget\");\n    alphax_budget.alphax_budgett_against = \"Cost Center\";\n    budget.cost_center = frm.doc.cost_center;\n    budget.fiscal_year = frm.doc.fiscal_year;\n    budget.monthly_distribution = monthlyDistributionName;\n    budget.custom_budget_source = frm.doc.budget_control;\n    budget.applicable_on_material_request = 1;\n    budget.applicable_on_purchase_order = 1;\n    budget.applicable_on_booking_actual_expenses = 1;\n    budget.action_if_annual_budget_exceeded_on_mr = \"Stop\";\n    budget.action_if_annual_budget_exceeded_on_po = \"Stop\";\n    budget.action_if_accumulated_monthly_budget_exceeded_on_mr = \"Warn\";\n    budget.action_if_accumulated_monthly_budget_exceeded_on_po = \"Warn\";\n    budget.custom_budget_request_reference = frm.doc.name;\n    budget.accounts = accountBudgets;\n\n    console.log(\"Budget document to be created:\", budget);\n\n    try {\n        return await frappe.db.insert(budget);\n    } catch (error) {\n        console.error(\"Error inserting budget:\", error);\n        \n        // إزالة شريط التقدم وإعادة تعيين الحالة\n        frappe.hide_progress();\n        frm.set_value(\"workflow_state\", \"save\");\n        \n        // Check if it's a duplicate error from database level\n        if (error.message && (error.message.includes(\"duplicate\") || error.message.includes(\"already exists\"))) {\n            frappe.msgprint({\n                title: __(\"Database Error\"),\n                message: __(\"A duplicate budget was detected at the database level. Please refresh and try again.\"),\n                indicator: 'red'\n            });\n            \n            throw new Error(\"Duplicate Budget\");\n        }\n        \n        frappe.msgprint({\n            title: __(\"Budget Creation Error\"),\n            message: __(\"Failed to create budget: {0}\", [error.message || error]),\n            indicator: 'red'\n        });\n        \n        throw error;\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 0,
  "modified": "2025-07-29 01:47:25.959924",
  "module": "AlphaX Budget",
  "name": "Apply Budget Policy On PO",
  "script": "frappe.ui.form.on(\"Purchase Order\", {\nvalidate(frm) {\n\n        // if (frm.doc.workflow_state === 'مراجعة المدير المالي') {\n            // if(frm.selected_workflow_action === \"Approve\"){\n            //  console.log(frm.selected_workflow_action ,frm.doc.workflow_state === \"مراجعة المدير المالي\");\n            \n        const transactionDate =cur_frm.doc.transaction_date;\n        const itemsTable =cur_frm.doc.items;\n        if (!transactionDate){\n            frappe.msgprint({\n                title:__(`Transaction Date`),\n                message:__(`Transaction Date is Empty`),\n                indicator:'orange',\n            })\n            frappe.validated = false;\n            cur_frm.scroll_to_field('transaction_date')\n            return false;\n        }\n        if (!itemsTable){\n            frappe.msgprint({\n                title:__(`Items Table`),\n                message:__(`Table of Purchase Order is Empty`),\n                indicator:'orange',\n            })\n            frappe.validated = false;\n            cur_frm.scroll_to_field('items')\n            return false;\n        }\n        \n       \n},\n    async after_save(frm) {\n        if (frappe.validated === true) {\n            try {\n                let poResults = await get_po(frm);\n                let updatedResults = mergeCurrentItemsIntoResults(poResults, cur_frm.doc.items);\n                console.log(\"✅ Updated Results:\", updatedResults);\n                \n                let PO_year = cur_frm.doc.transaction_date.split('-')[0];\n                let budget = await get_budget(updatedResults, PO_year);\n                console.log(\"✅ budget:\", budget);\n                \n                let monthlyDistr = await get_monthly_distribution(frm, budget);\n                console.log(\"✅ monthlyDistr:\", monthlyDistr);\n                await checkMonthlyBudgetWarnings(frm, updatedResults, monthlyDistr);\n\n                \n            } catch (error) {\n                console.error(\"Error in after_save:\", error);\n            }\n        }\n    }\n             \n});\n\nasync function get_po(frm) {\n    let results = {}; // Object to store totals by expense account\n    let today = new Date(frm.doc.transaction_date);\n    let startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);\n    let endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);\n\n    try {\n        let purchaseOrders = await new Promise((resolve, reject) => {\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"Purchase Order\",\n                    limit_page_length: 1000000,\n                    fields: [\"name\"],\n                    filters: [\n                        [\"docstatus\", \"=\", 1],\n                        [\"transaction_date\", \">=\", startOfMonth],\n                        [\"transaction_date\", \"<\", endOfMonth],\n                    ],\n                },\n                callback: function (r) {\n                    r.message ? resolve(r.message) : reject(\"Failed to fetch Purchase Orders.\");\n                }\n            });\n        });\n\n        if (purchaseOrders.length > 0) {\n            let responses = await Promise.all(purchaseOrders.map(order =>\n                new Promise((resolve, reject) => {\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: {\n                            doctype: \"Purchase Order\",\n                            name: order.name,\n                            fields: [\"items\"],\n                        },\n                        callback: function (r) {\n                            r.message ? resolve(r.message) : reject(\"Failed to fetch Purchase Order details.\");\n                        }\n                    });\n                })\n            ));\n\n            responses.forEach(response => {\n                let allPurchaseOrderItems = response.items || [];\n                allPurchaseOrderItems.forEach(item => {\n                    let amount = item.amount || 0;\n                    let expenseAccount = item.expense_account || '';\n                    let costCenter = item.cost_center || '';\n                    let itemCode = item.item_code || '';\n            \n                    if (expenseAccount && costCenter && itemCode) {\n                        if (!results[costCenter]) {\n                            results[costCenter] = {};\n                        }\n                        if (!results[costCenter][expenseAccount]) {\n                            results[costCenter][expenseAccount] = {};\n                        }\n                        if (!results[costCenter][expenseAccount][itemCode]) {\n                            results[costCenter][expenseAccount][itemCode] = 0;\n                        }\n                        results[costCenter][expenseAccount][itemCode] += amount;\n                    }\n                });\n            });\n        } else {\n            console.error(\"No Purchase Orders found.\");\n        }\n\n    } catch (error) {\n        console.error(\"Error in get_po function\", error);\n    }\n\n    return results;\n}\nfunction mergeCurrentItemsIntoResults(poResults, currentItems) {\n    let updatedResults = {};\n    let foundMatch = false;\n    \n    currentItems.forEach(item => {\n        let amount = item.amount || 0;\n        let expenseAccount = item.expense_account || '';\n        let costCenter = item.cost_center || '';\n        let itemCode = item.item_code || '';\n         console.log('🔍 checking item:', costCenter, expenseAccount);\n        \n        if (poResults[costCenter] &&\n            poResults[costCenter][expenseAccount] &&\n            poResults[costCenter][expenseAccount][itemCode] !== undefined\n            ) {\n            foundMatch = true;\n            // تأكد إن cost_center موجود في results\n            if (!updatedResults[costCenter]) {\n                updatedResults[costCenter] = {};\n            }\n\n            // تأكد إن expense_account موجود داخل cost_center\n            if (!updatedResults[costCenter][expenseAccount]) {\n                updatedResults[costCenter][expenseAccount] = {};\n            }\n            \n            \n            if (!updatedResults[costCenter][expenseAccount][itemCode]) {\n                updatedResults[costCenter][expenseAccount][itemCode] = 0;\n            }\n\n            // زود القيمة من المستند الحالي\n            updatedResults[costCenter][expenseAccount][itemCode] =\n                poResults[costCenter][expenseAccount][itemCode] + amount;\n        }\n    });\n\n    return foundMatch ? updatedResults : {};\n}\nasync function get_budget(updatedResults, PO_year) {\n    let budgetDetails = [];\n    console.log(\"🧾 updatedResults:\", updatedResults);\n\n    // التحقق من صحة المدخلات\n    if (!updatedResults || typeof updatedResults !== 'object') {\n        console.error(\"❌ updatedResults is not valid\");\n        return [];\n    }\n\n    try {\n        for (let costCenter in updatedResults) {\n            console.log(`🔍 Processing cost center: ${costCenter}`);\n            \n            // نجيب البودجيت بتاع الـ cost center ده\n            let budgets = await new Promise((resolve, reject) => {\n                frappe.call({\n                    method: \"frappe.client.get_list\",\n                    args: {\n                        doctype: \"Budget\",\n                        filters: [\n                            [\"docstatus\", \"=\", 1],\n                            [\"fiscal_year\", \"=\", PO_year],\n                            [\"cost_center\", \"=\", costCenter]\n                        ],\n                        fields: [\"name\", \"cost_center\"],\n                        limit_page_length: 50,\n                    },\n                    callback: function (r) {\n                        if (r.message && Array.isArray(r.message)) {\n                            resolve(r.message);\n                        } else {\n                            console.warn(`⚠️ No budgets found for cost center: ${costCenter}`);\n                            resolve([]); // بدلاً من reject\n                        }\n                    }\n                });\n            });\n\n            console.log(`📊 Found ${budgets.length} budgets for cost center: ${costCenter}`);\n\n            for (let budget of budgets) {\n                try {\n                    let fullBudget = await new Promise((resolve, reject) => {\n                        frappe.call({\n                            method: \"alphax_budget.alphax_budget.api.budget.get_budget_with_accounts\",\n                            args: {\n                                doctype: \"Budget\",\n                                budget_name: budget.name\n                            },\n                            callback: function (r) {\n                                if (r.message) {\n                                    resolve(r.message);\n                                } else {\n                                    reject(`❌ Failed to fetch budget details for ${budget.name}`);\n                                }\n                            }\n                        });\n                    });\n                    \n                    console.log(\"💬 fullBudget returned:\", fullBudget);\n                    console.log(\"📌 Full Budget fetched:\", fullBudget.name, fullBudget.accounts?.map(a => a.account));\n\n                    // التحقق من وجود accounts\n                    if (!fullBudget.accounts || !Array.isArray(fullBudget.accounts)) {\n                        console.warn(`⚠️ No accounts found in budget: ${budget.name}`);\n                        continue;\n                    }\n\n                    // التحقق من وجود البيانات في updatedResults\n                    let resultForCostCenter = updatedResults[budget.cost_center];\n                    if (!resultForCostCenter) {\n                        console.warn(`⚠️ No data found in updatedResults for cost center: ${budget.cost_center}`);\n                        continue;\n                    }\n\n                    console.log('📋 Processing budget:', fullBudget.name);\n                    \n                    fullBudget.accounts.forEach((accountRow, index) => {\n                        try {\n                            // التحقق من صحة بيانات الحساب\n                            if (!accountRow.account) {\n                                console.warn(`⚠️ Account missing in row ${index} of budget ${budget.name}`);\n                                return;\n                            }\n\n                            // البحث عن بيانات الحساب في النتائج المحدثة\n                            let accountData = resultForCostCenter[accountRow.account];\n                            \n                            if (accountData) {\n                                console.log(`✅ Found data for account: ${accountRow.account}`);\n                                budgetDetails.push({\n                                    account: accountRow.account,\n                                    budget_monthly: accountRow.budget_amount || 0,\n                                    cost_center: budget.cost_center,\n                                    monthly_distribution: accountRow.custom_monthly_distribution || null,\n                                    parent: budget.name,\n                                    applicable_on_purchase_order: fullBudget.applicable_on_purchase_order || 0,\n                                    action_if__monthly_budget_exceeded_on_po: fullBudget.custom_action_if__monthly_budget_exceeded_on_po || null\n                                });\n                            } else {\n                                console.log(`ℹ️ No matching data found for account: ${accountRow.account} in cost center: ${budget.cost_center}`);\n                            }\n                        } catch (innerError) {\n                            console.error(`💥 Error processing account row ${index}:`, innerError);\n                        }\n                    });\n                    \n                } catch (budgetError) {\n                    console.error(`💥 Error processing budget ${budget.name}:`, budgetError);\n                    continue; // استمر في معالجة باقي البودجيت\n                }\n            }\n        }\n\n        console.log(\"✅ Budget Details:\", budgetDetails);\n        console.log(`📈 Total budget details found: ${budgetDetails.length}`);\n        return budgetDetails;\n\n    } catch (error) {\n        console.error(\"💥 Error in get_budget:\", error);\n        return [];\n    }\n}\n// async function get_budget(updatedResults, PO_year) {\n//     let budgetDetails = [];\n//     console.log(\"🧾 updatedResults:\", updatedResults);\n\n//     try {\n//         for (let costCenter in updatedResults) {\n//             // نجيب البودجيت بتاع الـ cost center ده\n//             let budgets = await new Promise((resolve, reject) => {\n//                 frappe.call({\n//                     method: \"frappe.client.get_list\",\n//                     args: {\n//                         doctype: \"Budget\",\n//                         filters: [\n//                             [\"docstatus\", \"=\", 1],\n//                             [\"fiscal_year\", \"=\", PO_year],\n//                             [\"cost_center\", \"=\", costCenter]\n//                         ],\n//                         fields: [\"name\", \"cost_center\"],\n//                         limit_page_length: 50,\n//                     },\n//                     callback: function (r) {\n//                         r.message ? resolve(r.message) : reject(\"❌ Failed to fetch budgets\");\n//                     }\n//                 });\n//             });\n\n//             for (let budget of budgets) {\n//                 let fullBudget = await new Promise((resolve, reject) => {\n//                     frappe.call({\n//                         method: \"alphax_budget.alphax_budget.api.budget.get_budget_with_accounts\",\n//                         args: {\n//                             doctype: \"Budget\",\n//                             name: budget.name\n//                         },\n//                         callback: function (r) {\n//                             r.message ? resolve(r.message) : reject(\"❌ Failed to fetch budget details\");\n//                         }\n//                     });\n//                 });\n//                 console.log(\"💬 fullBudget returned:\", fullBudget);\n//                 console.log(\"📌 Full Budget fetched:\", fullBudget.name, fullBudget.accounts.map(a => a.account));\n\n//                 if (fullBudget.accounts && Array.isArray(fullBudget.accounts)) {\n//                     console.log('ffffff',fullBudget)\n//                     fullBudget.accounts.forEach(accountRow => {\n//                     // Get matching data from updatedResults\n//                     let result = updatedResults[budget.cost_center];\n//                     let accountData = result && result[accountRow.account];\n                    \n//                     if (accountData) {\n//                         budgetDetails.push({\n//                             account: accountRow.account,\n//                             budget_monthly: accountRow.budget_amount,\n//                             cost_center: budget.cost_center,\n//                             monthly_distribution: accountRow.custom_monthly_distribution || null,\n//                             parent: budget.name,\n//                             applicable_on_purchase_order: fullBudget.applicable_on_purchase_order,\n//                             action_if__monthly_budget_exceeded_on_po: fullBudget.custom_action_if__monthly_budget_exceeded_on_po\n//                         });\n//                     }\n//                 });\n\n//                     // fullBudget.accounts.forEach(accountRow => {\n//                     //     budgetDetails.push({\n//                     //         account: accountRow.account,\n//                     //         budget_monthly: accountRow.budget_amount,\n//                     //         cost_center: budget.cost_center,\n//                     //         monthly_distribution: accountRow.custom_monthly_distribution || null,\n//                     //         parent: budget.name,\n//                     //         applicable_on_purchase_order:fullBudget.applicable_on_purchase_order,\n//                     //         action_if__monthly_budget_exceeded_on_po:fullBudget.custom_action_if__monthly_budget_exceeded_on_po\n                            \n                            \n//                     //     });\n//                     // });\n//                 }\n//             }\n//         }\n\n//         console.log(\"✅ Budget Details:\", budgetDetails);\n//         return budgetDetails;\n\n//     } catch (error) {\n//         console.error(\"💥 Error in get_budget:\", error);\n//         return [];\n//     }\n// }\n\nasync function get_monthly_distribution(frm, budgetDetails) {\n    try {\n        console.log(\"Budget Details:\", budgetDetails);\n        \n        if (!Array.isArray(budgetDetails)) {\n            throw new Error(\"Invalid data format returned from get_budget.\");\n        }\n        \n        let monthList = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \n                        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n        let po_month = new Date(frm.doc.transaction_date);\n        let currentMonthIndex = po_month.getMonth(); // Zero-based index\n\n        let allocatedAmounts = [];\n\n        for (let budget of budgetDetails) {\n            console.log(\"Processing budget account:\", budget);\n\n            // Check if monthly_distribution exists\n            if (!budget.monthly_distribution) {\n                frappe.throw(__(\"No monthly distribution found for budget: {0}\", [budget.parent]));\n                // Use equal distribution (100/12 = 8.33% per month)\n                let allocatedAmount = (alphax_budget.alphax_budgett_monthly || 0) / 12;\n                allocatedAmounts.push({\n                    \"account\": budget.account,\n                    \"cost_center\": budget.cost_center,\n                    \"budget_monthly\": allocatedAmount,\n                    \"parent\": budget.parent,\n                    \"month\": monthList[currentMonthIndex]\n                });\n                continue;\n            }\n\n            try {\n                let monthlyDistResponse = await new Promise((resolve, reject) => {\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: {\n                            doctype: \"Monthly Distribution\",\n                            name: budget.monthly_distribution,\n                            fields: [\"percentages\"],\n                        },\n                        callback: function (r) {\n                            if (r.message) {\n                                resolve(r.message);\n                            } else {\n                                reject(\"Failed to fetch monthly distribution.\");\n                            }\n                        }\n                    });\n                });\n\n                let percentages = monthlyDistResponse.percentages || [];\n                \n                // Find the percentage for current month\n                let currentMonthPercentage = 0;\n                percentages.forEach(row => {\n                    if (row.month === monthList[currentMonthIndex]) {\n                        currentMonthPercentage = row.percentage_allocation || 0;\n                    }\n                });\n\n                let allocatedAmount = (currentMonthPercentage * (alphax_budget.alphax_budgett_monthly || 0)) / 100;\n                \n                allocatedAmounts.push({\n                    \"account\": budget.account,\n                    \"applicable_on_purchase_order\": budget.applicable_on_purchase_order || 0,\n                    \"action\": budget.action_if__monthly_budget_exceeded_on_po || null,\n                    \"cost_center\": budget.cost_center,\n                    \"budget_monthly\": allocatedAmount,\n                    \"parent\": budget.parent,\n                    \"month\": monthList[currentMonthIndex],\n                    \"percentage\": currentMonthPercentage\n                });\n\n            } catch (distError) {\n                console.error(\"Error fetching monthly distribution for:\", budget.monthly_distribution, distError);\n                // Fallback to equal distribution\n                let allocatedAmount = (alphax_budget.alphax_budgett_monthly || 0) / 12;\n                allocatedAmounts.push({\n                    \"account\": budget.account,\n                    \"cost_center\": budget.cost_center,\n                    \"budget_monthly\": allocatedAmount,\n                    \"parent\": budget.parent,\n                    \"month\": monthList[currentMonthIndex],\n                    \"fallback\": true\n                });\n            }\n        }\n\n        console.log(\"Final Allocated Amounts:\", allocatedAmounts);\n        return allocatedAmounts;\n\n    } catch (error) {\n        console.error(\"Error in get_monthly_distribution:\", error);\n        throw error; // Re-throw the error to be handled by the caller\n    }\n}\n\n// async function checkMonthlyBudgetWarnings(frm, updatedResults, allocatedAmounts) {\n//     let warnings = [];\n\n//     cur_frm.doc.items.forEach(item => {\n//         let cost_center = item.cost_center;\n//         let expense_account = item.expense_account;\n//         let item_code = item.item_code;\n//         let amount = item.amount || 0;\n\n//         let matchedAllocation = allocatedAmounts.find(row =>\n//             row.account === expense_account && row.cost_center === cost_center\n//         );\n\n//         if (matchedAllocation) {\n//             let allocated = matchedAllocation.budget_monthly || 0;\n//             let alreadySpent = (\n//                 updatedResults?.[cost_center]?.[expense_account]?.[item_code] || 0\n//             ) - amount;\n\n//             let totalAfterThisPO = alreadySpent + amount;\n\n//             if (totalAfterThisPO > allocated) {\n//                 warnings.push({\n//                     item_code,\n//                     cost_center,\n//                     expense_account,\n//                     budget: allocated.toFixed(2),\n//                     used: alreadySpent.toFixed(2),\n//                     new_total: totalAfterThisPO.toFixed(2),\n//                     month: matchedAllocation.month,\n//                     budget_doc: matchedAllocation.parent\n//                 });\n//             }\n//         }\n//     });\n\n//     if (warnings.length > 0) {\n//         console.log('wwwww',w)\n//         let msg = warnings.map(w =>\n//             `🟡 Item: <b>${w.item_code}</b><br>\n//             Cost Center: <b>${w.cost_center}</b><br>\n//             Account: <b>${w.expense_account}</b><br>\n//             Month: <b>${w.month}</b><br>\n//             Budget: <b>${w.budget}</b><br>\n//             Used: <b>${w.used}</b><br>\n//             After this PO: <b>${w.new_total}</b><br>\n//             Budget Doc: <b>${w.budget_doc}</b><br><hr>`\n//         ).join(\"\");\n\n//         frappe.msgprint({\n//             title: __(\"Monthly Budget Exceeded (Warning)\"),\n//             message: msg,\n//             indicator: \"orange\"\n//         });\n//     } else {\n//         console.log(\"✅ All items are within the monthly budget.\");\n//     }\n// }\n// async function checkMonthlyBudgetWarnings(frm, updatedResults, allocatedAmounts) {\n//     let warnings = [];\n//     let stops = [];\n\n//     cur_frm.doc.items.forEach(item => {\n//         let cost_center = item.cost_center;\n//         let expense_account = item.expense_account;\n//         let item_code = item.item_code;\n//         let amount = item.amount || 0;\n\n//         let matchedAllocation = allocatedAmounts.find(row =>\n//             row.account === expense_account && row.cost_center === cost_center\n//         );\n\n//         if (matchedAllocation) {\n//             let allocated = matchedAllocation.budget_monthly || 0;\n//             let alreadySpent = (\n//                 updatedResults?.[cost_center]?.[expense_account]?.[item_code] || 0\n//             ) - amount;\n\n//             let totalAfterThisPO = alreadySpent + amount;\n\n//             if (totalAfterThisPO > allocated) {\n//                 const warnData = {\n//                     item_code,\n//                     cost_center,\n//                     expense_account,\n//                     budget: allocated.toFixed(2),\n//                     used: alreadySpent.toFixed(2),\n//                     new_total: totalAfterThisPO.toFixed(2),\n//                     month: matchedAllocation.month,\n//                     budget_doc: matchedAllocation.parent\n//                 };\n\n//                 if (matchedAllocation.action_if__monthly_budget_exceeded_on_po === \"Stop\") {\n//                     stops.push(warnData);\n//                 } else {\n//                     warnings.push(warnData);\n//                 }\n//             }\n//         }\n//     });\n\n//     if (stops.length > 0) {\n//         const stopMsg = stops.map(w =>\n//             `⛔️ Item: <b>${w.item_code}</b><br>\n//              Cost Center: <b>${w.cost_center}</b><br>\n//              Account: <b>${w.expense_account}</b><br>\n//              Month: <b>${w.month}</b><br>\n//              Budget: <b>${w.budget}</b><br>\n//              Used: <b>${w.used}</b><br>\n//              After this PO: <b>${w.new_total}</b><br>\n//              Budget Doc: <b>${w.budget_doc}</b><br><hr>`\n//         ).join(\"\");\n\n//         frappe.throw({\n//             title: __(\"❌ Monthly Budget Exceeded (Stop)\"),\n//             message: stopMsg\n//         });\n//     }\n\n//     if (warnings.length > 0) {\n//         const warnMsg = warnings.map(w =>\n//             `🟡 Item: <b>${w.item_code}</b><br>\n//              Cost Center: <b>${w.cost_center}</b><br>\n//              Account: <b>${w.expense_account}</b><br>\n//              Month: <b>${w.month}</b><br>\n//              Budget: <b>${w.budget}</b><br>\n//              Used: <b>${w.used}</b><br>\n//              After this PO: <b>${w.new_total}</b><br>\n//              Budget Doc: <b>${w.budget_doc}</b><br><hr>`\n//         ).join(\"\");\n\n//         frappe.msgprint({\n//             title: __(\"Monthly Budget Exceeded (Warning)\"),\n//             message: warnMsg,\n//             indicator: \"orange\"\n//         });\n//     }\n\n//     if (stops.length === 0) {\n//         console.log(\"✅ All items are within the monthly budget.\");\n//     }\n// }\nasync function checkMonthlyBudgetWarnings(frm, updatedResults, allocatedAmounts) {\n    let warnings = [];\n    let stops = [];\n\n    cur_frm.doc.items.forEach(item => {\n        let cost_center = item.cost_center;\n        let expense_account = item.expense_account;\n        let item_code = item.item_code;\n        let amount = item.amount || 0;\n\n        let matchedAllocation = allocatedAmounts.find(row =>\n            row.account === expense_account && row.cost_center === cost_center\n        );\n\n        if (matchedAllocation) {\n            let allocated = matchedAllocation.budget_monthly || 0;\n            let alreadySpent = (\n                updatedResults?.[cost_center]?.[expense_account]?.[item_code] || 0\n            ) - amount;\n\n            let totalAfterThisPO = alreadySpent + amount;\n\n            if (totalAfterThisPO > allocated) {\n                const warnData = {\n                    item_code,\n                    cost_center,\n                    expense_account,\n                    budget: allocated.toFixed(2),\n                    used: alreadySpent.toFixed(2),\n                    new_total: totalAfterThisPO.toFixed(2),\n                    month: matchedAllocation.month,\n                    budget_doc: matchedAllocation.parent\n                };\n\n                if (matchedAllocation.action_if__monthly_budget_exceeded_on_po === \"Stop\") {\n                    stops.push(warnData);\n                } else {\n                    warnings.push(warnData);\n                }\n            }\n        }\n    });\n\n    // Handle stops first - this will prevent form submission\n    if (stops.length > 0) {\n        const stopMsg = stops.map(w =>\n            `⛔️ Item: <b>${w.item_code}</b><br>\n             Cost Center: <b>${w.cost_center}</b><br>\n             Account: <b>${w.expense_account}</b><br>\n             Month: <b>${w.month}</b><br>\n             Budget: <b>${w.budget}</b><br>\n             Used: <b>${w.used}</b><br>\n             After this PO: <b>${w.new_total}</b><br>\n             Budget Doc: <b>${w.budget_doc}</b><br><hr>`\n        ).join(\"\");\n\n        // This will throw an error and prevent form submission\n        frappe.throw({\n            title: __(\"❌ Monthly Budget Exceeded - Submission Blocked\"),\n            message: stopMsg,\n            indicator: \"red\"\n        });\n        \n        // Return false explicitly (though frappe.throw should already stop execution)\n        return false;\n    }\n\n    // Show warnings (but allow form submission to continue)\n    if (warnings.length > 0) {\n        const warnMsg = warnings.map(w =>\n            `🟡 Item: <b>${w.item_code}</b><br>\n             Cost Center: <b>${w.cost_center}</b><br>\n             Account: <b>${w.expense_account}</b><br>\n             Month: <b>${w.month}</b><br>\n             Budget: <b>${w.budget}</b><br>\n             Used: <b>${w.used}</b><br>\n             After this PO: <b>${w.new_total}</b><br>\n             Budget Doc: <b>${w.budget_doc}</b><br><hr>`\n        ).join(\"\");\n\n        frappe.msgprint({\n            title: __(\"⚠️ Monthly Budget Exceeded (Warning)\"),\n            message: warnMsg,\n            indicator: \"orange\"\n        });\n    }\n\n    // If no stops, log success and return true\n    console.log(\"✅ All items are within the monthly budget or only have warnings.\");\n    return true;\n}\n\n// Usage in your form validation (e.g., in validate event)\n// Make sure to await the function and handle the return value:\n\n\nfrm.doc.validate = async function() {\n    try {\n        const budgetCheckPassed = await checkMonthlyBudgetWarnings(frm, updatedResults, allocatedAmounts);\n        if (!budgetCheckPassed) {\n            frappe.validated = false; // Additional safety to prevent submission\n        }\n    } catch (error) {\n        // frappe.throw() will cause an exception, which prevents form submission\n        frappe.validated = false;\n        throw error; // Re-throw to show the error message\n    }\n}\n\n\n\n\n// function change_workflow_state(frm) {\n//     // Move to the next state in the workflow\n//     cur_frm.set_value(\"workflow_state\", \"مراجعة المدير المالي\");\n\n//     frm.save().then(() => {\n//         frappe.msgprint(__('Workflow state changed successfully.'));\n//     }).catch((error) => {\n//         frappe.msgprint(__('Failed to change workflow state.'));\n//         console.error(error);\n//     });\n// }\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 0,
  "modified": "2025-08-25 00:38:27.799066",
  "module": "AlphaX Budget",
  "name": "Validate Action action_if__monthly_budget_exceeded_on_po",
  "script": "frappe.ui.form.on(\"Purchase Order\", {\n    async validate(frm) {\n        // Basic validation checks\n        const transactionDate = cur_frm.doc.transaction_date;\n        const itemsTable = cur_frm.doc.items;\n        \n        if (!transactionDate) {\n            frappe.msgprint({\n                title: __(`Transaction Date`),\n                message: __(`Transaction Date is Empty`),\n                indicator: 'orange',\n            });\n            frappe.validated = false;\n            cur_frm.scroll_to_field('transaction_date');\n            return false;\n        }\n        \n        if (!itemsTable || itemsTable.length === 0) {\n            frappe.msgprint({\n                title: __(`Items Table`),\n                message: __(`Table of Purchase Order is Empty`),\n                indicator: 'orange',\n            });\n            frappe.validated = false;\n            cur_frm.scroll_to_field('items');\n            return false;\n        }\n\n        // Budget validation checks\n        try {\n            let poResults = await get_po(frm);\n            let updatedResults = mergeCurrentItemsIntoResults(poResults, cur_frm.doc.items);\n            console.log(\"✅ Updated Results:\", updatedResults);\n            \n            let PO_year = cur_frm.doc.transaction_date.split('-')[0];\n            let budget = await get_budget(updatedResults, PO_year);\n            console.log(\"✅ budget:\", budget);\n            \n            let monthlyDistr = await get_monthly_distribution(frm, budget);\n            console.log(\"✅ monthlyDistr:\", monthlyDistr);\n            \n            // This will throw an error and prevent submission if budget exceeded with \"Stop\" action\n            await checkMonthlyBudgetWarnings(frm, updatedResults, monthlyDistr);\n            \n        } catch (error) {\n             frappe.validated = false;\n            if (error.message && error.message.includes(\"Budget Exceeded\")) {\n                frappe.msgprint({\n                    title: __(\"Validation Error\"),\n                    message: error.message,\n                    indicator: \"red\",\n                });\n                return false;\n            }\n        \n            // frappe.validated = false;\n            // // If it's a budget validation error, re-throw to show the message\n            // if (error.message && error.message.includes(\"Budget Exceeded\")) {\n            //     throw error;\n            // }\n          \n           \n        }\n    },\n\n    async after_save(frm) {\n        // Keep after_save for any post-save operations if needed\n        console.log(\"Purchase Order saved successfully\");\n    }\n});\n\nasync function get_po(frm) {\n    let results = {}; // Object to store totals by expense account\n    let today = new Date(frm.doc.transaction_date);\n    let startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);\n    let endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);\n\n    try {\n        let purchaseOrders = await new Promise((resolve, reject) => {\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"Purchase Order\",\n                    limit_page_length: 1000000,\n                    fields: [\"name\"],\n                    filters: [\n                        [\"docstatus\", \"=\", 1],\n                        [\"transaction_date\", \">=\", startOfMonth],\n                        [\"transaction_date\", \"<\", endOfMonth],\n                    ],\n                },\n                callback: function (r) {\n                    r.message ? resolve(r.message) : reject(\"Failed to fetch Purchase Orders.\");\n                }\n            });\n        });\n\n        if (purchaseOrders.length > 0) {\n            let responses = await Promise.all(purchaseOrders.map(order =>\n                new Promise((resolve, reject) => {\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: {\n                            doctype: \"Purchase Order\",\n                            name: order.name,\n                            fields: [\"items\"],\n                        },\n                        callback: function (r) {\n                            r.message ? resolve(r.message) : reject(\"Failed to fetch Purchase Order details.\");\n                        }\n                    });\n                })\n            ));\n\n            responses.forEach(response => {\n                let allPurchaseOrderItems = response.items || [];\n                allPurchaseOrderItems.forEach(item => {\n                    let amount = item.amount || 0;\n                    let expenseAccount = item.expense_account || '';\n                    let costCenter = item.cost_center || '';\n                    let itemCode = item.item_code || '';\n            \n                    if (expenseAccount && costCenter && itemCode) {\n                        if (!results[costCenter]) {\n                            results[costCenter] = {};\n                        }\n                        if (!results[costCenter][expenseAccount]) {\n                            results[costCenter][expenseAccount] = {};\n                        }\n                        if (!results[costCenter][expenseAccount][itemCode]) {\n                            results[costCenter][expenseAccount][itemCode] = 0;\n                        }\n                        results[costCenter][expenseAccount][itemCode] += amount;\n                    }\n                });\n            });\n        } else {\n            console.error(\"No Purchase Orders found.\");\n        }\n\n    } catch (error) {\n        console.error(\"Error in get_po function\", error);\n    }\n\n    return results;\n}\n\nfunction mergeCurrentItemsIntoResults(poResults, currentItems) {\n    let updatedResults = {};\n    let foundMatch = false;\n    \n    currentItems.forEach(item => {\n        let amount = item.amount || 0;\n        let expenseAccount = item.expense_account || '';\n        let costCenter = item.cost_center || '';\n        let itemCode = item.item_code || '';\n        console.log('🔍 checking item:', costCenter, expenseAccount);\n        \n        if (poResults[costCenter] &&\n            poResults[costCenter][expenseAccount] &&\n            poResults[costCenter][expenseAccount][itemCode] !== undefined\n            ) {\n            foundMatch = true;\n            // تأكد إن cost_center موجود في results\n            if (!updatedResults[costCenter]) {\n                updatedResults[costCenter] = {};\n            }\n\n            // تأكد إن expense_account موجود داخل cost_center\n            if (!updatedResults[costCenter][expenseAccount]) {\n                updatedResults[costCenter][expenseAccount] = {};\n            }\n            \n            if (!updatedResults[costCenter][expenseAccount][itemCode]) {\n                updatedResults[costCenter][expenseAccount][itemCode] = 0;\n            }\n\n            // زود القيمة من المستند الحالي\n            updatedResults[costCenter][expenseAccount][itemCode] =\n                poResults[costCenter][expenseAccount][itemCode] + amount;\n        }\n    });\n\n    return foundMatch ? updatedResults : {};\n}\n\nasync function get_budget(updatedResults, PO_year) {\n    let budgetDetails = [];\n    console.log(\"🧾 updatedResults:\", updatedResults);\n\n    // التحقق من صحة المدخلات\n    if (!updatedResults || typeof updatedResults !== 'object') {\n        console.error(\"❌ updatedResults is not valid\");\n        return [];\n    }\n\n    try {\n        for (let costCenter in updatedResults) {\n            console.log(`🔍 Processing cost center: ${costCenter}`);\n            \n            // نجيب البودجيت بتاع الـ cost center ده\n            let budgets = await new Promise((resolve, reject) => {\n                frappe.call({\n                    method: \"frappe.client.get_list\",\n                    args: {\n                        doctype: \"Budget\",\n                        filters: [\n                            [\"docstatus\", \"=\", 1],\n                            [\"fiscal_year\", \"=\", PO_year],\n                            [\"cost_center\", \"=\", costCenter]\n                        ],\n                        fields: [\"name\", \"cost_center\"],\n                        limit_page_length: 50,\n                    },\n                    callback: function (r) {\n                        if (r.message && Array.isArray(r.message)) {\n                            resolve(r.message);\n                        } else {\n                            console.warn(`⚠️ No budgets found for cost center: ${costCenter}`);\n                            resolve([]); // بدلاً من reject\n                        }\n                    }\n                });\n            });\n\n            console.log(`📊 Found ${budgets.length} budgets for cost center: ${costCenter}`);\n\n            for (let budget of budgets) {\n                try {\n                    let fullBudget = await new Promise((resolve, reject) => {\n                        frappe.call({\n                            method: \"alphax_budget.alphax_budget.api.budget.get_budget_with_accounts\",\n                            args: {\n                                doctype: \"Budget\",\n                                budget_name: budget.name\n                            },\n                            callback: function (r) {\n                                if (r.message) {\n                                    resolve(r.message);\n                                } else {\n                                    reject(`❌ Failed to fetch budget details for ${budget.name}`);\n                                }\n                            }\n                        });\n                    });\n                    \n                    console.log(\"💬 fullBudget returned:\", fullBudget);\n                    console.log(\"📌 Full Budget fetched:\", fullBudget.name, fullBudget.accounts?.map(a => a.account));\n\n                    // التحقق من وجود accounts\n                    if (!fullBudget.accounts || !Array.isArray(fullBudget.accounts)) {\n                        console.warn(`⚠️ No accounts found in budget: ${budget.name}`);\n                        continue;\n                    }\n\n                    // التحقق من وجود البيانات في updatedResults\n                    let resultForCostCenter = updatedResults[budget.cost_center];\n                    if (!resultForCostCenter) {\n                        console.warn(`⚠️ No data found in updatedResults for cost center: ${budget.cost_center}`);\n                        continue;\n                    }\n\n                    console.log('📋 Processing budget:', fullBudget.name);\n                     console.log('📋 resultForCostCenter:', );\n                    fullBudget.accounts.forEach((accountRow, index) => {\n                        try {\n                            // التحقق من صحة بيانات الحساب\n                            if (!accountRow.account) {\n                                console.warn(`⚠️ Account missing in row ${index} of budget ${budget.name}`);\n                                return;\n                            }\n\n                            // البحث عن بيانات الحساب في النتائج المحدثة\n                               console.warn(`⚠️ Acc ${accountRow.account}`);\n                            let accountData = resultForCostCenter[accountRow.account];\n                               console.warn(`⚠️ accountData ${accountData}`);\n                            if (accountData) {\n                                console.log(`✅ Found data for account: ${accountRow.account}`);\n                                budgetDetails.push({\n                                    account: accountRow.account,\n                                    budget_monthly: accountRow.budget_amount || 0,\n                                    cost_center: budget.cost_center,\n                                    monthly_distribution: accountRow.custom_monthly_distribution || null,\n                                    parent: budget.name,\n                                    applicable_on_purchase_order: fullBudget.applicable_on_purchase_order || 0,\n                                    action_if__monthly_budget_exceeded_on_po: fullBudget.custom_action_if__monthly_budget_exceeded_on_po || null\n                                });\n                            } else {\n                                console.log(`ℹ️ No matching data found for account: ${accountRow.account} in cost center: ${budget.cost_center}`);\n                            }\n                        } catch (innerError) {\n                            console.error(`💥 Error processing account row ${index}:`, innerError);\n                        }\n                    });\n                    \n                } catch (budgetError) {\n                    console.error(`💥 Error processing budget ${budget.name}:`, budgetError);\n                    continue; // استمر في معالجة باقي البودجيت\n                }\n            }\n        }\n\n        console.log(\"✅ Budget Details:\", budgetDetails);\n        console.log(`📈 Total budget details found: ${budgetDetails.length}`);\n        return budgetDetails;\n\n    } catch (error) {\n        console.error(\"💥 Error in get_budget:\", error);\n        return [];\n    }\n}\n\nasync function get_monthly_distribution(frm, budgetDetails) {\n    try {\n        console.log(\"Budget Details:\", budgetDetails);\n        \n        if (!Array.isArray(budgetDetails)) {\n            throw new Error(\"Invalid data format returned from get_budget.\");\n        }\n        \n        let monthList = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \n                        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n        let po_month = new Date(frm.doc.transaction_date);\n        let currentMonthIndex = po_month.getMonth(); // Zero-based index\n\n        let allocatedAmounts = [];\n\n        for (let budget of budgetDetails) {\n            console.log(\"Processing budget account:\", budget);\n\n            // Check if monthly_distribution exists\n            if (!budget.monthly_distribution) {\n                frappe.throw(__(\"No monthly distribution found for budget: {0}\", [budget.parent]));\n                // Use equal distribution (100/12 = 8.33% per month)\n                let allocatedAmount = (alphax_budget.alphax_budgett_monthly || 0) / 12;\n                allocatedAmounts.push({\n                    \"account\": budget.account,\n                    \"cost_center\": budget.cost_center,\n                    \"budget_monthly\": allocatedAmount,\n                    \"parent\": budget.parent,\n                    \"month\": monthList[currentMonthIndex],\n                    \"action_if__monthly_budget_exceeded_on_po\": budget.action_if__monthly_budget_exceeded_on_po\n                });\n                continue;\n            }\n\n            try {\n                let monthlyDistResponse = await new Promise((resolve, reject) => {\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: {\n                            doctype: \"Monthly Distribution\",\n                            name: budget.monthly_distribution,\n                            fields: [\"percentages\"],\n                        },\n                        callback: function (r) {\n                            if (r.message) {\n                                resolve(r.message);\n                            } else {\n                                reject(\"Failed to fetch monthly distribution.\");\n                            }\n                        }\n                    });\n                });\n\n                let percentages = monthlyDistResponse.percentages || [];\n                \n                // Find the percentage for current month\n                let currentMonthPercentage = 0;\n                percentages.forEach(row => {\n                    if (row.month === monthList[currentMonthIndex]) {\n                        currentMonthPercentage = row.percentage_allocation || 0;\n                    }\n                });\n\n                let allocatedAmount = (currentMonthPercentage * (alphax_budget.alphax_budgett_monthly || 0)) / 100;\n                \n                allocatedAmounts.push({\n                    \"account\": budget.account,\n                    \"applicable_on_purchase_order\": budget.applicable_on_purchase_order || 0,\n                    \"action_if__monthly_budget_exceeded_on_po\": budget.action_if__monthly_budget_exceeded_on_po || null,\n                    \"cost_center\": budget.cost_center,\n                    \"budget_monthly\": allocatedAmount,\n                    \"parent\": budget.parent,\n                    \"month\": monthList[currentMonthIndex],\n                    \"percentage\": currentMonthPercentage\n                });\n\n            } catch (distError) {\n                console.error(\"Error fetching monthly distribution for:\", budget.monthly_distribution, distError);\n                // Fallback to equal distribution\n                let allocatedAmount = (alphax_budget.alphax_budgett_monthly || 0) / 12;\n                allocatedAmounts.push({\n                    \"account\": budget.account,\n                    \"cost_center\": budget.cost_center,\n                    \"budget_monthly\": allocatedAmount,\n                    \"parent\": budget.parent,\n                    \"month\": monthList[currentMonthIndex],\n                    \"fallback\": true,\n                    \"action_if__monthly_budget_exceeded_on_po\": budget.action_if__monthly_budget_exceeded_on_po\n                });\n            }\n        }\n\n        console.log(\"Final Allocated Amounts:\", allocatedAmounts);\n        return allocatedAmounts;\n\n    } catch (error) {\n        console.error(\"Error in get_monthly_distribution:\", error);\n        throw error; // Re-throw the error to be handled by the caller\n    }\n}\n\nasync function checkMonthlyBudgetWarnings(frm, updatedResults, allocatedAmounts) {\n    let warnings = [];\n    let stops = [];\n\n    cur_frm.doc.items.forEach(item => {\n        let cost_center = item.cost_center;\n        let expense_account = item.expense_account;\n        let item_code = item.item_code;\n        let amount = item.amount || 0;\n\n        let matchedAllocation = allocatedAmounts.find(row =>\n            row.account === expense_account && row.cost_center === cost_center\n        );\n\n        if (matchedAllocation) {\n            let allocated = matchedAllocation.budget_monthly || 0;\n            let alreadySpent = (\n                updatedResults?.[cost_center]?.[expense_account]?.[item_code] || 0\n            ) - amount;\n\n            let totalAfterThisPO = alreadySpent + amount;\n\n            if (totalAfterThisPO > allocated) {\n                const warnData = {\n                    item_code,\n                    cost_center,\n                    expense_account,\n                    budget: allocated.toFixed(2),\n                    used: alreadySpent.toFixed(2),\n                    new_total: totalAfterThisPO.toFixed(2),\n                    month: matchedAllocation.month,\n                    budget_doc: matchedAllocation.parent\n                };\n\n                if (matchedAllocation.action_if__monthly_budget_exceeded_on_po === \"Stop\") {\n                    stops.push(warnData);\n                } else {\n                    warnings.push(warnData);\n                }\n            }\n        }\n    });\n\n    // Handle stops first - this will prevent form submission\n    if (stops.length > 0) {\n        const stopMsg = stops.map(w =>\n            `⛔️ Item: <b>${w.item_code}</b><br>\n             Cost Center: <b>${w.cost_center}</b><br>\n             Account: <b>${w.expense_account}</b><br>\n             Month: <b>${w.month}</b><br>\n             Budget: <b>${w.budget}</b><br>\n             Used: <b>${w.used}</b><br>\n             After this PO: <b>${w.new_total}</b><br>\n             Budget Doc: <b>${w.budget_doc}</b><br><hr>`\n        ).join(\"\");\n\n        // This will throw an error and prevent form submission\n        frappe.throw({\n            title: __(\"Monthly Budget Exceeded - Submission Blocked\"),\n            message: stopMsg,\n            indicator: \"red\"\n        });\n        \n        // Return false explicitly (though frappe.throw should already stop execution)\n        return false;\n    }\n\n    // Show warnings (but allow form submission to continue)\n    if (warnings.length > 0) {\n        const warnMsg = warnings.map(w =>\n            `🟡 Item: <b>${w.item_code}</b><br>\n             Cost Center: <b>${w.cost_center}</b><br>\n             Account: <b>${w.expense_account}</b><br>\n             Month: <b>${w.month}</b><br>\n             Budget: <b>${w.budget}</b><br>\n             Used: <b>${w.used}</b><br>\n             After this PO: <b>${w.new_total}</b><br>\n             Budget Doc: <b>${w.budget_doc}</b><br><hr>`\n        ).join(\"\");\n\n        frappe.msgprint({\n            title: __(\"⚠️ Monthly Budget Exceeded (Warning)\"),\n            message: warnMsg,\n            indicator: \"orange\"\n        });\n    }\n\n    // If no stops, log success and return true\n    console.log(\"✅ All items are within the monthly budget or only have warnings.\");\n    return true;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Control",
  "enabled": 0,
  "modified": "2025-08-22 14:08:53.320079",
  "module": "AlphaX Budget",
  "name": "Get All Departments",
  "script": "frappe.ui.form.on('Budget Control', {\n\tget_all_departments(frm) {\n\t\tfrappe.call({\n\t\t\tmethod: 'frappe.client.get_list',\n\t\t\targs: {\n\t\t\t\tdoctype: 'Department',\n\t\t\t\tfields: ['name'],\n\t\t\t\tlimit_page_length: 1000\n\t\t\t},\n\t\t\tcallback: function (r) {\n\t\t\t\tif (r.message) {\n\t\t\t\t\t// استبعاد 'All Departments' ثم أخذ الأسماء فقط\n\t\t\t\t\tconst filtered_departments = r.message\n\t\t\t\t\t\t.filter(dep => dep.name !== 'All Departments')\n\t\t\t\t\t\t.map(dep => dep.name);\n\n\t\t\t\t\t// امسح الجدول القديم\n\t\t\t\t\tfrm.clear_table('departments_list');\n\n\t\t\t\t\t// أضف الأقسام إلى الجدول\n\t\t\t\t\tfiltered_departments.forEach(dep_name => {\n\t\t\t\t\t\tlet row = frm.add_child('departments_list');\n\t\t\t\t\t\trow.departments = dep_name;\n\t\t\t\t\t});\n\n\t\t\t\t\tfrm.refresh_field('departments_list');\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Control",
  "enabled": 0,
  "modified": "2025-08-21 19:21:15.342306",
  "module": "AlphaX Budget",
  "name": "Create Budget Request For Deparemnts",
  "script": "frappe.ui.form.on('Budget Control', {\n    // للتحقق من البيانات فقط - قبل الإرسال\n    before_submit: async function(frm) {\n        let year = frm.doc.fiscal_year;\n        let depList = frm.doc.departments_list;\n        \n        console.log(\"🔍 before_submit: Validation started\");\n\n        let departments_exist = []\n        for (let dep of depList){\n            let budgetRequestExists = await checkRoleExists(dep.departments);\n        //     console.log('there is Department',budgetRequestExists);\n            if (budgetRequestExists)\n            departments_exist.push(dep.departments);\n                \n           \n        }\n         if (departments_exist.length > 0) {\n              let errorMessage;\n                if (departments_exist.length === 1) {\n                    errorMessage = `⚠ There is already a Budget Request for the department: ${departments_exist[0]}. <br> You cannot submit this document until the request is deleted or modified.`;\n                } else {\n                    errorMessage = `⚠ There are already Budget Requests for the following departments: ${departments_exist.join(', ')}. You cannot submit this document until the requests are deleted or modified.`;\n                }\n// Prevent form submission\n                frappe.validated = false;\n                \n                // Show error message\n                frappe.msgprint({\n                    title: __('Error Create Budget Request'),\n                    message: __(errorMessage),\n                    indicator: 'red'\n                });\n                \n                return;\n            }\n         \n         \n        if (frm.doc.budget_controller === 'Financial') {\n            // التحقق من البيانات المطلوبة\n            if (!year) {\n                frappe.msgprint({\n                    title: __('خطأ في البيانات'),\n                    message: __('السنة المالية مطلوبة'),\n                    indicator: 'red'\n                });\n                frappe.validated = false;\n                return false;\n            }\n            \n            if (!depList || depList.length === 0) {\n                frappe.msgprint({\n                    title: __('خطأ في البيانات'),\n                    message: __('يجب إضافة قسم واحد على الأقل في قائمة الأقسام'),\n                    indicator: 'red'\n                });\n                frappe.validated = false;\n                return false;\n            }\n            \n            console.log(\"✅ before_submit: Validation passed\");\n        } else {\n            console.log(\"ℹ️ before_submit: Skipped validation - budget_controller is not 'Financial'\");\n        }\n    },\n\n    // لإنشاء المستندات وعرض رسالة النجاح - بعد الإرسال الناجح\n    on_submit: async function(frm) {\n        if (frm.doc.budget_controller === 'Financial') {\n             console.log(\"🔄 on_submit: Started creating Budget Requests\");\n            let year = frm.doc.fiscal_year;\n            let depList = frm.doc.departments_list;\n            \n            try {\n                let created_requests = [];\n                \n                // إنشاء Budget Request لكل قسم\n                for (let row of depList) {\n                    if (!row.departments) {\n                        console.log(`⚠️ Skipping row - no department specified`);\n                        continue;\n                    }\n                    \n                    console.log(`📋 Creating Budget Request for: ${row.departments}`);\n                    \n                    let budget = frappe.model.get_new_doc(\"Budget Request\");\n                    budget.department = row.departments;\n                    budget.fiscal_year = year;\n                    alphax_budget.alphax_budgett_control = frm.doc.name;\n                    alphax_budget.alphax_budgett_controller = frm.doc.budget_controller;\n                    \n                    const inserted_doc = await frappe.db.insert(budget);\n                    console.log(`✅ Created Budget Request: ${inserted_doc.name}`);\n                    \n                    // إضافة إلى قائمة المُنشأة\n                    created_requests.push({\n                        name: inserted_doc.name,\n                        department: row.departments\n                    });\n                    \n                    // تعديل workflow_state\n                    await frappe.model.set_value(\"Budget Request\", inserted_doc.name, \"workflow_state\", \"تحت مراجعة قسم المالية\");\n                    console.log(`🔄 Updated workflow state for: ${inserted_doc.name}`);\n                }\n                \n                // رسالة مفصلة بأسماء المستندات المُنشأة\n                let message_html = `<div style=\"text-align: right;\">\n                    <p><strong>تم إنشاء ${created_requests.length} طلب ميزانية بنجاح:</strong></p>\n                    <ul style=\"list-style: none; padding: 0;\">`;\n                \n                created_requests.forEach(req => {\n                    message_html += `<li style=\"margin: 8px 0; padding: 8px; background-color: #f8f9fa; border-right: 3px solid #28a745; border-radius: 4px;\">\n                        📋 <strong>${req.name}</strong><br>\n                        🏢 القسم: ${req.department}\n                    </li>`;\n                });\n                \n                message_html += `</ul></div>`;\n                \n                frappe.msgprint({\n                    title: __('تم إنشاء طلبات الميزانية بنجاح ✅'),\n                    message: message_html,\n                    indicator: 'green',\n                    wide: true\n                });\n                \n                // تنبيه إضافي\n                frappe.show_alert({\n                    message: __(`تم إنشاء ${created_requests.length} طلب ميزانية بنجاح`),\n                    indicator: 'green'\n                }, 5);\n                \n                console.log(\"✅ on_submit: Budget Requests created successfully\");\n                \n            } catch (err) {\n                console.error(\"❌ Error in on_submit:\", err);\n                frappe.msgprint({\n                    title: __('خطأ في النظام'),\n                    message: __('فشل في إنشاء بعض طلبات الميزانية. يرجى مراجعة وحدة التحكم للتفاصيل'),\n                    indicator: 'red'\n                });\n            }\n        } else {\n            console.log(\"ℹ️ on_submit: No Budget Requests created - budget_controller is not 'Financial'\");\n        }\n        \n        \n    },\n\n    // validation إضافية عند الحفظ\n    validate: function(frm) {\n        console.log(\"🔍 validate triggered\");\n        \n        if (frm.doc.budget_controller === 'Financial') {\n            if (!frm.doc.fiscal_year) {\n                frappe.msgprint({\n                    title: __('بيانات مطلوبة'),\n                    message: __('السنة المالية مطلوبة عندما يكون المتحكم في الميزانية مالي'),\n                    indicator: 'orange'\n                });\n                frappe.validated = false;\n                return;\n            }\n            \n            if (!frm.doc.departments_list || frm.doc.departments_list.length === 0) {\n                frappe.msgprint({\n                    title: __('بيانات مطلوبة'),\n                    message: __('قائمة الأقسام لا يمكن أن تكون فارغة عندما يكون المتحكم في الميزانية مالي'),\n                    indicator: 'orange'\n                });\n                frappe.validated = false;\n                return;\n            }\n        }\n    },\n\n    // عند تغيير budget_controller\n    budget_controller: function(frm) {\n        if (frm.doc.budget_controller === 'Financial') {\n            frm.set_df_property('fiscal_year', 'reqd', 1);\n            frm.set_df_property('departments_list', 'reqd', 1);\n            frappe.msgprint({\n                title: __('تنبيه'),\n                message: __('يرجى التأكد من تعبئة السنة المالية وقائمة الأقسام'),\n                indicator: 'blue'\n            });\n        } else {\n            frm.set_df_property('fiscal_year', 'reqd', 0);\n            frm.set_df_property('departments_list', 'reqd', 0);\n        }\n    }\n});\n\nasync function checkRoleExists(department) {\n    try {\n        const result = await frappe.db.get_value(\n            'Budget Request',\n            { department: department }, // filters\n            'name'\n        );\n        if (result && result.message && result.message.name) {\n            console.log(\"✅ موجود:\", result.message.name);\n            return true;\n        } else {\n            console.log(\"❌ غير موجود\");\n            return false;\n        }\n    } catch (err) {\n        console.error(\"Error checking role existence:\", err);\n        return false;\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 1,
  "modified": "2025-09-14 03:31:26.301972",
  "module": "AlphaX Budget",
  "name": "Dialog for Budget Items Details trigger on button Insert Item Quantity",
  "script": "frappe.ui.form.on('Budget Items Details', {\n\n    expected_price: function(frm, cdt, cdn) {\n        var d = locals[cdt][cdn];\n        var total_quantity = d.total_quantity || 0;\n        var expected_price = d.expected_price || 0;\n\n        if (!isNaN(expected_price) && !isNaN(total_quantity)) {\n            var total = total_quantity * expected_price;\n            frappe.model.set_value(cdt, cdn, 'total', total);\n        } else {\n            frappe.msgprint(__('Error: Expected Price or Total Quantity is not a valid number.'));\n        }\n    },\n        \n    total_quantity: function(frm, cdt, cdn) {\n        var d = locals[cdt][cdn];\n        var total_quantity = d.total_quantity || 0;\n        var expected_price = d.expected_price || 0;\n\n        if (!isNaN(expected_price) && !isNaN(total_quantity)) {\n            var total = total_quantity * expected_price;\n            frappe.model.set_value(cdt, cdn, 'total', total);\n        } else {\n            frappe.msgprint(__('Error: Expected Price or Total Quantity is not a valid number.'));\n        }\n    }    \n});\n\nfrappe.ui.form.on('Budget Request', {\n    // Parent form function - Fixed to handle sequential dialog processing\n    insert_item_quantity: function(frm) {\n        // Check if there are items in the child table\n        if (!frm.doc.budget_items_details || frm.doc.budget_items_details.length === 0) {\n            frappe.msgprint(__('Please add items to the budget details table first.'));\n            return;\n        }\n\n        // Create a sequential dialog processor\n        var current_item_index = 0;\n        var items = frm.doc.budget_items_details;\n\n        function show_dialog_for_item(index) {\n            if (index >= items.length) {\n                frappe.show_alert({\n                    message: __('All items processed successfully'),\n                    indicator: 'green'\n                }, 5);\n                return;\n            }\n\n            var d = items[index];\n            var dialog = new frappe.ui.Dialog({\n                title: __('Enter Monthly Budget Quantities for: ') + (d.item_name || d.item_code || 'Item ' + (index + 1)),\n                fields: [\n                    // Item Information Section\n                    {\n                        fieldname: \"item_section\",\n                        fieldtype: \"Section Break\",\n                        label: __(\"Item Information\")\n                    },\n                    {\n                        fieldname: \"item_code\",\n                        fieldtype: \"Link\",\n                        label: __(\"Item Code\"),\n                        options: \"Item\",\n                        reqd: 1\n                    },\n                    {\n                        fieldname: \"column_break_item_1\",\n                        fieldtype: \"Column Break\"\n                    },\n                    {\n                        fieldname: \"expected_price\",\n                        fieldtype: \"Float\",\n                        label: __(\"Expected Price\"),\n                        precision: 2\n                    },\n                    {\n                        fieldname: \"column_break_item_2\",\n                        fieldtype: \"Column Break\"\n                    },\n                    {\n                        fieldname: \"expense_account\",\n                        fieldtype: \"Link\",\n                        label: __(\"Expense Account\"),\n                        options: \"Account\",\n                        get_query: function() {\n                            return {\n                                filters: {\n                                    \"company\":  frappe.defaults.get_user_default(\"Company\"),  \n                                    \"report_type\": \"Profit and Loss\",\n                                    \"is_group\": 0\n                                }\n                            };\n                        }\n                    },\n                    // Monthly Quantities Section\n                    {\n                        fieldname: \"monthly_section\",\n                        fieldtype: \"Section Break\",\n                        label: __(\"Monthly Quantities\")\n                    },\n                    { fieldname: \"january\", fieldtype: 'Float', label: __(\"January\") },\n                    { fieldname: \"july\", fieldtype: \"Float\", label: __(\"July\") },\n                    { fieldname: \"column_break_1\", fieldtype: 'Column Break' },\n                    { fieldname: \"february\", fieldtype: \"Float\", label: __(\"February\") },\n                    { fieldname: \"august\", fieldtype: \"Float\", label: __(\"August\") },\n                    { fieldname: \"column_break_2\", fieldtype: 'Column Break' },\n                    { fieldname: \"march\", fieldtype: \"Float\", label: __(\"March\") },\n                    { fieldname: \"september\", fieldtype: \"Float\", label: __(\"September\") },\n                    { fieldname: \"column_break_3\", fieldtype: 'Column Break' },\n                    { fieldname: \"april\", fieldtype: \"Float\", label: __(\"April\") },\n                    { fieldname: \"october\", fieldtype: \"Float\", label: __(\"October\") },\n                    { fieldname: \"column_break_4\", fieldtype: 'Column Break' },\n                    { fieldname: \"may\", fieldtype: \"Float\", label: __(\"May\") },\n                    { fieldname: \"november\", fieldtype: 'Float', label: __(\"November\") },\n                    { fieldname: \"column_break_5\", fieldtype: 'Column Break' },\n                    { fieldname: \"june\", fieldtype: \"Float\", label: __(\"June\") },\n                    { fieldname: \"december\", fieldtype: \"Float\", label: __(\"December\") },\n                    // Summary Section\n                    {\n                        fieldname: \"summary_section\",\n                        fieldtype: \"Section Break\",\n                        label: __(\"Summary\")\n                    },\n                    {\n                        fieldname: \"total_quantity\",\n                        fieldtype: \"Float\",\n                        label: __(\"Total Quantity\"),\n                        read_only: 1\n                    },\n                    {\n                        fieldname: \"column_break_summary\",\n                        fieldtype: \"Column Break\"\n                    },\n                    {\n                        fieldname: \"total_amount\",\n                        fieldtype: \"Currency\",\n                        label: __(\"Total Amount\"),\n                        read_only: 1\n                    }\n                ],\n                size: 'extra-large'\n            });\n\n            // Pre-fill values\n            dialog.set_values({\n                'item_code': d.item_code || '',\n                'expected_price': d.expected_price || 0.00,\n                'expense_account': d.expense_account || '',\n                'january': d.january || 0.00,\n                'february': d.february || 0.00, \n                'march': d.march || 0.00,\n                'april': d.april || 0.00,\n                'may': d.may || 0.00,\n                'june': d.june || 0.00,\n                'july': d.july || 0.00,\n                'august': d.august || 0.00,\n                'september': d.september || 0.00,\n                'october': d.october || 0.00,\n                'november': d.november || 0.00,\n                'december': d.december || 0.00,\n                'total_quantity': d.total_quantity || 0.00,\n                'total_amount': (d.total_quantity || 0) * (d.expected_price || 0)\n            });\n\n            // Add real-time calculation when monthly quantities change\n            var month_fields = ['january','february','march','april','may','june',\n                              'july','august','september','october','november','december'];\n            \n            month_fields.forEach(function(field) {\n                dialog.fields_dict[field].$input.on('change', function() {\n                    calculate_totals();\n                });\n            });\n\n            dialog.fields_dict.expected_price.$input.on('change', function() {\n                calculate_totals();\n            });\n\n            function calculate_totals() {\n                var total_qty = 0;\n                month_fields.forEach(function(field) {\n                    var val = parseFloat(dialog.get_value(field)) || 0;\n                    total_qty += val;\n                });\n                var expected_price = parseFloat(dialog.get_value('expected_price')) || 0;\n                var total_amount = total_qty * expected_price;\n                \n                dialog.set_value('total_quantity', total_qty);\n                dialog.set_value('total_amount', total_amount);\n            }\n\n            // Primary action (Update and Next/Finish)\n            dialog.set_primary_action(index === items.length - 1 ? __('Finish') : __('Next'), function() {\n                var item_code = dialog.get_value('item_code');\n                var expected_price = dialog.get_value('expected_price');\n                var expense_account = dialog.get_value('expense_account');\n                \n                // Validate required fields\n                if (!item_code) {\n                    frappe.msgprint(__('Please select an Item Code'));\n                    return;\n                }\n\n                // Update item information\n                frappe.model.set_value(d.doctype, d.name, 'item_code', item_code);\n                frappe.model.set_value(d.doctype, d.name, 'expected_price', expected_price || 0);\n                frappe.model.set_value(d.doctype, d.name, 'expense_account', expense_account || '');\n                \n                // Update monthly quantities\n                var fields = [\n                    'january','february','march','april','may','june',\n                    'july','august','september','october','november','december'\n                ];\n                var total_quantity = 0;\n                \n                fields.forEach(function(fieldname) {\n                    var value = parseFloat(dialog.get_value(fieldname)) || 0;\n                    frappe.model.set_value(d.doctype, d.name, fieldname, value);\n                    total_quantity += value;\n                });\n                \n                frappe.model.set_value(d.doctype, d.name, 'total_quantity', total_quantity);\n                \n                // Calculate and set total amount\n                var total_amount = total_quantity * (expected_price || 0);\n                frappe.model.set_value(d.doctype, d.name, 'total', total_amount);\n\n                frappe.show_alert({\n                    message: __('Updated: ') + (d.item_name || item_code || 'Item ' + (index + 1)),\n                    indicator: 'green'\n                }, 2);\n\n                dialog.hide();\n                // Show next item dialog\n                show_dialog_for_item(index + 1);\n            });\n\n            // Add Skip button using add_custom_action\n            dialog.add_custom_action(__('Skip'), function() {\n                dialog.hide();\n                // Show next item dialog\n                show_dialog_for_item(index + 1);\n            });\n\n            dialog.show();\n        }\n\n        // Start with the first item\n        show_dialog_for_item(0);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Department",
  "enabled": 1,
  "modified": "2025-08-25 21:57:25.774535",
  "module": "AlphaX Budget",
  "name": "Fetch Department Head",
  "script": "frappe.ui.form.on('Department', {\n    async refresh(frm) {\n        // شغّل فقط لو فيه department_name\n        if (!frm.doc.department_name) return;\n\n        let role_name = `${frm.doc.department_name} Head`;\n\n        // اتأكد أن الرول موجود في النظام قبل ما نجيب المستخدمين\n        let role_exists = await checkRoleExists(role_name);\n\n        if (role_exists) {\n            console.log(`✅ Role \"${role_name}\" exists`);\n        } else {\n            console.log(`❌ Role \"${role_name}\" does not exist`);\n        }\n\n        try {\n            let users = await getHeadUser(frm, role_name);\n            console.log('userss', users);\n\n            if (users.length) {\n                frm.set_query(\"custom_manager\", function () {\n                    return {\n                        filters: {\n                            'name': ['in', users.map(u => u.name)]\n                        }\n                    };\n                });\n            }else{\n                  frappe.show_alert({\n                      message:__('⚠ No users found with this role. Please assign a Manager role first.'),\n                      indicator: 'Green'});\n                  frm.set_query(\"custom_manager\", function () {\n                    return {\n                        filters: {\n                            'name':['in', []] \n                        }\n                    };\n                });\n            }\n        } catch (error) {\n            console.error(error);\n        }\n    }\n});\n// async function checkRoleExists(role_name) {\n//     return new Promise((resolve, reject) => {\n//         frappe.db.exists('Role', role_name, (r) => {\n//             resolve(!!r.message); // true if exists, false if not\n//         });\n//     });\n// }\nasync function checkRoleExists(role_name) {\n    try {\n        const exists = await frappe.db.exists('Role', role_name);\n        console.log(exists); // true if exists, false if not\n        return exists;\n    } catch (err) {\n        console.error(\"Error checking role existence:\", err);\n        return false;\n    }\n}\n\nasync function getHeadUser(frm, role_name) {\n    return new Promise((resolve, reject) => {\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'User',\n                fields: ['name', 'full_name'],\n                filters: [\n                    ['Has Role', 'role', '=', role_name],\n                    ['User', 'enabled', '=', 1]\n                ]\n            },\n            callback: function (r) {\n                if (r.message && r.message.length > 0) {\n                    console.log(\"users\", r.message);\n\n                    let user_list = r.message.map(u => `${u.full_name} (${u.name})`).join('<br>');\n                    console.log('user_list', user_list);\n\n                    // frappe.msgprint({\n                    //     title: __('Users with role ' + role_name),\n                    //     message: user_list,\n                    //     indicator: 'green'\n                    // });\n\n                    resolve(r.message);\n                } else {\n                    frm.set_value('custom_manager', '');\n                    // ما نعرضش رسالة لو مفيش يوزر\n                    resolve([]);\n                }\n            },\n            error: function (err) {\n                reject(err);\n            }\n        });\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Control",
  "enabled": 0,
  "modified": "2025-08-20 00:24:10.495631",
  "module": "AlphaX Budget",
  "name": "Budget Control DashBoard",
  "script": "frappe.ui.form.on('Budget Control', {\n    refresh(frm) {\n        // Add custom CSS for the dashboard\n        if (!$('#budget-dashboard-styles').length) {\n            $('head').append(`\n                <style id=\"budget-dashboard-styles\">\n                    .budget-dashboard {\n                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\n                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                        border-radius: 20px;\n                        padding: 30px;\n                        margin: 20px 0;\n                        color: white;\n                        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);\n                        position: relative;\n                        overflow: hidden;\n                    }\n                    \n                    .budget-dashboard::before {\n                        content: '';\n                        position: absolute;\n                        top: -50%;\n                        right: -50%;\n                        width: 200%;\n                        height: 200%;\n                        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);\n                        pointer-events: none;\n                        animation: float 6s ease-in-out infinite;\n                    }\n                    \n                    @keyframes float {\n                        0%, 100% { transform: translateY(0px) rotate(0deg); }\n                        50% { transform: translateY(-20px) rotate(5deg); }\n                    }\n                    \n                    .budget-header {\n                        text-align: center;\n                        margin-bottom: 30px;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .budget-title {\n                        font-size: 2.5rem;\n                        font-weight: 800;\n                        margin: 0;\n                        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n                        background: linear-gradient(45deg, #fff, #f0f8ff);\n                        -webkit-background-clip: text;\n                        -webkit-text-fill-color: transparent;\n                        background-clip: text;\n                    }\n                    \n                    .budget-subtitle {\n                        font-size: 1.1rem;\n                        opacity: 0.9;\n                        margin: 10px 0;\n                        font-weight: 300;\n                    }\n                    \n                    .budget-stats {\n                        display: grid;\n                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n                        gap: 20px;\n                        margin: 30px 0;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .stat-card {\n                        background: rgba(255, 255, 255, 0.15);\n                        backdrop-filter: blur(10px);\n                        border-radius: 15px;\n                        padding: 20px;\n                        text-align: center;\n                        border: 1px solid rgba(255, 255, 255, 0.2);\n                        transition: all 0.3s ease;\n                    }\n                    \n                    .stat-card:hover {\n                        transform: translateY(-5px);\n                        background: rgba(255, 255, 255, 0.2);\n                        box-shadow: 0 15px 30px rgba(0,0,0,0.2);\n                    }\n                    \n                    .stat-icon {\n                        font-size: 2.5rem;\n                        margin-bottom: 10px;\n                        filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));\n                    }\n                    \n                    .stat-value {\n                        font-size: 1.8rem;\n                        font-weight: 700;\n                        margin: 5px 0;\n                    }\n                    \n                    .stat-label {\n                        font-size: 0.9rem;\n                        opacity: 0.8;\n                        text-transform: uppercase;\n                        letter-spacing: 1px;\n                    }\n                    \n                    .budget-items {\n                        display: grid;\n                        gap: 20px;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .budget-item {\n                        background: rgba(255, 255, 255, 0.1);\n                        backdrop-filter: blur(15px);\n                        border-radius: 20px;\n                        padding: 25px;\n                        border: 1px solid rgba(255, 255, 255, 0.2);\n                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n                        position: relative;\n                        overflow: hidden;\n                    }\n                    \n                    .budget-item::before {\n                        content: '';\n                        position: absolute;\n                        top: 0;\n                        left: -100%;\n                        width: 100%;\n                        height: 100%;\n                        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);\n                        transition: left 0.5s;\n                    }\n                    \n                    .budget-item:hover::before {\n                        left: 100%;\n                    }\n                    \n                    .budget-item:hover {\n                        transform: scale(1.02);\n                        background: rgba(255, 255, 255, 0.15);\n                        box-shadow: 0 20px 40px rgba(0,0,0,0.2);\n                    }\n                    \n                    .item-header {\n                        display: flex;\n                        justify-content: space-between;\n                        align-items: center;\n                        margin-bottom: 20px;\n                        flex-wrap: wrap;\n                        gap: 10px;\n                    }\n                    \n                    .item-month {\n                        font-size: 1.5rem;\n                        font-weight: 700;\n                        display: flex;\n                        align-items: center;\n                        gap: 10px;\n                    }\n                    \n                    .status-badge {\n                        padding: 8px 16px;\n                        border-radius: 25px;\n                        font-size: 0.8rem;\n                        font-weight: 600;\n                        text-transform: uppercase;\n                        letter-spacing: 1px;\n                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);\n                    }\n                    \n                    .status-good { background: rgba(34, 197, 94, 0.9); }\n                    .status-warning { background: rgba(251, 191, 36, 0.9); }\n                    .status-danger { background: rgba(239, 68, 68, 0.9); }\n                    \n                    .item-details {\n                        display: grid;\n                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n                        gap: 15px;\n                        margin-bottom: 20px;\n                    }\n                    \n                    .detail-item {\n                        background: rgba(0, 0, 0, 0.1);\n                        padding: 15px;\n                        border-radius: 12px;\n                        border-left: 4px solid rgba(255, 255, 255, 0.3);\n                    }\n                    \n                    .detail-label {\n                        font-size: 0.8rem;\n                        opacity: 0.7;\n                        text-transform: uppercase;\n                        letter-spacing: 1px;\n                        margin-bottom: 5px;\n                    }\n                    \n                    .detail-value {\n                        font-size: 1.1rem;\n                        font-weight: 600;\n                        word-break: break-all;\n                    }\n                    \n                    .progress-section {\n                        margin-top: 20px;\n                    }\n                    \n                    .progress-info {\n                        display: flex;\n                        justify-content: space-between;\n                        align-items: center;\n                        margin-bottom: 10px;\n                        flex-wrap: wrap;\n                        gap: 10px;\n                    }\n                    \n                    .progress-label {\n                        font-weight: 600;\n                        font-size: 0.9rem;\n                    }\n                    \n                    .progress-percentage {\n                        font-size: 1.2rem;\n                        font-weight: 700;\n                    }\n                    \n                    .modern-progress {\n                        width: 100%;\n                        height: 12px;\n                        background: rgba(255, 255, 255, 0.2);\n                        border-radius: 10px;\n                        overflow: hidden;\n                        position: relative;\n                        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);\n                    }\n                    \n                    .progress-fill {\n                        height: 100%;\n                        border-radius: 10px;\n                        transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);\n                        position: relative;\n                        overflow: hidden;\n                    }\n                    \n                    .progress-fill::after {\n                        content: '';\n                        position: absolute;\n                        top: 0;\n                        left: 0;\n                        right: 0;\n                        bottom: 0;\n                        background: linear-gradient(45deg, \n                            rgba(255,255,255,0.2) 25%, \n                            transparent 25%, \n                            transparent 50%, \n                            rgba(255,255,255,0.2) 50%, \n                            rgba(255,255,255,0.2) 75%, \n                            transparent 75%);\n                        background-size: 20px 20px;\n                        animation: progress-animation 1s linear infinite;\n                    }\n                    \n                    @keyframes progress-animation {\n                        0% { background-position: 0 0; }\n                        100% { background-position: 20px 0; }\n                    }\n                    \n                    .progress-good { \n                        background: linear-gradient(135deg, #10b981, #059669);\n                        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);\n                    }\n                    .progress-warning { \n                        background: linear-gradient(135deg, #f59e0b, #d97706);\n                        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);\n                    }\n                    .progress-danger { \n                        background: linear-gradient(135deg, #ef4444, #dc2626);\n                        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);\n                    }\n                    \n                    .no-data {\n                        text-align: center;\n                        padding: 60px 20px;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .no-data-icon {\n                        font-size: 4rem;\n                        margin-bottom: 20px;\n                        opacity: 0.6;\n                    }\n                    \n                    .no-data-text {\n                        font-size: 1.3rem;\n                        font-weight: 300;\n                        opacity: 0.8;\n                    }\n                    \n                    @media (max-width: 768px) {\n                        .budget-dashboard { padding: 20px; }\n                        .budget-title { font-size: 2rem; }\n                        .item-header { flex-direction: column; align-items: flex-start; }\n                        .item-details { grid-template-columns: 1fr; }\n                        .progress-info { flex-direction: column; align-items: flex-start; }\n                    }\n                </style>\n            `);\n        }\n\n        // Call the server method\n        frappe.call({\n            method: \"alphax_budget.alphax_budget.doctype.budget_control.budget_control.get_monthly_distribution_department\",\n            args: {\n                cost_center: frm.doc.cost_center || \"Carriers - AEC\"\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    console.log('Budget Data:', r.message);\n                    render_modern_budget_dashboard(frm, r.message);\n                } else {\n                    render_no_data_state(frm);\n                }\n            },\n            error: function(r) {\n                render_error_state(frm, r);\n            }\n        });\n    }\n});\n\nfunction render_modern_budget_dashboard(frm, items) {\n    let container = frm.fields_dict.budget_html.$wrapper;\n    container.empty();\n\n    // Calculate totals\n    const totals = {\n        requested: items.reduce((sum, item) => sum + (item.requested || 0), 0),\n        consumed: items.reduce((sum, item) => sum + (item.consumed || 0), 0),\n        remaining: items.reduce((sum, item) => sum + (item.remaining || 0), 0)\n    };\n\n    const overallPercent = totals.requested > 0 ? ((totals.consumed / totals.requested) * 100).toFixed(1) : 0;\n    const itemsCount = items.length;\n    const monthsCount = [...new Set(items.map(item => item.month))].length;\n\n    let html = `\n        <div class=\"budget-dashboard\">\n            <div class=\"budget-header\">\n                <h1 class=\"budget-title\">💰 Budget Control Center</h1>\n                <p class=\"budget-subtitle\">\n                    <strong>${frm.doc.department || \"Department\"}</strong> • \n                    <strong>${frm.doc.cost_center || \"N/A\"}</strong>\n                </p>\n            </div>\n\n            <div class=\"budget-stats\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">📊</div>\n                    <div class=\"stat-value\">${overallPercent}%</div>\n                    <div class=\"stat-label\">Overall Usage</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">💸</div>\n                    <div class=\"stat-value\">${formatCurrency(totals.consumed)}</div>\n                    <div class=\"stat-label\">Total Spent</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">💰</div>\n                    <div class=\"stat-value\">${formatCurrency(totals.remaining)}</div>\n                    <div class=\"stat-label\">Remaining</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">📅</div>\n                    <div class=\"stat-value\">${monthsCount}</div>\n                    <div class=\"stat-label\">Active Months</div>\n                </div>\n            </div>\n\n            <div class=\"budget-items\">\n    `;\n\n    // Group items by month for better organization\n    const groupedItems = items.reduce((groups, item) => {\n        const month = item.month;\n        if (!groups[month]) {\n            groups[month] = [];\n        }\n        groups[month].push(item);\n        return groups;\n    }, {});\n\n    // Render each month's data\n    Object.entries(groupedItems).forEach(([month, monthItems]) => {\n        monthItems.forEach(row => {\n            const percent = row.requested > 0 ? ((row.consumed / row.requested) * 100) : 0;\n            const { status, icon, statusClass, progressClass } = getBudgetStatus(percent);\n\n            html += `\n                <div class=\"budget-item\">\n                    <div class=\"item-header\">\n                        <div class=\"item-month\">\n                            <span>📅 ${row.month}</span>\n                        </div>\n                        <div class=\"status-badge ${statusClass}\">\n                            ${icon} ${status}\n                        </div>\n                    </div>\n\n                    <div class=\"item-details\">\n                        <div class=\"detail-item\">\n                            <div class=\"detail-label\">Item Code</div>\n                            <div class=\"detail-value\">${row.item_code || 'N/A'}</div>\n                        </div>\n                        <div class=\"detail-item\">\n                            <div class=\"detail-label\">Expense Account</div>\n                            <div class=\"detail-value\">${row.account || 'N/A'}</div>\n                        </div>\n                        <div class=\"detail-item\">\n                            <div class=\"detail-label\">Monthly Budget</div>\n                            <div class=\"detail-value\">${formatCurrency(row.requested)}</div>\n                        </div>\n                        <div class=\"detail-item\">\n                            <div class=\"detail-label\">Amount Spent</div>\n                            <div class=\"detail-value\">${formatCurrency(row.consumed)}</div>\n                        </div>\n                    </div>\n\n                    <div class=\"progress-section\">\n                        <div class=\"progress-info\">\n                            <span class=\"progress-label\">Budget Utilization</span>\n                            <span class=\"progress-percentage\">${percent.toFixed(1)}%</span>\n                        </div>\n                        <div class=\"modern-progress\">\n                            <div class=\"progress-fill ${progressClass}\" style=\"width: ${Math.min(percent, 100)}%\"></div>\n                        </div>\n                        <div style=\"margin-top: 10px; text-align: center; opacity: 0.9;\">\n                            <strong>Remaining: ${formatCurrency(row.remaining)}</strong>\n                        </div>\n                    </div>\n                </div>\n            `;\n        });\n    });\n\n    html += `\n            </div>\n        </div>\n    `;\n\n    container.html(html);\n\n    // Add entrance animation\n    setTimeout(() => {\n        $('.budget-item').each(function(index) {\n            $(this).css({\n                'opacity': '0',\n                'transform': 'translateY(30px)'\n            });\n            \n            setTimeout(() => {\n                $(this).css({\n                    'opacity': '1',\n                    'transform': 'translateY(0)',\n                    'transition': 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)'\n                });\n            }, index * 100);\n        });\n    }, 100);\n}\n\nfunction render_no_data_state(frm) {\n    let container = frm.fields_dict.budget_html.$wrapper;\n    container.empty();\n    \n    container.html(`\n        <div class=\"budget-dashboard\">\n            <div class=\"no-data\">\n                <div class=\"no-data-icon\">📊</div>\n                <div class=\"no-data-text\">No budget data found for this cost center</div>\n                <p style=\"opacity: 0.7; margin-top: 20px;\">\n                    Please check if the cost center has monthly distributions configured.\n                </p>\n            </div>\n        </div>\n    `);\n}\n\nfunction render_error_state(frm, error) {\n    let container = frm.fields_dict.budget_html.$wrapper;\n    container.empty();\n    \n    container.html(`\n        <div class=\"budget-dashboard\">\n            <div class=\"no-data\">\n                <div class=\"no-data-icon\">❌</div>\n                <div class=\"no-data-text\">Error loading budget data</div>\n                <p style=\"opacity: 0.7; margin-top: 20px;\">\n                    ${error.message || 'Please try refreshing the form or contact your administrator.'}\n                </p>\n            </div>\n        </div>\n    `);\n}\n\nfunction getBudgetStatus(percent) {\n    if (percent < 70) {\n        return {\n            status: 'On Track',\n            icon: '🟢',\n            statusClass: 'status-good',\n            progressClass: 'progress-good'\n        };\n    } else if (percent < 90) {\n        return {\n            status: 'Caution',\n            icon: '🟡',\n            statusClass: 'status-warning',\n            progressClass: 'progress-warning'\n        };\n    } else {\n        return {\n            status: 'Over Budget',\n            icon: '🔴',\n            statusClass: 'status-danger',\n            progressClass: 'progress-danger'\n        };\n    }\n}\n\nfunction formatCurrency(amount) {\n    return new Intl.NumberFormat('en-US', {\n        style: 'currency',\n        currency: 'EGP',\n        minimumFractionDigits: 0,\n        maximumFractionDigits: 0\n    }).format(amount || 0);\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Control",
  "enabled": 0,
  "modified": "2025-08-22 14:48:08.582394",
  "module": "AlphaX Budget",
  "name": "Budget Control Report and Dashboard",
  "script": "frappe.ui.form.on('Budget Control', {\n    refresh(frm) {\n        // Add Report Button\n        frm.add_custom_button(__('📊 Generate Report'), function() {\n            show_report_dialog(frm);\n        }, __('Actions'));\n\n        // Add Refresh Button\n        frm.add_custom_button(__('🔄 Refresh Dashboard'), function() {\n            load_dashboard_data(frm);\n        }, __('Actions'));\n\n        // Add custom CSS for the dashboard\n        if (!$('#budget-dashboard-styles').length) {\n            $('head').append(`\n                <style id=\"budget-dashboard-styles\">\n                    .budget-dashboard {\n                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\n                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                        border-radius: 20px;\n                        padding: 30px;\n                        margin: 20px 0;\n                        color: white;\n                        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);\n                        position: relative;\n                        overflow: hidden;\n                    }\n                    \n                    .budget-dashboard::before {\n                        content: '';\n                        position: absolute;\n                        top: -50%;\n                        right: -50%;\n                        width: 200%;\n                        height: 200%;\n                        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);\n                        pointer-events: none;\n                        animation: float 6s ease-in-out infinite;\n                    }\n                    \n                    @keyframes float {\n                        0%, 100% { transform: translateY(0px) rotate(0deg); }\n                        50% { transform: translateY(-20px) rotate(5deg); }\n                    }\n                    \n                    .budget-header {\n                        text-align: center;\n                        margin-bottom: 30px;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .budget-title {\n                        font-size: 2.5rem;\n                        font-weight: 800;\n                        margin: 0;\n                        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n                        background: linear-gradient(45deg, #fff, #f0f8ff);\n                        -webkit-background-clip: text;\n                        -webkit-text-fill-color: transparent;\n                        background-clip: text;\n                    }\n                    \n                    .budget-subtitle {\n                        font-size: 1.1rem;\n                        opacity: 0.9;\n                        margin: 10px 0;\n                        font-weight: 300;\n                    }\n                    \n                    .budget-stats {\n                        display: grid;\n                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n                        gap: 20px;\n                        margin: 30px 0;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .stat-card {\n                        background: rgba(255, 255, 255, 0.15);\n                        backdrop-filter: blur(10px);\n                        border-radius: 15px;\n                        padding: 20px;\n                        text-align: center;\n                        border: 1px solid rgba(255, 255, 255, 0.2);\n                        transition: all 0.3s ease;\n                    }\n                    \n                    .stat-card:hover {\n                        transform: translateY(-5px);\n                        background: rgba(255, 255, 255, 0.2);\n                        box-shadow: 0 15px 30px rgba(0,0,0,0.2);\n                    }\n                    \n                    .stat-icon {\n                        font-size: 2.5rem;\n                        margin-bottom: 10px;\n                        filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));\n                    }\n                    \n                    .stat-value {\n                        font-size: 1.8rem;\n                        font-weight: 700;\n                        margin: 5px 0;\n                    }\n                    \n                    .stat-label {\n                        font-size: 0.9rem;\n                        opacity: 0.8;\n                        text-transform: uppercase;\n                        letter-spacing: 1px;\n                    }\n                    \n                    .budget-items {\n                        display: grid;\n                        gap: 20px;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .budget-item {\n                        background: rgba(255, 255, 255, 0.1);\n                        backdrop-filter: blur(15px);\n                        border-radius: 20px;\n                        padding: 25px;\n                        border: 1px solid rgba(255, 255, 255, 0.2);\n                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n                        position: relative;\n                        overflow: hidden;\n                    }\n                    \n                    .budget-item::before {\n                        content: '';\n                        position: absolute;\n                        top: 0;\n                        left: -100%;\n                        width: 100%;\n                        height: 100%;\n                        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);\n                        transition: left 0.5s;\n                    }\n                    \n                    .budget-item:hover::before {\n                        left: 100%;\n                    }\n                    \n                    .budget-item:hover {\n                        transform: scale(1.02);\n                        background: rgba(255, 255, 255, 0.15);\n                        box-shadow: 0 20px 40px rgba(0,0,0,0.2);\n                    }\n                    \n                    .item-header {\n                        display: flex;\n                        justify-content: space-between;\n                        align-items: center;\n                        margin-bottom: 20px;\n                        flex-wrap: wrap;\n                        gap: 10px;\n                    }\n                    \n                    .item-month {\n                        font-size: 1.5rem;\n                        font-weight: 700;\n                        display: flex;\n                        align-items: center;\n                        gap: 10px;\n                    }\n                    \n                    .status-badge {\n                        padding: 8px 16px;\n                        border-radius: 25px;\n                        font-size: 0.8rem;\n                        font-weight: 600;\n                        text-transform: uppercase;\n                        letter-spacing: 1px;\n                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);\n                    }\n                    \n                    .status-good { background: rgba(34, 197, 94, 0.9); }\n                    .status-warning { background: rgba(251, 191, 36, 0.9); }\n                    .status-danger { background: rgba(239, 68, 68, 0.9); }\n                    \n                    .item-details {\n                        display: grid;\n                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n                        gap: 15px;\n                        margin-bottom: 20px;\n                    }\n                    \n                    .detail-item {\n                        background: rgba(0, 0, 0, 0.1);\n                        padding: 15px;\n                        border-radius: 12px;\n                        border-left: 4px solid rgba(255, 255, 255, 0.3);\n                    }\n                    \n                    .detail-label {\n                        font-size: 0.8rem;\n                        opacity: 0.7;\n                        text-transform: uppercase;\n                        letter-spacing: 1px;\n                        margin-bottom: 5px;\n                    }\n                    \n                    .detail-value {\n                        font-size: 1.1rem;\n                        font-weight: 600;\n                        word-break: break-all;\n                    }\n                    \n                    .progress-section {\n                        margin-top: 20px;\n                    }\n                    \n                    .progress-info {\n                        display: flex;\n                        justify-content: space-between;\n                        align-items: center;\n                        margin-bottom: 10px;\n                        flex-wrap: wrap;\n                        gap: 10px;\n                    }\n                    \n                    .progress-label {\n                        font-weight: 600;\n                        font-size: 0.9rem;\n                    }\n                    \n                    .progress-percentage {\n                        font-size: 1.2rem;\n                        font-weight: 700;\n                    }\n                    \n                    .modern-progress {\n                        width: 100%;\n                        height: 12px;\n                        background: rgba(255, 255, 255, 0.2);\n                        border-radius: 10px;\n                        overflow: hidden;\n                        position: relative;\n                        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);\n                    }\n                    \n                    .progress-fill {\n                        height: 100%;\n                        border-radius: 10px;\n                        transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);\n                        position: relative;\n                        overflow: hidden;\n                    }\n                    \n                    .progress-fill::after {\n                        content: '';\n                        position: absolute;\n                        top: 0;\n                        left: 0;\n                        right: 0;\n                        bottom: 0;\n                        background: linear-gradient(45deg, \n                            rgba(255,255,255,0.2) 25%, \n                            transparent 25%, \n                            transparent 50%, \n                            rgba(255,255,255,0.2) 50%, \n                            rgba(255,255,255,0.2) 75%, \n                            transparent 75%);\n                        background-size: 20px 20px;\n                        animation: progress-animation 1s linear infinite;\n                    }\n                    \n                    @keyframes progress-animation {\n                        0% { background-position: 0 0; }\n                        100% { background-position: 20px 0; }\n                    }\n                    \n                    .progress-good { \n                        background: linear-gradient(135deg, #10b981, #059669);\n                        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);\n                    }\n                    .progress-warning { \n                        background: linear-gradient(135deg, #f59e0b, #d97706);\n                        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);\n                    }\n                    .progress-danger { \n                        background: linear-gradient(135deg, #ef4444, #dc2626);\n                        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);\n                    }\n                    \n                    .no-data {\n                        text-align: center;\n                        padding: 60px 20px;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .no-data-icon {\n                        font-size: 4rem;\n                        margin-bottom: 20px;\n                        opacity: 0.6;\n                    }\n                    \n                    .no-data-text {\n                        font-size: 1.3rem;\n                        font-weight: 300;\n                        opacity: 0.8;\n                    }\n                    \n                    @media (max-width: 768px) {\n                        .budget-dashboard { padding: 20px; }\n                        .budget-title { font-size: 2rem; }\n                        .item-header { flex-direction: column; align-items: flex-start; }\n                        .item-details { grid-template-columns: 1fr; }\n                        .progress-info { flex-direction: column; align-items: flex-start; }\n                    }\n                </style>\n            `);\n        }\n\n        // Load dashboard data on refresh\n        load_dashboard_data(frm);\n    }\n});\n\nfunction load_dashboard_data(frm) {\n    // Show loading state\n    let container = frm.fields_dict.budget_html.$wrapper;\n    container.html(`\n        <div class=\"budget-dashboard\">\n            <div class=\"no-data\">\n                <div class=\"no-data-icon\">⏳</div>\n                <div class=\"no-data-text\">Loading budget data...</div>\n            </div>\n        </div>\n    `);\n\n    // Call the server method\n    frappe.call({\n        method: \"alphax_budget.alphax_budget.doctype.budget_control.budget_control.get_monthly_distribution_department\",\n        args: {\n            cost_center: frm.doc.cost_center || \"Carriers - AEC\"\n        },\n        callback: function(r) {\n            if (r.message && r.message.length > 0) {\n                console.log('Budget Data:', r.message);\n                render_modern_budget_dashboard(frm, r.message);\n            } else {\n                render_no_data_state(frm);\n            }\n        },\n        error: function(r) {\n            render_error_state(frm, r);\n        }\n    });\n}\n\nfunction show_report_dialog(frm) {\n    // Get unique months from current data for the dropdown\n    const months = [\n        'January', 'February', 'March', 'April', 'May', 'June',\n        'July', 'August', 'September', 'October', 'November', 'December'\n    ];\n\n    let dialog = new frappe.ui.Dialog({\n        title: '📊 Generate Budget Report',\n        size: 'large',\n        fields: [\n            {\n                label: 'Cost Center',\n                fieldname: 'cost_center',\n                fieldtype: 'Data',\n                default: frm.doc.cost_center || 'Carriers - AEC',\n                reqd: 1,\n                description: 'Enter the cost center to generate report for'\n            },\n            {\n                label: 'Month Filter',\n                fieldname: 'month',\n                fieldtype: 'Select',\n                options: ['All Months'].concat(months),\n                default: 'All Months',\n                description: 'Select specific month or all months'\n            },\n            {\n                label: 'Report Type',\n                fieldname: 'report_type',\n                fieldtype: 'Select',\n                options: 'Summary\\nDetailed\\nExport to Excel',\n                default: 'Summary',\n                description: 'Choose the type of report to generate'\n            }\n        ],\n        primary_action_label: '🚀 Generate Report',\n        primary_action(values) {\n            generate_budget_report(frm, values);\n            dialog.hide();\n        },\n        secondary_action_label: '❌ Cancel'\n    });\n\n    dialog.show();\n}\n\nfunction generate_budget_report(frm, filters) {\n    // Show loading state\n    frappe.show_alert({\n        message: __('🔄 Generating report...'),\n        indicator: 'blue'\n    }, 3);\n\n    const args = {\n        cost_center: filters.cost_center\n    };\n\n    // Add month filter if not \"All Months\"\n    if (filters.month && filters.month !== 'All Months') {\n        args.month = filters.month;\n    }\n\n    frappe.call({\n        method: \"alphax_budget.alphax_budget.doctype.budget_control.budget_control.get_monthly_distribution_report\",\n        args: args,\n        callback: function(r) {\n            if (r.message) {\n                console.log('Report Data:', r.message);\n                \n                if (filters.report_type === 'Export to Excel') {\n                    export_to_excel(r.message, filters);\n                } else {\n                    show_report_modal(r.message, filters);\n                }\n            } else {\n                frappe.msgprint({\n                    title: __('No Data'),\n                    message: __('No data found for the selected criteria.'),\n                    indicator: 'yellow'\n                });\n            }\n        },\n        error: function(r) {\n            frappe.msgprint({\n                title: __('Error'),\n                message: r.message || __('Failed to generate report. Please try again.'),\n                indicator: 'red'\n            });\n        }\n    });\n}\n\nfunction show_report_modal(report_data, filters) {\n    const { data, totals } = report_data;\n    \n    let report_html = generate_report_html(data, totals, filters);\n    \n    let report_dialog = new frappe.ui.Dialog({\n        title: `📊 Budget Report - ${filters.cost_center}`,\n        size: 'extra-large',\n        fields: [\n            {\n                fieldname: 'report_html',\n                fieldtype: 'HTML',\n                options: report_html\n            }\n        ],\n        primary_action_label: '📥 Download PDF',\n        primary_action() {\n            download_report_pdf(report_html, filters);\n        },\n        secondary_action_label: '📊 Export Excel',\n        secondary_action() {\n            export_to_excel(report_data, filters);\n        }\n    });\n\n    report_dialog.show();\n}\n\nfunction generate_report_html(data, totals, filters) {\n    const reportDate = frappe.datetime.now_datetime();\n    \n    let html = `\n        <div class=\"report-container\" style=\"\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\n            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n            border-radius: 15px;\n            padding: 30px;\n            margin: 20px 0;\n            box-shadow: 0 10px 30px rgba(0,0,0,0.1);\n        \">\n            <div class=\"report-header\" style=\"text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;\">\n                <h1 style=\"color: #1e293b; margin: 0; font-size: 2.5rem; font-weight: 800;\">\n                    📊 Monthly Budget Distribution Report\n                </h1>\n                <p style=\"color: #64748b; margin: 10px 0; font-size: 1.1rem;\">\n                    <strong>Cost Center:</strong> ${filters.cost_center} | \n                    <strong>Period:</strong> ${filters.month || 'All Months'} | \n                    <strong>Generated:</strong> ${frappe.datetime.str_to_user(reportDate)}\n                </p>\n            </div>\n\n            <div class=\"summary-stats\" style=\"\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n                gap: 20px;\n                margin-bottom: 40px;\n            \">\n                <div class=\"summary-card\" style=\"\n                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                    color: white;\n                    padding: 25px;\n                    border-radius: 15px;\n                    text-align: center;\n                    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n                \">\n                    <h3 style=\"margin: 0; font-size: 2rem;\">💰</h3>\n                    <h2 style=\"margin: 10px 0; font-size: 1.5rem;\">${formatCurrency(totals.total_requested)}</h2>\n                    <p style=\"margin: 0; opacity: 0.9;\">Total Budget</p>\n                </div>\n                <div class=\"summary-card\" style=\"\n                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);\n                    color: white;\n                    padding: 25px;\n                    border-radius: 15px;\n                    text-align: center;\n                    box-shadow: 0 10px 25px rgba(240, 147, 251, 0.3);\n                \">\n                    <h3 style=\"margin: 0; font-size: 2rem;\">💸</h3>\n                    <h2 style=\"margin: 10px 0; font-size: 1.5rem;\">${formatCurrency(totals.total_consumed)}</h2>\n                    <p style=\"margin: 0; opacity: 0.9;\">Total Spent</p>\n                </div>\n                <div class=\"summary-card\" style=\"\n                    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);\n                    color: white;\n                    padding: 25px;\n                    border-radius: 15px;\n                    text-align: center;\n                    box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);\n                \">\n                    <h3 style=\"margin: 0; font-size: 2rem;\">💎</h3>\n                    <h2 style=\"margin: 10px 0; font-size: 1.5rem;\">${formatCurrency(totals.total_remaining)}</h2>\n                    <p style=\"margin: 0; opacity: 0.9;\">Remaining</p>\n                </div>\n                <div class=\"summary-card\" style=\"\n                    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);\n                    color: white;\n                    padding: 25px;\n                    border-radius: 15px;\n                    text-align: center;\n                    box-shadow: 0 10px 25px rgba(250, 112, 154, 0.3);\n                \">\n                    <h3 style=\"margin: 0; font-size: 2rem;\">📊</h3>\n                    <h2 style=\"margin: 10px 0; font-size: 1.5rem;\">${((totals.total_consumed / totals.total_requested) * 100).toFixed(1)}%</h2>\n                    <p style=\"margin: 0; opacity: 0.9;\">Usage Rate</p>\n                </div>\n            </div>\n\n            <div class=\"detailed-table\" style=\"background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1);\">\n                <table style=\"width: 100%; border-collapse: collapse;\">\n                    <thead>\n                        <tr style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;\">\n                            <th style=\"padding: 20px; text-align: left; font-weight: 600;\">📅 Month</th>\n                            <th style=\"padding: 20px; text-align: left; font-weight: 600;\">🏷️ Item Code</th>\n                            <th style=\"padding: 20px; text-align: left; font-weight: 600;\">💰 Budget</th>\n                            <th style=\"padding: 20px; text-align: left; font-weight: 600;\">💸 Spent</th>\n                            <th style=\"padding: 20px; text-align: left; font-weight: 600;\">💎 Remaining</th>\n                            <th style=\"padding: 20px; text-align: left; font-weight: 600;\">📊 Usage</th>\n                            <th style=\"padding: 20px; text-align: left; font-weight: 600;\">🚦 Status</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n    `;\n\n    data.forEach((row, index) => {\n        const percent = row.requested > 0 ? ((row.consumed / row.requested) * 100) : 0;\n        const { status, icon } = getBudgetStatus(percent);\n        const rowColor = index % 2 === 0 ? '#f8fafc' : 'white';\n\n        html += `\n            <tr style=\"background: ${rowColor}; transition: all 0.2s;\">\n                <td style=\"padding: 15px; border-bottom: 1px solid #e2e8f0;\">${row.month}</td>\n                <td style=\"padding: 15px; border-bottom: 1px solid #e2e8f0; font-family: monospace;\">${row.item_code || 'N/A'}</td>\n                <td style=\"padding: 15px; border-bottom: 1px solid #e2e8f0; font-weight: 600;\">${formatCurrency(row.requested)}</td>\n                <td style=\"padding: 15px; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: #ef4444;\">${formatCurrency(row.consumed)}</td>\n                <td style=\"padding: 15px; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: #10b981;\">${formatCurrency(row.remaining)}</td>\n                <td style=\"padding: 15px; border-bottom: 1px solid #e2e8f0;\">\n                    <div style=\"display: flex; align-items: center; gap: 10px;\">\n                        <div style=\"\n                            background: #e2e8f0;\n                            border-radius: 10px;\n                            height: 8px;\n                            width: 60px;\n                            overflow: hidden;\n                        \">\n                            <div style=\"\n                                background: ${percent < 70 ? '#10b981' : percent < 90 ? '#f59e0b' : '#ef4444'};\n                                height: 100%;\n                                width: ${Math.min(percent, 100)}%;\n                                transition: width 0.5s;\n                            \"></div>\n                        </div>\n                        <span style=\"font-weight: 600; font-size: 0.9rem;\">${percent.toFixed(1)}%</span>\n                    </div>\n                </td>\n                <td style=\"padding: 15px; border-bottom: 1px solid #e2e8f0;\">\n                    <span style=\"\n                        background: ${percent < 70 ? 'rgba(16, 185, 129, 0.1)' : percent < 90 ? 'rgba(245, 158, 11, 0.1)' : 'rgba(239, 68, 68, 0.1)'};\n                        color: ${percent < 70 ? '#10b981' : percent < 90 ? '#f59e0b' : '#ef4444'};\n                        padding: 5px 12px;\n                        border-radius: 20px;\n                        font-size: 0.8rem;\n                        font-weight: 600;\n                        white-space: nowrap;\n                    \">${icon} ${status}</span>\n                </td>\n            </tr>\n        `;\n    });\n\n    html += `\n                    </tbody>\n                </table>\n            </div>\n\n            <div class=\"report-footer\" style=\"margin-top: 30px; text-align: center; color: #64748b; font-size: 0.9rem;\">\n                <p>📋 This report was generated automatically by the Budget Control System</p>\n                <p>🕒 Report generated on ${frappe.datetime.str_to_user(reportDate)}</p>\n            </div>\n        </div>\n    `;\n\n    return html;\n}\n\nfunction export_to_excel(report_data, filters) {\n    const { data, totals } = report_data;\n    \n    // Create CSV content\n    let csv_content = \"Month,Item Code,Account,Budget,Spent,Remaining,Usage %,Status\\n\";\n    \n    data.forEach(row => {\n        const percent = row.requested > 0 ? ((row.consumed / row.requested) * 100) : 0;\n        const { status } = getBudgetStatus(percent);\n        \n        csv_content += `\"${row.month}\",\"${row.item_code || 'N/A'}\",\"${row.account || 'N/A'}\",${row.requested},${row.consumed},${row.remaining},${percent.toFixed(1)}%,\"${status}\"\\n`;\n    });\n    \n    // Add totals row\n    csv_content += `\\nTOTALS,,,${totals.total_requested},${totals.total_consumed},${totals.total_remaining},${((totals.total_consumed / totals.total_requested) * 100).toFixed(1)}%,\\n`;\n    \n    // Create and download file\n    const blob = new Blob([csv_content], { type: 'text/csv' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `Budget_Report_${filters.cost_center.replace(/[^a-z0-9]/gi, '_')}_${filters.month || 'All_Months'}_${frappe.datetime.now_date()}.csv`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    window.URL.revokeObjectURL(url);\n    \n    frappe.show_alert({\n        message: __('📥 Excel file downloaded successfully!'),\n        indicator: 'green'\n    }, 3);\n}\n\nfunction download_report_pdf(html_content, filters) {\n    // Create a new window for printing\n    const printWindow = window.open('', '_blank');\n    printWindow.document.write(`\n        <!DOCTYPE html>\n        <html>\n        <head>\n            <title>Budget Report - ${filters.cost_center}</title>\n            <style>\n                @media print {\n                    body { margin: 0; padding: 20px; }\n                    .report-container { box-shadow: none !important; }\n                }\n            </style>\n        </head>\n        <body>\n            ${html_content}\n        </body>\n        </html>\n    `);\n    printWindow.document.close();\n    \n    // Print the window\n    setTimeout(() => {\n        printWindow.print();\n        printWindow.close();\n    }, 500);\n    \n    frappe.show_alert({\n        message: __('🖨️ Print dialog opened. You can save as PDF from there.'),\n        indicator: 'blue'\n    }, 5);\n}\n//  ****\nfunction render_modern_budget_dashboard(frm, items) {\n    let container = frm.fields_dict.budget_html.$wrapper;\n    container.empty();\n\n    // Calculate totals\n    const totals = {\n        requested: items.reduce((sum, item) => sum + (item.requested || 0), 0),\n        consumed: items.reduce((sum, item) => sum + (item.consumed || 0), 0),\n        remaining: items.reduce((sum, item) => sum + (item.remaining || 0), 0)\n    };\n\n    const overallPercent = totals.requested > 0 ? ((totals.consumed / totals.requested) * 100).toFixed(1) : 0;\n    const itemsCount = items.length;\n    const monthsCount = [...new Set(items.map(item => item.month))].length;\n\n    let html = `\n        <div class=\"budget-dashboard\">\n            <div class=\"budget-header\">\n                <h1 class=\"budget-title\">💰 Budget Control Center</h1>\n                <p class=\"budget-subtitle\">\n                    <strong>${frm.doc.department || \"Department\"}</strong> • \n                    <strong>${frm.doc.cost_center || \"N/A\"}</strong>\n                </p>\n            </div>\n\n            <div class=\"budget-stats\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">📊</div>\n                    <div class=\"stat-value\">${overallPercent}%</div>\n                    <div class=\"stat-label\">Overall Usage</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">💸</div>\n                    <div class=\"stat-value\">${formatCurrency(totals.consumed)}</div>\n                    <div class=\"stat-label\">Total Spent</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">💰</div>\n                    <div class=\"stat-value\">${formatCurrency(totals.remaining)}</div>\n                    <div class=\"stat-label\">Remaining</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">📅</div>\n                    <div class=\"stat-value\">${monthsCount}</div>\n                    <div class=\"stat-label\">Active Months</div>\n                </div>\n            </div>\n\n            <div class=\"budget-items\">\n    `;\n\n    // Group items by month for better organization\n    const groupedItems = items.reduce((groups, item) => {\n        const month = item.month;\n        if (!groups[month]) {\n            groups[month] = [];\n        }\n        groups[month].push(item);\n        return groups;\n    }, {});\n\n    // Render each month's data\n    Object.entries(groupedItems).forEach(([month, monthItems]) => {\n        monthItems.forEach(row => {\n            const percent = row.requested > 0 ? ((row.consumed / row.requested) * 100) : 0;\n            const { status, icon, statusClass, progressClass } = getBudgetStatus(percent);\n\n            html += `\n                <div class=\"budget-item\">\n                    <div class=\"item-header\">\n                        <div class=\"item-month\">\n                            <span>📅 ${row.month}</span>\n                        </div>\n                        <div class=\"status-badge ${statusClass}\">\n                            ${icon} ${status}\n                        </div>\n                    </div>\n\n                    <div class=\"item-details\">\n                        <div class=\"detail-item\">\n                            <div class=\"detail-label\">Item Code</div>\n                            <div class=\"detail-value\">${row.item_code || 'N/A'}</div>\n                        </div>\n                        <div class=\"detail-item\">\n                            <div class=\"detail-label\">Expense Account</div>\n                            <div class=\"detail-value\">${row.account || 'N/A'}</div>\n                        </div>\n                        <div class=\"detail-item\">\n                            <div class=\"detail-label\">Monthly Budget</div>\n                            <div class=\"detail-value\">${formatCurrency(row.requested)}</div>\n                        </div>\n                        <div class=\"detail-item\">\n                            <div class=\"detail-label\">Amount Spent</div>\n                            <div class=\"detail-value\">${formatCurrency(row.consumed)}</div>\n                        </div>\n                    </div>\n\n                    <div class=\"progress-section\">\n                        <div class=\"progress-info\">\n                            <span class=\"progress-label\">Budget Utilization</span>\n                            <span class=\"progress-percentage\">${percent.toFixed(1)}%</span>\n                        </div>\n                        <div class=\"modern-progress\">\n                            <div class=\"progress-fill ${progressClass}\" style=\"width: ${Math.min(percent, 100)}%\"></div>\n                        </div>\n                        <div style=\"margin-top: 10px; text-align: center; opacity: 0.9;\">\n                            <strong>Remaining: ${formatCurrency(row.remaining)}</strong>\n                        </div>\n                    </div>\n                </div>\n            `;\n        });\n    });\n\n    html += `\n            </div>\n        </div>\n    `;\n\n    container.html(html);\n\n    // Add entrance animation\n    setTimeout(() => {\n        $('.budget-item').each(function(index) {\n            $(this).css({\n                'opacity': '0',\n                'transform': 'translateY(30px)'\n            });\n            \n            setTimeout(() => {\n                $(this).css({\n                    'opacity': '1',\n                    'transform': 'translateY(0)',\n                    'transition': 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)'\n                });\n            }, index * 100);\n        });\n    }, 100);\n}\n// *****\nfunction render_no_data_state(frm) {\n    let container = frm.fields_dict.budget_html.$wrapper;\n    container.empty();\n    \n    container.html(`\n        <div class=\"budget-dashboard\">\n            <div class=\"no-data\">\n                <div class=\"no-data-icon\">📊</div>\n                <div class=\"no-data-text\">No budget data found for this cost center</div>\n                <p style=\"opacity: 0.7; margin-top: 20px;\">\n                    Please check if the cost center has monthly distributions configured.\n                </p>\n            </div>\n        </div>\n    `);\n}\n// *****\nfunction render_error_state(frm, error) {\n    let container = frm.fields_dict.budget_html.$wrapper;\n    container.empty();\n    \n    container.html(`\n        <div class=\"budget-dashboard\">\n            <div class=\"no-data\">\n                <div class=\"no-data-icon\">❌</div>\n                <div class=\"no-data-text\">Error loading budget data</div>\n                <p style=\"opacity: 0.7; margin-top: 20px;\">\n                    ${error.message || 'Please try refreshing the form or contact your administrator.'}\n                </p>\n            </div>\n        </div>\n    `);\n}\n// ****\nfunction getBudgetStatus(percent) {\n    if (percent < 70) {\n        return {\n            status: 'On Track',\n            icon: '🟢',\n            statusClass: 'status-good',\n            progressClass: 'progress-good'\n        };\n    } else if (percent < 90) {\n        return {\n            status: 'Caution',\n            icon: '🟡',\n            statusClass: 'status-warning',\n            progressClass: 'progress-warning'\n        };\n    } else {\n        return {\n            status: 'Over Budget',\n            icon: '🔴',\n            statusClass: 'status-danger',\n            progressClass: 'progress-danger'\n        };\n    }\n}\n\nfunction formatCurrency(amount) {\n    return new Intl.NumberFormat('en-US', {\n        style: 'currency',\n        currency: 'EGP',\n        minimumFractionDigits: 0,\n        maximumFractionDigits: 0\n    }).format(amount || 0);\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Control",
  "enabled": 0,
  "modified": "2025-08-22 14:18:54.276126",
  "module": "AlphaX Budget",
  "name": "full Control on Budget",
  "script": "frappe.ui.form.on('Budget Control', {\n    refresh(frm) {\n        // Add custom CSS for the dashboard\n        if (!$('#budget-dashboard-styles').length) {\n            $('head').append(`\n                <style id=\"budget-dashboard-styles\">\n                    .budget-dashboard {\n                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\n                        // background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                        //   background: linear-gradient(135deg, #0066cc 0%, ##0066cc 100%);\n                        background :#0066cc;\n                        border-radius: 20px;\n                        padding: 30px;\n                        margin: 20px 0;\n                        color: white;\n                        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);\n                        position: relative;\n                        overflow: hidden;\n                    }\n                    \n                    .budget-dashboard::before {\n                        content: '';\n                        position: absolute;\n                        top: -50%;\n                        right: -50%;\n                        width: 200%;\n                        height: 200%;\n                        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);\n                        pointer-events: none;\n                        animation: float 6s ease-in-out infinite;\n                    }\n                    \n                    @keyframes float {\n                        0%, 100% { transform: translateY(0px) rotate(0deg); }\n                        50% { transform: translateY(-20px) rotate(5deg); }\n                    }\n                    \n                    .budget-header {\n                        text-align: center;\n                        margin-bottom: 30px;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .budget-title {\n                        font-size: 2.5rem;\n                        font-weight: 800;\n                        margin: 0;\n                        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n                        background: linear-gradient(45deg, #fff, #f0f8ff);\n                        -webkit-background-clip: text;\n                        -webkit-text-fill-color: transparent;\n                        background-clip: text;\n                    }\n                    \n                    .budget-subtitle {\n                        font-size: 1.1rem;\n                        opacity: 0.9;\n                        margin: 10px 0;\n                        font-weight: 300;\n                    }\n                    \n                    .filter-section {\n                        background: rgba(255, 255, 255, 0.1);\n                        backdrop-filter: blur(10px);\n                        border-radius: 15px;\n                        padding: 20px;\n                        margin-bottom: 20px;\n                        position: relative;\n                        z-index: 2;\n                        border: 1px solid rgba(255, 255, 255, 0.2);\n                    }\n                    \n                    .filter-section .form-control {\n                        background: rgba(255, 255, 255, 0.2);\n                        border: 1px solid rgba(255, 255, 255, 0.3);\n                        color: white;\n                        border-radius: 8px;\n                    }\n                    \n                    .filter-section .form-control::placeholder {\n                        color: rgba(255, 255, 255, 0.7);\n                    }\n                    \n                    .filter-section .form-control:focus {\n                        background: rgba(255, 255, 255, 0.3);\n                        border-color: rgba(255, 255, 255, 0.5);\n                        box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);\n                    }\n                    \n                    .budget-stats {\n                        display: grid;\n                        // grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n                        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));\n                        gap: 20px;\n                        margin: 30px 0;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .stat-card {\n                        background: rgba(255, 255, 255, 0.15);\n                        backdrop-filter: blur(10px);\n                        border-radius: 15px;\n                        padding: 20px;\n                        text-align: center;\n                        border: 1px solid rgba(255, 255, 255, 0.2);\n                        transition: all 0.3s ease;\n                    }\n                    \n                    .stat-card:hover {\n                        transform: translateY(-5px);\n                        background: rgba(255, 255, 255, 0.2);\n                        box-shadow: 0 15px 30px rgba(0,0,0,0.2);\n                    }\n                    \n                    .stat-icon {\n                        font-size: 2.5rem;\n                        margin-bottom: 10px;\n                        filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));\n                    }\n                    \n                    .stat-value {\n                        // font-size: 1.8rem;\n                        font-size: 1.2rem;\n                        // font-weight: 700;\n                        font-weight: 500;\n                        margin: 5px 0;\n                    }\n                    \n                    .stat-label {\n                        font-size: 0.9rem;\n                        opacity: 0.8;\n                        text-transform: uppercase;\n                        letter-spacing: 1px;\n                    }\n                    \n                    .budget-items {\n                        display: grid;\n                        gap: 20px;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .budget-item {\n                        background: rgba(255, 255, 255, 0.1);\n                        backdrop-filter: blur(15px);\n                        border-radius: 20px;\n                        padding: 25px;\n                        border: 1px solid rgba(255, 255, 255, 0.2);\n                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n                        position: relative;\n                        overflow: hidden;\n                    }\n                    \n                    .budget-item::before {\n                        content: '';\n                        position: absolute;\n                        top: 0;\n                        left: -100%;\n                        width: 100%;\n                        height: 100%;\n                        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);\n                        transition: left 0.5s;\n                    }\n                    \n                    .budget-item:hover::before {\n                        left: 100%;\n                    }\n                    \n                    .budget-item:hover {\n                        transform: scale(1.02);\n                        background: rgba(255, 255, 255, 0.15);\n                        box-shadow: 0 20px 40px rgba(0,0,0,0.2);\n                    }\n                    \n                    .item-header {\n                        display: flex;\n                        justify-content: space-between;\n                        align-items: center;\n                        margin-bottom: 20px;\n                        flex-wrap: wrap;\n                        gap: 10px;\n                    }\n                    \n                    .item-month {\n                        font-size: 1.5rem;\n                        font-weight: 700;\n                        display: flex;\n                        align-items: center;\n                        gap: 10px;\n                    }\n                    \n                    .status-badge {\n                        padding: 8px 16px;\n                        border-radius: 25px;\n                        font-size: 0.8rem;\n                        font-weight: 600;\n                        text-transform: uppercase;\n                        letter-spacing: 1px;\n                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);\n                    }\n                    \n                    .status-good { background: rgba(34, 197, 94, 0.9); }\n                    .status-warning { background: rgba(251, 191, 36, 0.9); }\n                    .status-danger { background: rgba(239, 68, 68, 0.9); }\n                    \n                    .item-details {\n                        display: grid;\n                        // grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n                          grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));\n                        gap: 15px;\n                        margin-bottom: 20px;\n                    }\n                    \n                    .detail-item {\n                        background: rgba(0, 0, 0, 0.1);\n                        padding: 15px;\n                        border-radius: 12px;\n                        border-left: 4px solid rgba(255, 255, 255, 0.3);\n                    }\n                    \n                    .detail-label {\n                        font-size: 0.8rem;\n                        opacity: 0.7;\n                        text-transform: uppercase;\n                        letter-spacing: 1px;\n                        margin-bottom: 5px;\n                    }\n                    \n                    .detail-value {\n                        font-size: 1.1rem;\n                        font-weight: 600;\n                        word-break: break-all;\n                    }\n                    \n                    .progress-section {\n                        margin-top: 20px;\n                    }\n                    \n                    .progress-info {\n                        display: flex;\n                        justify-content: space-between;\n                        align-items: center;\n                        margin-bottom: 10px;\n                        flex-wrap: wrap;\n                        gap: 10px;\n                    }\n                    \n                    .progress-label {\n                        font-weight: 600;\n                        font-size: 0.9rem;\n                    }\n                    \n                    .progress-percentage {\n                        font-size: 1.2rem;\n                        font-weight: 700;\n                    }\n                    \n                    .modern-progress {\n                        width: 100%;\n                        height: 12px;\n                        background: rgba(255, 255, 255, 0.2);\n                        border-radius: 10px;\n                        overflow: hidden;\n                        position: relative;\n                        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);\n                    }\n                    \n                    .progress-fill {\n                        height: 100%;\n                        border-radius: 10px;\n                        transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);\n                        position: relative;\n                        overflow: hidden;\n                    }\n                    \n                    .progress-fill::after {\n                        content: '';\n                        position: absolute;\n                        top: 0;\n                        left: 0;\n                        right: 0;\n                        bottom: 0;\n                        background: linear-gradient(45deg, \n                            rgba(255,255,255,0.2) 25%, \n                            transparent 25%, \n                            transparent 50%, \n                            rgba(255,255,255,0.2) 50%, \n                            rgba(255,255,255,0.2) 75%, \n                            transparent 75%);\n                        background-size: 20px 20px;\n                        animation: progress-animation 1s linear infinite;\n                    }\n                    \n                    @keyframes progress-animation {\n                        0% { background-position: 0 0; }\n                        100% { background-position: 20px 0; }\n                    }\n                    \n                    .progress-good { \n                        background: linear-gradient(135deg, #10b981, #059669);\n                        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);\n                    }\n                    .progress-warning { \n                        background: linear-gradient(135deg, #f59e0b, #d97706);\n                        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);\n                    }\n                    .progress-danger { \n                        background: linear-gradient(135deg, #ef4444, #dc2626);\n                        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);\n                    }\n                    \n                    .budget-table {\n                        background: rgba(255, 255, 255, 0.1);\n                        backdrop-filter: blur(10px);\n                        border-radius: 15px;\n                        padding: 20px;\n                        margin-top: 20px;\n                        position: relative;\n                        z-index: 2;\n                        border: 1px solid rgba(255, 255, 255, 0.2);\n                    }\n                    \n                    .budget-table table {\n                        background: transparent;\n                        color: white;\n                    }\n                    \n                    .budget-table th {\n                        background: rgba(255, 255, 255, 0.2);\n                        border-color: rgba(255, 255, 255, 0.3);\n                        color: white;\n                        font-weight: 600;\n                    }\n                    \n                    .budget-table td {\n                        border-color: rgba(255, 255, 255, 0.2);\n                        background: rgba(255, 255, 255, 0.05);\n                    }\n                    \n                    .budget-table .form-control {\n                        background: rgba(255, 255, 255, 0.2);\n                        border: 1px solid rgba(255, 255, 255, 0.3);\n                        color: white;\n                        border-radius: 6px;\n                    }\n                    \n                    .budget-table .form-control:focus {\n                        background: rgba(255, 255, 255, 0.3);\n                        border-color: rgba(255, 255, 255, 0.5);\n                        color: white;\n                    }\n                    \n                    .amount-controls {\n                        background: rgba(255, 255, 255, 0.1);\n                        backdrop-filter: blur(10px);\n                        border-radius: 10px;\n                        padding: 15px;\n                        margin-bottom: 15px;\n                        border: 1px solid rgba(255, 255, 255, 0.2);\n                    }\n                    \n                    .no-data {\n                        text-align: center;\n                        padding: 60px 20px;\n                        position: relative;\n                        z-index: 2;\n                    }\n                    \n                    .no-data-icon {\n                        font-size: 4rem;\n                        margin-bottom: 20px;\n                        opacity: 0.6;\n                    }\n                    \n                    .no-data-text {\n                        font-size: 1.3rem;\n                        font-weight: 300;\n                        opacity: 0.8;\n                    }\n                    \n                    @media (max-width: 768px) {\n                        .budget-dashboard { padding: 20px; }\n                        .budget-title { font-size: 2rem; }\n                        .item-header { flex-direction: column; align-items: flex-start; }\n                        .item-details { grid-template-columns: 1fr; }\n                        .progress-info { flex-direction: column; align-items: flex-start; }\n                        .filter-section { flex-direction: column; }\n                        .filter-section > * { width: 100% !important; }\n                    }\n                </style>\n            `);\n        }\n\n        // Call the server method\n        frappe.call({\n            method: \"alphax_budget.alphax_budget.doctype.budget_control.budget_control.get_monthly_distribution_department\",\n            args: {\n                cost_center: frm.doc.cost_center || \"Carriers - AEC\"\n            },\n            callback: function(r) {\n                    console.log('Budget Data:', r.message);\n                if (r.message && r.message.length > 0) {\n                    render_modern_budget_dashboard(frm, r.message);\n                } else {\n                    render_no_data_state(frm);\n                }\n            },\n            error: function(r) {\n                console.error('Error loading budget data:', r);\n                render_error_state(frm, r);\n            }\n        });\n    }\n});\n\nfunction render_modern_budget_dashboard(frm, items) {\n    let container = frm.fields_dict.budget_html.$wrapper;\n    container.empty();\n\n    // Calculate summary statistics\n    const totalBudget = items.reduce((sum, item) => sum + (item.requested || 0), 0);\n    const totalSpent = items.reduce((sum, item) => sum + (item.consumed || 0), 0);\n    const totalRemaining = items.reduce((sum, item) => sum + (item.remaining || 0), 0);\n    const utilizationRate = totalBudget > 0 ? (totalSpent / totalBudget * 100) : 0;\n\n    // Get unique values for filters\n    const uniqueItems = [...new Set(items.map(i => i.item_code).filter(Boolean))];\n    const uniqueAccounts = [...new Set(items.map(i => i.account).filter(Boolean))];\n    const uniqueMonths = [...new Set(items.map(i => i.month).filter(Boolean))];\n\n    // Create main dashboard HTML\n    let html = `\n        <div class=\"budget-dashboard\">\n            <div class=\"budget-header\">\n                <h1 class=\"budget-title\">💰 Budget Control Center</h1>\n                <p class=\"budget-subtitle\">\n                    <strong>${frm.doc.department || \"Department\"}</strong> • \n                    <strong>${frm.doc.cost_center || \"N/A\"}</strong>\n                </p>\n            </div>\n\n            <!-- Summary Stats -->\n            <div class=\"budget-stats\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">💰</div>\n                    <div class=\"stat-value\">${formatCurrency(totalBudget)}</div>\n                    <div class=\"stat-label\">Total Budget</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">💸</div>\n                    <div class=\"stat-value\">${formatCurrency(totalSpent)}</div>\n                    <div class=\"stat-label\">Total Spent</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">💵</div>\n                    <div class=\"stat-value\">${formatCurrency(totalRemaining)}</div>\n                    <div class=\"stat-label\">Remaining</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-icon\">📊</div>\n                    <div class=\"stat-value\">${utilizationRate.toFixed(1)}%</div>\n                    <div class=\"stat-label\">Utilization</div>\n                </div>\n            </div>\n\n            <!-- Filter Section -->\n            <div class=\"filter-section\">\n                <div style=\"display:flex; gap:10px; flex-wrap:wrap; align-items:center;\">\n                    <select id=\"filter-item-code\" class=\"form-control input-sm\" style=\"flex:1; min-width:150px;\">\n                        <option value=\"\">All Items / جميع الأصناف</option>\n                        ${uniqueItems.map(code => `<option value=\"${code}\">${code}</option>`).join('')}\n                    </select>\n                \n                    <select id=\"filter-expense-account\" class=\"form-control input-sm\" style=\"flex:1; min-width:150px;\">\n                        <option value=\"\">All Accounts / جميع الحسابات</option>\n                        ${uniqueAccounts.map(account => `<option value=\"${account}\">${account}</option>`).join('')}\n                    </select>\n                \n                    <select id=\"filter-month\" class=\"form-control input-sm\" style=\"flex:1; min-width:120px;\">\n                        <option value=\"\">All Months / جميع الشهور</option>\n                        ${uniqueMonths.map(month => `<option value=\"${month}\">${month}</option>`).join('')}\n                    </select>\n                \n                    <button id=\"apply-filters\" class=\"btn btn-primary btn-sm\">Apply / تطبيق</button>\n                    <button id=\"reset-filters\" class=\"btn btn-secondary btn-sm\">Reset / إعادة تعيين</button>\n                </div>\n            </div>\n\n            <!-- Budget Items Container -->\n            <div class=\"budget-items\" id=\"budget-items-container\"></div>\n        </div>\n    `;\n\n    container.html(html);\n\n    // Store data globally for filtering\n    frm.page_budget_items = items;\n\n    // Initial render\n    render_budget_items(frm, items);\n\n    // Setup filter events\n    setupFilterEvents(frm, items);\n}\n\nfunction setupFilterEvents(frm, items) {\n    $(\"#apply-filters\").off(\"click\").on(\"click\", function() {\n        const itemCode = $(\"#filter-item-code\").val();\n        const account = $(\"#filter-expense-account\").val();\n        const month = $(\"#filter-month\").val();\n\n        let filtered = items.filter(row => {\n            return (!itemCode || row.item_code === itemCode) &&\n                   (!account || row.account === account) &&\n                   (!month || row.month === month);\n        });\n\n        render_budget_items(frm, filtered);\n    });\n\n    $(\"#reset-filters\").off(\"click\").on(\"click\", function() {\n        $(\"#filter-item-code\").val(\"\");\n        $(\"#filter-expense-account\").val(\"\");\n        $(\"#filter-month\").val(\"\");\n        render_budget_items(frm, items);\n    });\n}\n\nfunction render_budget_items(frm, items) {\n    const container = $(\"#budget-items-container\");\n    container.empty();\n\n    if (!items || items.length === 0) {\n        container.html(`\n            <div style=\"text-align:center; padding:40px; color:rgba(255,255,255,0.8);\">\n                <div style=\"font-size:3rem; margin-bottom:20px;\">🔍</div>\n                <h3>No results found</h3>\n                <p>Try adjusting your filter criteria</p>\n            </div>\n        `);\n        return;\n    }\n\n    // Add table view toggle\n    container.html(`\n        <div style=\"margin-bottom:20px; text-align:center;\">\n            <div class=\"btn-group\" role=\"group\">\n                <button type=\"button\" class=\"btn btn-primary btn-sm\" id=\"view-cards\">Cards View</button>\n                <button type=\"button\" class=\"btn btn-secondary btn-sm\" id=\"view-table\">Table View</button>\n            </div>\n        </div>\n        <div id=\"budget-content\"></div>\n    `);\n\n    // Default to cards view\n    render_cards_view(frm, items);\n\n    // View toggle events\n    $(\"#view-cards\").off(\"click\").on(\"click\", function() {\n        $(this).removeClass(\"btn-secondary\").addClass(\"btn-primary\");\n        $(\"#view-table\").removeClass(\"btn-primary\").addClass(\"btn-secondary\");\n        render_cards_view(frm, items);\n    });\n\n    $(\"#view-table\").off(\"click\").on(\"click\", function() {\n        $(this).removeClass(\"btn-secondary\").addClass(\"btn-primary\");\n        $(\"#view-cards\").removeClass(\"btn-primary\").addClass(\"btn-secondary\");\n        render_table_view(frm, items);\n    });\n}\n\nfunction render_cards_view(frm, items) {\n    const contentContainer = $(\"#budget-content\");\n    contentContainer.empty();\n\n    items.forEach(row => {\n        const percent = row.requested > 0 ? ((row.consumed / row.requested) * 100) : 0;\n        const { status, icon, statusClass, progressClass } = getBudgetStatus(percent);\n\n        const html = `\n            <div class=\"budget-item\">\n                <div class=\"item-header\">\n                    <div class=\"item-month\">📅 ${row.month || 'N/A'}</div>\n                    <div class=\"status-badge ${statusClass}\">\n                        ${icon} ${status}\n                    </div>\n                </div>\n\n                <div class=\"item-details\">\n                    <div class=\"detail-item\">\n                        <div class=\"detail-label\">Item Code</div>\n                        <div class=\"detail-value\">${row.item_code || 'N/A'}</div>\n                    </div>\n                    <div class=\"detail-item\">\n                        <div class=\"detail-label\">Expense Account</div>\n                        <div class=\"detail-value\">${row.account || 'N/A'}</div>\n                    </div>\n                    <div class=\"detail-item\">\n                        <div class=\"detail-label\">Monthly Budget</div>\n                        <div class=\"detail-value\">${formatCurrency(row.requested || 0)}</div>\n                    </div>\n                    <div class=\"detail-item\">\n                        <div class=\"detail-label\">Amount Spent</div>\n                        <div class=\"detail-value\">${formatCurrency(row.consumed || 0)}</div>\n                    </div>\n                </div>\n\n                <div class=\"progress-section\">\n                    <div class=\"progress-info\">\n                        <span class=\"progress-label\">Budget Utilization</span>\n                        <span class=\"progress-percentage\">${percent.toFixed(1)}%</span>\n                    </div>\n                    <div class=\"modern-progress\">\n                        <div class=\"progress-fill ${progressClass}\" style=\"width: ${Math.min(percent, 100)}%\"></div>\n                    </div>\n                    <div style=\"margin-top: 10px; text-align: center; opacity: 0.9;\">\n                        <strong>Remaining: ${formatCurrency(row.remaining || 0)}</strong>\n                    </div>\n                </div>\n\n                <div style=\"margin-top:15px; text-align:center;\">\n                    <button class=\"btn btn-success btn-sm increase-btn\" data-item='${JSON.stringify(row)}'>\n                        ➕ Increase Budget\n                    </button>\n                    <button class=\"btn btn-danger btn-sm decrease-btn\" data-item='${JSON.stringify(row)}'>\n                        ➖ Decrease Budget\n                    </button>\n                </div>\n            </div>\n        `;\n\n        contentContainer.append(html);\n    });\n\n    // Setup button events\n    setupBudgetUpdateButtons(frm);\n}\n\nfunction render_table_view(frm, items) {\n    const contentContainer = $(\"#budget-content\");\n    \n    const tableHtml = `\n        <div class=\"budget-table\">\n            <div class=\"amount-controls\">\n                <label style=\"margin-right:10px;\">Amount to Change:</label>\n                <input type=\"number\" id=\"change-amount\" class=\"form-control input-sm\" value=\"100\" min=\"1\" step=\"1\" style=\"width:120px; display:inline-block;\" />\n            </div>\n            \n            <div class=\"table-responsive\">\n                <table class=\"table table-bordered\">\n                    <thead>\n                        <tr>\n                            <th>Item Code</th>\n                            <th>Account</th>\n                            <th>Month</th>\n                            <th>Budget Amount</th>\n                            <th>Spent</th>\n                            <th>Remaining</th>\n                            <th>Utilization %</th>\n                            <th>Actions</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        ${items.map((row, idx) => {\n                            const percent = row.requested > 0 ? ((row.consumed / row.requested) * 100) : 0;\n                            const { status, statusClass } = getBudgetStatus(percent);\n                            \n                            return `\n                                <tr>\n                                    <td>${row.item_code || 'N/A'}</td>\n                                    <td>${row.account || 'N/A'}</td>\n                                    <td>${row.month || 'N/A'}</td>\n                                    <td>\n                                        <input \n                                            type=\"number\" \n                                            class=\"form-control input-sm budget-amount\" \n                                            data-index=\"${idx}\" \n                                            value=\"${row.requested || 0}\" \n                                            min=\"0\" \n                                            step=\"1\"\n                                            style=\"width:120px;\"\n                                        />\n                                    </td>\n                                    <td>${formatCurrency(row.consumed || 0)}</td>\n                                    <td>${formatCurrency(row.remaining || 0)}</td>\n                                    <td>\n                                        <span class=\"status-badge ${statusClass}\" style=\"font-size:0.7rem; padding:4px 8px;\">\n                                            ${percent.toFixed(1)}%\n                                        </span>\n                                    </td>\n                                    <td>\n                                        <div class=\"btn-group btn-group-xs\" role=\"group\">\n                                            <button class=\"btn btn-success btn-xs btn-inc\" data-index=\"${idx}\" title=\"Increase\">➕</button>\n                                            <button class=\"btn btn-danger btn-xs btn-dec\" data-index=\"${idx}\" title=\"Decrease\">➖</button>\n                                        </div>\n                                    </td>\n                                </tr>\n                            `;\n                        }).join('')}\n                    </tbody>\n                </table>\n            </div>\n        </div>\n    `;\n\n    contentContainer.html(tableHtml);\n\n    // Setup table button events\n    setupTableEvents(frm, items);\n}\n\nfunction setupTableEvents(frm, items) {\n    // Increase button handler\n    $(\".btn-inc\").off(\"click\").on(\"click\", function() {\n        const idx = $(this).data(\"index\");\n        const input = $(`.budget-amount[data-index=\"${idx}\"]`);\n        const value = parseFloat(input.val()) || 0;\n        const step = parseFloat($(\"#change-amount\").val()) || 1;\n        input.val(value + step);\n        \n        // Trigger change event to update the item\n        input.trigger('change');\n    });\n\n    // Decrease button handler\n    $(\".btn-dec\").off(\"click\").on(\"click\", function() {\n        const idx = $(this).data(\"index\");\n        const input = $(`.budget-amount[data-index=\"${idx}\"]`);\n        const value = parseFloat(input.val()) || 0;\n        const step = parseFloat($(\"#change-amount\").val()) || 1;\n        input.val(Math.max(0, value - step));\n        \n        // Trigger change event to update the item\n        input.trigger('change');\n    });\n\n    // Direct input change handler\n    $(\".budget-amount\").off(\"change\").on(\"change\", function() {\n        const idx = $(this).data(\"index\");\n        const newAmount = parseFloat($(this).val()) || 0;\n        const row = items[idx];\n        \n        if (row) {\n            // Update the item data\n            row.requested = newAmount;\n            row.remaining = newAmount - (row.consumed || 0);\n            \n            // Call server method to update\n            update_budget_amount_direct(frm, row, newAmount);\n        }\n    });\n}\n\nfunction setupBudgetUpdateButtons(frm) {\n    $(\".increase-btn\").off(\"click\").on(\"click\", function() {\n        const row = JSON.parse($(this).attr(\"data-item\"));\n        update_budget_amount(frm, row, \"increase\");\n    });\n\n    $(\".decrease-btn\").off(\"click\").on(\"click\", function() {\n        const row = JSON.parse($(this).attr(\"data-item\"));\n        update_budget_amount(frm, row, \"decrease\");\n    });\n}\n\nfunction update_budget_amount(frm, row, action) {\n    frappe.prompt([\n        {\n            label: 'Amount to ' + action,\n            fieldname: 'amount',\n            fieldtype: 'Currency',\n            default: 100,\n            reqd: 1\n        }\n    ], function(values) {\n        let newAmount = row.requested || 0;\n        \n        if (action === \"increase\") {\n            newAmount = values.amount;\n        } else {\n            newAmount = Math.max(0, newAmount - values.amount);\n        }\n        \n        update_budget_amount_direct(frm, row, newAmount);\n    }, 'Update Budget Amount / تحديث مبلغ الميزانية');\n}\n\nfunction update_budget_amount_direct(frm, row, newAmount) {\n    frappe.call({\n        method: \"alphax_budget.alphax_budget.doctype.budget_control.budget_control.update_budget_amount\",\n        args: {\n            cost_center: 'Carriers - AEC',\n            item_code: row.item_code,\n            account: row.account,\n            month: row.month,\n            new_amount: newAmount,\n            action: action\n        },\n        callback: function(r) {\n            if (r.message && r.message.success) {\n                frappe.show_alert({\n                    message: __('Budget updated successfully'),\n                    indicator: 'green'\n                });\n                \n                // Refresh the dashboard\n                frm.trigger('refresh');\n            } else {\n                frappe.show_alert({\n                    message: __('Failed to update budget: ') + (r.message.error || 'Unknown error'),\n                    indicator: 'red'\n                });\n            }\n        },\n        error: function(r) {\n            frappe.show_alert({\n                message: __('Error updating budget: ') + (r.message || 'Server error'),\n                indicator: 'red'\n            });\n            console.error('Budget update error:', r);\n        }\n    });\n}\n\nfunction render_no_data_state(frm) {\n    const container = frm.fields_dict.budget_html.$wrapper;\n    container.empty();\n    \n    container.html(`\n        <div class=\"budget-dashboard\">\n            <div class=\"no-data\">\n                <div class=\"no-data-icon\">📊</div>\n                <div class=\"no-data-text\">No budget data found</div>\n                <p style=\"opacity: 0.7; margin-top: 20px;\">\n                    No budget data found for cost center: <strong>${frm.doc.cost_center || 'N/A'}</strong><br>\n                    Please check if the cost center has monthly distributions configured.\n                </p>\n                <button class=\"btn btn-primary btn-sm\" onclick=\"location.reload()\">\n                    Refresh / تحديث\n                </button>\n            </div>\n        </div>\n    `);\n}\n\nfunction render_error_state(frm, error) {\n    const container = frm.fields_dict.budget_html.$wrapper;\n    container.empty();\n    \n    container.html(`\n        <div class=\"budget-dashboard\">\n            <div class=\"no-data\">\n                <div class=\"no-data-icon\">❌</div>\n                <div class=\"no-data-text\">Error loading budget data</div>\n                <p style=\"opacity: 0.7; margin-top: 20px;\">\n                    ${error.message || 'Please try refreshing the form or contact your administrator.'}\n                </p>\n                <div style=\"margin-top: 20px;\">\n                    <button class=\"btn btn-primary btn-sm\" onclick=\"location.reload()\">\n                        Retry / إعادة المحاولة\n                    </button>\n                </div>\n            </div>\n        </div>\n    `);\n}\n\nfunction getBudgetStatus(percent) {\n    if (percent < 70) {\n        return {\n            status: 'On Track',\n            icon: '🟢',\n            statusClass: 'status-good',\n            progressClass: 'progress-good'\n        };\n    } else if (percent < 90) {\n        return {\n            status: 'Caution',\n            icon: '🟡',\n            statusClass: 'status-warning',\n            progressClass: 'progress-warning'\n        };\n    } else {\n        return {\n            status: 'Over Budget',\n            icon: '🔴',\n            statusClass: 'status-danger',\n            progressClass: 'progress-danger'\n        };\n    }\n}\n\nfunction formatCurrency(amount) {\n    if (amount === null || amount === undefined) {\n        return 'EGP 0';\n    }\n    \n    return new Intl.NumberFormat('en-US', {\n        style: 'currency',\n        currency: 'EGP',\n        minimumFractionDigits: 0,\n        maximumFractionDigits: 0\n    }).format(amount);\n}\n\n// Additional utility functions for better user experience\nfrappe.ui.form.on('Budget Control', {\n    cost_center: function(frm) {\n        // Auto-refresh when cost center changes\n        if (frm.doc.cost_center) {\n            frm.trigger('refresh');\n        }\n    },\n    \n    department: function(frm) {\n        // Auto-refresh when department changes\n        if (frm.doc.department) {\n            frm.trigger('refresh');\n        }\n    }\n});\n\n// Add keyboard shortcuts for better UX\n$(document).on('keydown', function(e) {\n    // Ctrl + R to refresh budget dashboard\n    if (e.ctrlKey && e.key === 'r') {\n        const frm = cur_frm;\n        if (frm && frm.doctype === 'Budget Control') {\n            e.preventDefault();\n            frm.trigger('refresh');\n            frappe.show_alert({\n                message: __('Budget dashboard refreshed'),\n                indicator: 'blue'\n            });\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Control",
  "enabled": 0,
  "modified": "2025-08-21 21:06:16.227317",
  "module": "AlphaX Budget",
  "name": "Create Budget Request For Department",
  "script": "frappe.ui.form.on('Budget Control', {\n    // للتحقق من البيانات فقط - قبل الإرسال\n    before_submit: async function(frm) {\n        let year = frm.doc.fiscal_year;\n        let depList = frm.doc.departments_list;\n        \n        console.log(\"🔍 before_submit: Validation started\");\n\n        let departments_exist = []\n        for (let dep of depList){\n            let budgetRequestExists = await checkRoleExists(dep.departments);\n        //     console.log('there is Department',budgetRequestExists);\n            if (budgetRequestExists)\n            departments_exist.push(dep.departments);\n                \n           \n        }\n         if (departments_exist.length > 0) {\n              let errorMessage;\n                if (departments_exist.length === 1) {\n                    errorMessage = `⚠ There is already a Budget Request for the department: ${departments_exist[0]}. <br> You cannot submit this document until the request is deleted or modified.`;\n                } else {\n                    errorMessage = `⚠ There are already Budget Requests for the following departments: ${departments_exist.join(', ')}. You cannot submit this document until the requests are deleted or modified.`;\n                }\n// Prevent form submission\n                frappe.validated = false;\n                \n                // Show error message\n                frappe.msgprint({\n                    title: __('Error Create Budget Request'),\n                    message: __(errorMessage),\n                    indicator: 'red'\n                });\n                \n                return;\n            }\n         \n         \n        if (frm.doc.budget_controller === 'Financial') {\n            // التحقق من البيانات المطلوبة\n            if (!year) {\n                frappe.msgprint({\n                    title: __('خطأ في البيانات'),\n                    message: __('السنة المالية مطلوبة'),\n                    indicator: 'red'\n                });\n                frappe.validated = false;\n                return false;\n            }\n            \n            if (!depList || depList.length === 0) {\n                frappe.msgprint({\n                    title: __('خطأ في البيانات'),\n                    message: __('يجب إضافة قسم واحد على الأقل في قائمة الأقسام'),\n                    indicator: 'red'\n                });\n                frappe.validated = false;\n                return false;\n            }\n            \n            console.log(\"✅ before_submit: Validation passed\");\n        } else {\n            console.log(\"ℹ️ before_submit: Skipped validation - budget_controller is not 'Financial'\");\n        }\n    },\n\n    // لإنشاء المستندات وعرض رسالة النجاح - بعد الإرسال الناجح\n    on_submit: async function(frm) {\n        if (frm.doc.budget_controller === 'Financial') {\n             console.log(\"🔄 on_submit: Started creating Budget Requests\");\n            let year = frm.doc.fiscal_year;\n            let depList = frm.doc.departments_list;\n            \n            try {\n                let created_requests = [];\n                \n                // إنشاء Budget Request لكل قسم\n                for (let row of depList) {\n                    if (!row.departments) {\n                        console.log(`⚠️ Skipping row - no department specified`);\n                        continue;\n                    }\n                    \n                    console.log(`📋 Creating Budget Request for: ${row.departments}`);\n                    \n                    let budget = frappe.model.get_new_doc(\"Budget Request\");\n                    budget.department = row.departments;\n                    budget.fiscal_year = year;\n                    alphax_budget.alphax_budgett_control = frm.doc.name;\n                    alphax_budget.alphax_budgett_controller = frm.doc.budget_controller;\n                    \n                    const inserted_doc = await frappe.db.insert(budget);\n                    console.log(`✅ Created Budget Request: ${inserted_doc.name}`);\n                    \n                    // إضافة إلى قائمة المُنشأة\n                    created_requests.push({\n                        name: inserted_doc.name,\n                        department: row.departments\n                    });\n                    \n                    // تعديل workflow_state\n                    await frappe.model.set_value(\"Budget Request\", inserted_doc.name, \"workflow_state\", \"تحت مراجعة قسم المالية\");\n                    console.log(`🔄 Updated workflow state for: ${inserted_doc.name}`);\n                }\n                \n                // رسالة مفصلة بأسماء المستندات المُنشأة\n                let message_html = `<div style=\"text-align: right;\">\n                    <p><strong>تم إنشاء ${created_requests.length} طلب ميزانية بنجاح:</strong></p>\n                    <ul style=\"list-style: none; padding: 0;\">`;\n                \n                created_requests.forEach(req => {\n                    message_html += `<li style=\"margin: 8px 0; padding: 8px; background-color: #f8f9fa; border-right: 3px solid #28a745; border-radius: 4px;\">\n                        📋 <strong>${req.name}</strong><br>\n                        🏢 القسم: ${req.department}\n                    </li>`;\n                });\n                \n                message_html += `</ul></div>`;\n                \n                frappe.msgprint({\n                    title: __('تم إنشاء طلبات الميزانية بنجاح ✅'),\n                    message: message_html,\n                    indicator: 'green',\n                    wide: true\n                });\n                \n                // تنبيه إضافي\n                frappe.show_alert({\n                    message: __(`تم إنشاء ${created_requests.length} طلب ميزانية بنجاح`),\n                    indicator: 'green'\n                }, 5);\n                \n                console.log(\"✅ on_submit: Budget Requests created successfully\");\n                \n            } catch (err) {\n                console.error(\"❌ Error in on_submit:\", err);\n                frappe.msgprint({\n                    title: __('خطأ في النظام'),\n                    message: __('فشل في إنشاء بعض طلبات الميزانية. يرجى مراجعة وحدة التحكم للتفاصيل'),\n                    indicator: 'red'\n                });\n            }\n        } else {\n            console.log(\"ℹ️ on_submit: No Budget Requests created - budget_controller is not 'Financial'\");\n        }\n        \n        \n    },\n\n    // validation إضافية عند الحفظ\n    validate: function(frm) {\n        console.log(\"🔍 validate triggered\");\n        \n        if (frm.doc.budget_controller === 'Financial') {\n            if (!frm.doc.fiscal_year) {\n                frappe.msgprint({\n                    title: __('بيانات مطلوبة'),\n                    message: __('السنة المالية مطلوبة عندما يكون المتحكم في الميزانية مالي'),\n                    indicator: 'orange'\n                });\n                frappe.validated = false;\n                return;\n            }\n            \n            if (!frm.doc.departments_list || frm.doc.departments_list.length === 0) {\n                frappe.msgprint({\n                    title: __('بيانات مطلوبة'),\n                    message: __('قائمة الأقسام لا يمكن أن تكون فارغة عندما يكون المتحكم في الميزانية مالي'),\n                    indicator: 'orange'\n                });\n                frappe.validated = false;\n                return;\n            }\n        }\n    },\n\n    // عند تغيير budget_controller\n    budget_controller: function(frm) {\n        if (frm.doc.budget_controller === 'Financial') {\n            frm.set_df_property('fiscal_year', 'reqd', 1);\n            frm.set_df_property('departments_list', 'reqd', 1);\n            frappe.msgprint({\n                title: __('تنبيه'),\n                message: __('يرجى التأكد من تعبئة السنة المالية وقائمة الأقسام'),\n                indicator: 'blue'\n            });\n        } else {\n            frm.set_df_property('fiscal_year', 'reqd', 0);\n            frm.set_df_property('departments_list', 'reqd', 0);\n        }\n    }\n});\n\nasync function checkRoleExists(department) {\n    try {\n        const result = await frappe.db.get_value(\n            'Budget Request',\n            { department: department }, // filters\n            'name'\n        );\n        if (result && result.message && result.message.name) {\n            console.log(\"✅ موجود:\", result.message.name);\n            return true;\n        } else {\n            console.log(\"❌ غير موجود\");\n            return false;\n        }\n    } catch (err) {\n        console.error(\"Error checking role existence:\", err);\n        return false;\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-12-18 23:22:32.430677",
  "module": "AlphaX Budget",
  "name": "Validate Purchase Order Monthly Budget Amount",
  "script": "frappe.ui.form.on(\"Purchase Order\", {\n    async validate(frm) {\n        console.log('validate')\n        // Prevent multiple simultaneous validations\n        if (frm._budget_validating) {\n            console.log(\"Budget validation already in progress\");\n            return frm._budget_validation_result || false;\n        }\n        \n        // Basic validation checks\n        if (!await performBasicValidation(frm)) {\n            return false;\n        }\n\n        // Budget validation\n        try {\n            frm._budget_validating = true;\n            const budgetValidation = await validateBudget(frm);\n            console.log(\"✅ validateBudget finished\");\n            frm._budget_validation_result = budgetValidation;\n            console.log(\"✅ validateBudget finished\");\n            console.log(\"budgetValidation Response:\", frm._budget_validation_result);\n            console.log(\"✅ validateBudget finished\");\n            return budgetValidation;\n        } catch (error) {\n            console.log(\" error type :\", error.type);\n            // frappe.validated = false;\n            // frappe.msgprint({\n            //     title: __(\"Budget Validation Error\"),\n            //     message: error.message || __(\"An error occurred during budget validation\"),\n            //     indicator: \"red\",\n            // });\n            return false;\n        } finally {\n            frm._budget_validating = false;\n \n        }\n    },\n\n    async refresh(frm) {\n        // Clear validation flags on refresh\n        frm._budget_validating = false;\n        frm._budget_validation_result = null;\n        \n        // Add custom button to show budget summary\n        if (frm.doc.docstatus === 0 && frm.doc.cost_center) {\n            frm.add_custom_button(__('Show Budget Summary'), function() {\n                showBudgetSummary(frm);\n            }, __(\"Budget\"));\n            \n            // Add debug button\n            frm.add_custom_button(__('Debug Budget Validation'), function() {\n                debugBudgetValidation(frm);\n            }, __(\"Budget\"));\n        }\n    }\n});\n\n/**\n * Perform basic form validation\n */\nasync function performBasicValidation(frm) {\n    const transactionDate = frm.doc.transaction_date;\n    const itemsTable = frm.doc.items;\n    \n    if (!transactionDate) {\n        frappe.msgprint({\n            title: __(\"Transaction Date\"),\n            message: __(\"Transaction Date is required\"),\n            indicator: 'red',\n        });\n        frappe.validated = false;\n        frm.scroll_to_field('transaction_date');\n        return false;\n    }\n    \n    if (!itemsTable || itemsTable.length === 0) {\n        frappe.msgprint({\n            title: __(\"Items Table\"),\n            message: __(\"Items table cannot be empty\"),\n            indicator: 'red',\n        });\n        frappe.validated = false;\n        frm.scroll_to_field('items');\n        return false;\n    }\n\n    // Validate that all items have required fields\n    for (let i = 0; i < itemsTable.length; i++) {\n        const item = itemsTable[i];\n        if (!item.cost_center) {\n            frappe.msgprint({\n                title: __(\"Missing Cost Center\"),\n                message: __(\"Cost Center is required for item in row {0}\", [i + 1]),\n                indicator: 'red',\n            });\n            frappe.validated = false;\n            return false;\n        }\n        if (!item.expense_account) {\n            frappe.msgprint({\n                title: __(\"Missing Expense Account\"),\n                message: __(\"Expense Account is required for item in row {0}\", [i + 1]),\n                indicator: 'red',\n            });\n            frappe.validated = false;\n            return false;\n        }\n    }\n    \n    return true;\n}\n\n/**\n * Main budget validation function\n */\nasync function validateBudget(frm) {\n    try {\n        console.log(\"🔍 Starting budget validation...\");\n        \n        const response = await frappe.call({\n            method: \"alphax_budget.alphax_budget.api.purchase_order.validate_purchase_order_budget\",\n            args: {\n                po_doc: {\n                    name: frm.doc.name,\n                    transaction_date: frm.doc.transaction_date,\n                    cost_center: frm.doc.cost_center\n                },\n                items: frm.doc.items\n            }\n        });\n         console.log(\"✅ Vresponse:\", response);\n        if (!response.message.success && response.message.type !== \"validationMonthlyBudgetError\") {\n            throw new Error(response.message.error || \"System Error during budget validation\");\n        }\n\n\n        const validationResult = response.message.validation_result;\n        console.log(\"✅ Validation Result:\", validationResult);\n        console.log(\"🔍 Stops count:\", validationResult.stops?.length || 0);\n        console.log(\"🔍 Warnings count:\", validationResult.warnings?.length || 0);\n        \n        // Log the actual items to see if there are duplicates\n        if (validationResult.stops) {\n            console.log(\"🔍 Stop items:\", validationResult.stops);\n        }\n        if (validationResult.warnings) {\n            console.log(\"🔍 Warning items:\", validationResult.warnings);\n        }\n\n        // Handle budget stops (will prevent submission)\n        if (validationResult.has_stops) {\n            // Remove duplicates based on cost_center + expense_account combination\n            const uniqueStops = removeDuplicateValidations(validationResult.stops);\n            console.log(\"🔍 Unique stops after deduplication:\", uniqueStops);\n            \n            const stopMessage = formatBudgetMessage(uniqueStops, \"Stop\");\n            frappe.msgprint({\n                title: __(\"Monthly Budget Exceeded - Submission Blocked\"),\n                message: stopMessage,\n                indicator: \"red\"\n            });\n            frappe.validated = false;\n            return validationResult;\n        }\n\n        // Handle budget warnings (will show warning but allow submission)\n        if (validationResult.has_warnings) {\n            // Remove duplicates based on cost_center + expense_account combination\n            const uniqueWarnings = removeDuplicateValidations(validationResult.warnings);\n            console.log(\"🔍 Unique warnings after deduplication:\", uniqueWarnings);\n            \n            const warningMessage = formatBudgetMessage(uniqueWarnings, \"Warning\");\n            // frappe.msgprint({\n            //     title: __(\"Monthly Budget Warning\"),\n            //     message: warningMessage,\n            //     indicator: \"orange\"\n            // });\n            // frappe.validated = true;\n             frappe.confirm(\n                warningMessage,\n                () => {\n                    // ✅ User confirmed → continue save\n                    frappe.validated = true;\n                },\n                () => {\n                    // ❌ User cancelled → stop save\n                    frappe.validated = false;\n                    frm.dirty();\n                },\n                __(\"Monthly Budget Warning\")\n            );\n        }\n\n        console.log(\"✅ Budget validation completed successfully\");\n        return validationResult;\n\n    } catch (error) {\n        console.error(\"❌ Budget validation failed:\", error);\n        frappe.validated = false;\n        throw error;\n    }\n}\n\n/**\n * Format budget validation messages\n */\nfunction formatBudgetMessage(items, messageType) {\n    const icon = messageType === \"Stop\" ? \"⛔️\" : \"⚠️\";\n    \n    return items.map((item, index) => `\n        <div class=\"budget-item-message\" style=\"margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;\">\n            <div style=\"font-weight: bold; margin-bottom: 10px;\">\n                ${icon} Budget ${messageType} - Account ${index + 1}\n                ${item.item_count && item.item_count > 1 ? `(${item.item_count} items)` : ''}\n            </div>\n            <table class=\"table table-bordered table-sm\">\n                <tr>\n                    <td><strong>Item:</strong></td>\n                    <td>${item.item_code}${item.item_count && item.item_count > 1 ? ` (and ${item.item_count - 1} other items)` : ''}</td>\n                </tr>\n                <tr>\n                    <td><strong>Cost Center:</strong></td>\n                    <td>${item.cost_center}</td>\n                </tr>\n                <tr>\n                    <td><strong>Account:</strong></td>\n                    <td>${item.expense_account}</td>\n                </tr>\n                <tr>\n                    <td><strong>Month:</strong></td>\n                    <td>${item.month}</td>\n                </tr>\n                <tr>\n                    <td><strong>Monthly Budget:</strong></td>\n                    <td>${formatCurrency(item.monthly_budget)}</td>\n                </tr>\n                <tr>\n                    <td><strong>Already Spent:</strong></td>\n                    <td>${formatCurrency(item.already_spent)}</td>\n                </tr>\n                <tr>\n                    <td><strong>Current Amount:</strong></td>\n                    <td>${formatCurrency(item.current_amount)}</td>\n                </tr>\n                <tr>\n                    <td><strong>Total After PO:</strong></td>\n                    <td style=\"color: red; font-weight: bold;\">${formatCurrency(item.total_after_po)}</td>\n                </tr>\n                <tr>\n                    <td><strong>Excess Amount:</strong></td>\n                    <td style=\"color: red; font-weight: bold;\">${formatCurrency(item.excess_amount)}</td>\n                </tr>\n                <tr>\n                    <td><strong>Budget Document:</strong></td>\n                    <td>${item.budget_name}</td>\n                </tr>\n            </table>\n        </div>\n    `).join(\"\");\n}\n\n/**\n * Show budget summary dialog\n */\nasync function showBudgetSummary(frm) {\n    if (!frm.doc.transaction_date) {\n        frappe.msgprint(__(\"Please set transaction date first\"));\n        return;\n    }\n\n    try {\n        // Get unique cost centers from items\n        const costCenters = [...new Set(frm.doc.items.map(item => item.cost_center).filter(cc => cc))];\n        \n        if (costCenters.length === 0) {\n            frappe.msgprint(__(\"No cost centers found in items\"));\n            return;\n        }\n\n        const fiscalYear = frm.doc.transaction_date.split('-')[0];\n        \n        // Get budget summary for each cost center\n        const summaries = await Promise.all(\n            costCenters.map(async (costCenter) => {\n                const response = await frappe.call({\n                    method: \"alphax_budget.alphax_budget.api.purchase_order.get_budget_summary\",\n                    args: {\n                        cost_center: costCenter,\n                        fiscal_year: fiscalYear,\n                        transaction_date: frm.doc.transaction_date\n                    }\n                });\n                return response.message;\n            })\n        );\n\n        // Display budget summary in a dialog\n        displayBudgetSummaryDialog(summaries);\n\n    } catch (error) {\n        console.error(\"Error getting budget summary:\", error);\n        frappe.msgprint({\n            title: __(\"Error\"),\n            message: __(\"Failed to get budget summary: {0}\", [error.message]),\n            indicator: \"red\"\n        });\n    }\n}\n\n/**\n * Display budget summary in a dialog\n */\nfunction displayBudgetSummaryDialog(summaries) {\n    let content = \"<div class='budget-summary-container'>\";\n    \n    summaries.forEach(summary => {\n        if (!summary.success) {\n            content += `<div class=\"alert alert-warning\">Error loading budget for cost center</div>`;\n            return;\n        }\n\n        content += `\n            <div class=\"budget-cost-center-section\">\n                <h4>Cost Center: ${summary.cost_center}</h4>\n                <p><strong>Month:</strong> ${summary.month}</p>\n                \n                <table class=\"table table-bordered table-sm\">\n                    <thead>\n                        <tr>\n                            <th>Account</th>\n                            <th>Annual Budget</th>\n                            <th>Monthly Allocation</th>\n                            <th>Spent This Month</th>\n                            <th>Remaining</th>\n                            <th>Status</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n        `;\n        \n        summary.summary.forEach(account => {\n            const remaining = account.remaining;\n            const utilizationPercent = ((account.spent_amount / account.monthly_allocation) * 100).toFixed(1);\n            let statusClass = 'text-success';\n            let statusText = 'Good';\n            \n            if (remaining < 0) {\n                statusClass = 'text-danger';\n                statusText = 'Exceeded';\n            } else if (utilizationPercent > 80) {\n                statusClass = 'text-warning';\n                statusText = 'High Usage';\n            }\n            \n            content += `\n                <tr>\n                    <td>${account.account}</td>\n                    <td>${formatCurrency(account.budget_amount)}</td>\n                    <td>${formatCurrency(account.monthly_allocation)}</td>\n                    <td>${formatCurrency(account.spent_amount)}</td>\n                    <td class=\"${statusClass}\">${formatCurrency(remaining)}</td>\n                    <td class=\"${statusClass}\">${statusText} (${utilizationPercent}%)</td>\n                </tr>\n            `;\n        });\n        \n        content += `\n                    </tbody>\n                </table>\n            </div>\n            <hr>\n        `;\n    });\n    \n    content += \"</div>\";\n\n    const dialog = new frappe.ui.Dialog({\n        title: __(\"Budget Summary\"),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'budget_summary',\n                options: content\n            }\n        ],\n        primary_action_label: __(\"Close\"),\n        primary_action: function() {\n            dialog.hide();\n        }\n    });\n\n    dialog.show();\n}\n\n/**\n * Format currency values\n */\nfunction formatCurrency(amount) {\n    return format_currency(amount, frappe.defaults.get_default(\"currency\"));\n}\n\n/**\n * Item-level validation\n */\nfrappe.ui.form.on(\"Purchase Order Item\", {\n    cost_center: function(frm, cdt, cdn) {\n        // Auto-validate budget when cost center changes\n        const item = locals[cdt][cdn];\n        if (item.cost_center && item.expense_account && item.amount) {\n            validateSingleItem(frm, item);\n        }\n    },\n    \n    expense_account: function(frm, cdt, cdn) {\n        // Auto-validate budget when expense account changes\n        const item = locals[cdt][cdn];\n        if (item.cost_center && item.expense_account && item.amount) {\n            validateSingleItem(frm, item);\n        }\n    },\n    \n    amount: function(frm, cdt, cdn) {\n        // Auto-validate budget when amount changes\n        const item = locals[cdt][cdn];\n        if (item.cost_center && item.expense_account && item.amount) {\n            validateSingleItem(frm, item);\n        }\n    }\n});\n\n/**\n * Validate single item against budget (for real-time feedback)\n */\nasync function validateSingleItem(frm, item) {\n\n    if (!frm.doc.transaction_date) return;\n    \n    try {\n        const response = await frappe.call({\n            method: \"alphax_budget.alphax_budget.api.purchase_order.validate_purchase_order_budget\",\n            args: {\n                po_doc: {\n                    name: frm.doc.name,\n                    transaction_date: frm.doc.transaction_date\n                },\n                items: [item] // Validate just this item\n            }\n        });\n\n        if (response.message.success) {\n            const validationResult = response.message.validation_result;\n            \n            if (validationResult.has_stops || validationResult.has_warnings) {\n                const allItems = [...(validationResult.stops || []), ...(validationResult.warnings || [])];\n                const itemResult = allItems.find(result => \n                    result.item_code === item.item_code && \n                    result.cost_center === item.cost_center\n                );\n                \n                if (itemResult) {\n                    const messageType = validationResult.has_stops ? \"error\" : \"warning\";\n                    frappe.show_alert({\n                        message: `Budget ${messageType}: ${item.item_code} - Remaining: ${formatCurrency(itemResult.monthly_budget - itemResult.already_spent)}`,\n                        indicator: messageType === \"error\" ? \"red\" : \"orange\"\n                    }, 5);\n                }\n            }\n        }\n    } catch (error) {\n        console.log(\"Real-time validation error:\", error);\n        // Don't show error to user for real-time validation\n    }\n}\n\n/**\n * Remove duplicate validation messages based on cost_center + expense_account\n */\nfunction removeDuplicateValidations(validationItems) {\n    if (!validationItems || validationItems.length === 0) {\n        return [];\n    }\n    \n    const seen = new Set();\n    const unique = [];\n    \n    for (const item of validationItems) {\n        const key = `${item.cost_center}||${item.expense_account}`;\n        if (!seen.has(key)) {\n            seen.add(key);\n            unique.push(item);\n        } else {\n            console.log(`🔍 Removing duplicate validation for: ${key}`);\n        }\n    }\n    \n    return unique;\n}\n\n/**\n * Debug budget validation - shows detailed step-by-step info\n */\nasync function debugBudgetValidation(frm) {\n    try {\n        console.log(\"🔍 Starting debug validation...\");\n        \n        const response = await frappe.call({\n            method: \"alphax_budget.alphax_budget.api.purchase_order.debug_budget_validation\",\n            args: {\n                po_doc: {\n                    name: frm.doc.name,\n                    transaction_date: frm.doc.transaction_date,\n                    cost_center: frm.doc.cost_center\n                },\n                items: frm.doc.items\n            }\n        });\n\n        if (!response.message.success) {\n            frappe.msgprint({\n                title: __(\"Debug Error\"),\n                message: response.message.error,\n                indicator: \"red\"\n            });\n            return;\n        }\n\n        const debugInfo = response.message.debug_info;\n        console.log(\"🔍 Debug Info:\", debugInfo);\n\n        // Create detailed debug dialog\n        let debugContent = `\n            <div class=\"debug-container\">\n                <h4>Debug Information</h4>\n                \n                <div class=\"debug-section\">\n                    <h5>Step 1: Existing PO Data</h5>\n                    <pre>${JSON.stringify(debugInfo.step1_existing_po_data, null, 2)}</pre>\n                </div>\n                \n                <div class=\"debug-section\">\n                    <h5>Step 2: Current Items</h5>\n                    <pre>${JSON.stringify(debugInfo.step2_current_items, null, 2)}</pre>\n                </div>\n                \n                <div class=\"debug-section\">\n                    <h5>Step 3: Updated Totals (Existing + Current)</h5>\n                    <pre>${JSON.stringify(debugInfo.step3_updated_totals, null, 2)}</pre>\n                </div>\n                \n                <div class=\"debug-section\">\n                    <h5>Step 4: Budget Details Found</h5>\n                    <pre>${JSON.stringify(debugInfo.step4_budget_details, null, 2)}</pre>\n                </div>\n                \n                <div class=\"debug-section\">\n                    <h5>Step 5: Monthly Allocations</h5>\n                    <pre>${JSON.stringify(debugInfo.step5_monthly_allocations, null, 2)}</pre>\n                </div>\n                \n                <div class=\"debug-section\">\n                    <h5>Step 6: Validation Result</h5>\n                    <pre>${JSON.stringify(debugInfo.step6_validation_result, null, 2)}</pre>\n                </div>\n            </div>\n            \n            <style>\n                .debug-section {\n                    margin: 15px 0;\n                    padding: 10px;\n                    border: 1px solid #ddd;\n                    border-radius: 5px;\n                }\n                .debug-section h5 {\n                    margin-top: 0;\n                    color: #333;\n                }\n                .debug-section pre {\n                    background: #f8f9fa;\n                    padding: 10px;\n                    border-radius: 3px;\n                    font-size: 12px;\n                    max-height: 200px;\n                    overflow-y: auto;\n                }\n            </style>\n        `;\n\n        const debugDialog = new frappe.ui.Dialog({\n            title: __(\"Budget Validation Debug\"),\n            size: 'extra-large',\n            fields: [\n                {\n                    fieldtype: 'HTML',\n                    fieldname: 'debug_content',\n                    options: debugContent\n                }\n            ],\n            primary_action_label: __(\"Close\"),\n            primary_action: function() {\n                debugDialog.hide();\n            }\n        });\n\n        debugDialog.show();\n\n    } catch (error) {\n        console.error(\"Debug validation error:\", error);\n        frappe.msgprint({\n            title: __(\"Debug Error\"),\n            message: error.message,\n            indicator: \"red\"\n        });\n    }\n}",
  "view": "Form"
 }
]